2019-12-17 09:49:18
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 09:49:18
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:49:18
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:49:18
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 09:49:18
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 09:49:21
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode2,@EWFormDataCode3,@EWFormDataCode4,@EWFormDataCode5,@EWFormDataCode6,@EWFormDataCode7,@EWFormDataCode8,@EWFormDataCode9,@EWFormDataCode10,@EWFormDataCode11,@EWFormDataCode12,@EWFormDataCode13,@EWFormDataCode14,@EWFormDataCode15,@EWFormDataCode16)) 	
Parameters:
@MenuCode1[String] = SupplyList
@EWFormDataCode2[Int32] = 4
@EWFormDataCode3[Int32] = 9
@EWFormDataCode4[Int32] = 10
@EWFormDataCode5[Int32] = 11
@EWFormDataCode6[Int32] = 13
@EWFormDataCode7[Int32] = 14
@EWFormDataCode8[Int32] = 15
@EWFormDataCode9[Int32] = 17
@EWFormDataCode10[Int32] = 19
@EWFormDataCode11[Int32] = 5
@EWFormDataCode12[Int32] = 6
@EWFormDataCode13[Int32] = 7
@EWFormDataCode14[Int32] = 8
@EWFormDataCode15[Int32] = 16
@EWFormDataCode16[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 09:49:35
Text:	 SELECT   TOP 1 * FROM [TbUser]  WHERE ([TbUser].[UserCode] = @UserCode17) AND ([TbUser].[UserPwd] = @UserPwd18) 	
Parameters:
@UserCode17[String] = 102787
@UserPwd18[String] = 915946745ba49412bed11dc09ca9ac53


-----------------------------------------------------------------------------
2019-12-17 09:49:36
Text:	SELECT UserClosed FROM TbUser WHERE UserCode=@UserName	
Parameters:
@UserName[String] = 102787


-----------------------------------------------------------------------------
2019-12-17 09:49:36
Text:	select top 1 ur.ProjectId,pro.ProjectName,ur.OrgId,cm.CompanyFullName,cm.ParentCompanyCode,ur.OrgType,ur.UserCode as UserId,u.UserCode,u.UserName from TbUserRole ur 
left join TbCompany cm on ur.OrgId=cm.CompanyCode
left join TbProjectInfo pro on ur.ProjectId=pro.ProjectId
left join TbUser u on ur.UserCode=u.UserId
where u.UserCode=@UserCode and ur.Flag=0 group by ur.ProjectId,pro.ProjectName,ur.OrgId,cm.CompanyFullName,cm.ParentCompanyCode,ur.OrgType,ur.UserCode,u.UserCode,u.UserName order by OrgId asc	
Parameters:
@UserCode[String] = 102787


-----------------------------------------------------------------------------
2019-12-17 09:49:36
Text:	select distinct ur.RoleCode as RoleId,r.RoleCode,r.RoleName from TbUserRole ur
left join TbUser u on ur.UserCode=u.UserId
left join TbRole r on ur.RoleCode=r.RoleId
where u.UserCode=@UserCode and ProjectId=@ProjectId and OrgId=@OrgId and ur.Flag=0	
Parameters:
@UserCode[String] = 102787
@ProjectId[String] = 6245721945602523136
@OrgId[String] = 6247574415609954304


-----------------------------------------------------------------------------
2019-12-17 09:49:36
Text:	 SELECT   TOP 1 [TbCarInfoDetail].[ID] FROM [TbCarInfoDetail]  WHERE [TbCarInfoDetail].[UserCode] = @UserCode19 	
Parameters:
@UserCode19[String] = 102787


-----------------------------------------------------------------------------
2019-12-17 09:49:36
Text:	INSERT INTO [TbSysLog] ([ActionMenu],[ActionType],[HostName],[LogDate],[UserCode],[UserIP]) VALUES (@ActionMenu20,@ActionType21,@HostName22,@LogDate23,@UserCode24,@UserIP25);select scope_identity()	
Parameters:
@ActionMenu20[String] = 0
@ActionType21[String] = 登录系统
@HostName22[String] = 
@LogDate23[DateTime] = 2019/12/17 9:49:36
@UserCode24[String] = 102787
@UserIP25[String] = 192.168.3.222


-----------------------------------------------------------------------------
2019-12-17 09:49:38
Text:	select tsm.* from TbRoleMenu tum
                           left join TbSysMenu tsm on tum.MenuCode=tsm.MenuCode
                           where tsm.IsShow=0 and tsm.MenuType='PC' and tum.RoleCode in('6337324142387400704','6352967650544590848') order by tsm.Sort asc	


-----------------------------------------------------------------------------
2019-12-17 09:49:38
Text:	select 
                        	tsm.*
                        from TbUserMenu tum
                        left join TbSysMenu tsm on tum.MenuCode=tsm.MenuCode
                        where tsm.IsShow=0 and tsm.MenuType='PC' and tum.UserCode=@userCode order by tsm.Sort asc	
Parameters:
@userCode[String] = 6487716734823440384


-----------------------------------------------------------------------------
2019-12-17 09:49:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 09:49:39
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 09:49:39
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:39
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:39
Text:	--库存量
                           select isnull(sum(rsr.Count),0) as TotelNum from TbRawMaterialStockRecord rsr
                           left join TbStorage s on rsr.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) and rsr.ChackState=1
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode) and (rsr.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rsr.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           union all
                           --配送量
                           select isnull(SUM(WeightTotal),0.0000) DistributionTotal 
                           from TbDistributionPlanInfo 
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) 
                           --and datediff(month,InsertTime,getdate())=0
                           and MONTH(InsertTime)=@Month and DistributionStart='配送完成'
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           union all
                           --签收量
                           select isnull(Sum(SumTotal),0.0000) SumTotal 
                           from TbSemiFinishedSign 
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) 
                           --and datediff(month,SigninTime,getdate())=0
                           and MONTH(SigninTime)=@Month
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           union all
                           --加工完成量
                           select isnull(sum(opd.AlreadyCompleted),0) as AlreadyCompleted 
                           from TbOrderProgress op left join TbOrderProgressDetail opd on op.OrderCode=opd.OrderCode  
                           --where MONTH(op.InsertTime)=DATENAME(MONTH,GETDATE()) 
                           and MONTH(op.InsertTime)=@Month
                           and WeightSmallPlan=AlreadyCompleted 
                           and (ISNULL(@ProjectId,'')='' or op.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	--加急订单个数
                           select wo.OrderCode,wo.DistributionTime,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName from TbWorkOrder wo
                           left join TbCompany cp1 on wo.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on wo.ProcessFactoryCode=cp2.CompanyCode
                           where UrgentDegree='Urgent'
                           and YEAR(wo.DistributionTime)= @Year and MONTH(wo.DistributionTime)= @Month  and wo.ProjectId='6245721945602523136' and wo.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')  ORDER BY wo.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	--加工进度滞后
                           select op.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,op.DistributionTime,op.FinishProcessingDateTime from TbOrderProgress op 
                           left join TbCompany cp1 on op.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on op.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(op.DistributionTime)= @Year and MONTH(op.DistributionTime)= @Month
                           and (op.FinishProcessingDateTime>op.DistributionTime or (GETDATE()>op.DistributionTime and op.FinishProcessingDateTime is null))  and op.ProjectId='6245721945602523136' and op.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY op.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	--配送超期
                           select dpi.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,dpi.DistributionTime,dpi.DeliveryCompleteTime,dpi.Remark from TbDistributionPlanInfo dpi
                           left join TbCompany cp1 on dpi.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on dpi.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(dpi.DistributionTime)= @Year and MONTH(dpi.DistributionTime)= @Month
                           and (dpi.DeliveryCompleteTime>dpi.DistributionTime or (GETDATE()>dpi.DistributionTime and dpi.DeliveryCompleteTime is null))  and dpi.ProjectId='6245721945602523136' and dpi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY dpi.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	select TbYj.*,cp1.CompanyFullName as SiteName,tcr.EnterSpaceTime,tcr.StartDischargeTime,tcr.EndDischargeTime,disEnt.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SiteDischargeCargo' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbTransportCarReport tcr on TbYj.EWFormDataCode=tcr.DisEntOrderId
                           left join TbDistributionEnt disEnt on tcr.DistributionCode=disEnt.DistributionCode
                           left join TbCompany cp on disEnt.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY tcr.EnterSpaceTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	select TbYj.*,cp1.CompanyFullName as SiteName,sfs.DistributionCode,sdc.DistributionTime,sfs.SigninTime,sfs.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SemiFinishedSign' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbSemiFinishedSign sfs on TbYj.EWFormDataCode=sfs.ID
                           left join TbSiteDischargeCargo sdc on sfs.DistributionCode=sdc.DistributionCode and sfs.DischargeCargoCode=sdc.DischargeCargoCode
                           left join TbCompany cp on sfs.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:40
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:41
Text:	select tcr.*,cp.CompanyFullName as SiteName,ci.CarCph+tu.UserName AS CarCph,de.Enclosure from TbTransportCarReport  tcr
                           left join TbCompany cp on tcr.SiteCode=cp.CompanyCode
                           left join TbCarInfo ci on tcr.VehicleCode=ci.CarCode
                           left join TbDistributionEnt de on tcr.DistributionCode=de.DistributionCode
                           LEFT JOIN TbUser tu ON tu.UserCode=de.Driver
                           where (ISNULL(@ProjectId,'')='' or tcr.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or de.ProcessFactoryCode=@ProcessFactoryCode)
                           and (tcr.IsProblem='是' or tcr.FlowState=2) 
                           and YEAR(tcr.EndDischargeTime)= @Year and MONTH(tcr.EndDischargeTime)= @Month and tcr.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           order by id desc	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:41
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:41
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:41
Text:	
                        select 
                         left(substring(fewoi.EarlyWarningContent, charindex(N'《',fewoi.EarlyWarningContent)+1, charindex(N'》',
                         fewoi.EarlyWarningContent)-1),charindex('》',substring(fewoi.EarlyWarningContent, charindex(N'《',fewoi.EarlyWarningContent)+1, charindex(N'》',fewoi.EarlyWarningContent)-1))-1) as OddNumbers,
                         fewoi.EarlyWarningContent,
                         fewoi.EWFormDataCode,
                         CONVERT(varchar(100), fewoi.EarlyWarningTime, 120) as EarlyWarningTime,
                         EWFormCode,sm.MenuName,fn.FlowNodeName,cp1.CompanyFullName as BranchName,
                         cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,
                         u1.UserName as FlowSpUserName,u2.UserName as FlowYjUserName 
                        FROM (
                        select*
                           FROM ( 
                        		SELECT a.*, row_number()over(partition BY a.FlowCode ORDER BY a.FlowNodeCode,a.EarlyWarningTime desc) as group_idx 
                        		FROM TbFlowEarlyWarningOtherInfo  a
                        		INNER JOIN  TbFlowEarlyWarningInfo b ON a.FlowCode=b.FlowCode 
                        		AND a.EWFormDataCode=b.EWFormDataCode AND a.FlowNodeCode=b.FlowNodeCode 
                        		WHERE YEAR(a.EarlyWarningTime)= @Year and MONTH(a.EarlyWarningTime)= @Month AND b.EarlyWarningStart=0
                           ) ret
                        WHERE ret.group_idx =1
                        ) fewoi
                        left join TbFlowNode fn on fewoi.FlowCode=fn.FlowCode and fewoi.FlowNodeCode=fn.FlowNodeCode
                        left join TbSysMenu sm on fewoi.EWFormCode=sm.MenuCode
                        left join TbCompany cp1 on fewoi.BranchCode=cp1.CompanyCode
                        left join TbCompany cp2 on fewoi.WorkAreaCode=cp2.CompanyCode
                        left join TbCompany cp3 on fewoi.SiteCode=cp3.CompanyCode
                        left join TbCompany cp4 on fewoi.ProcessFactoryCode=cp4.CompanyCode
                        left join TbUser u1 on fewoi.FlowSpUserCode=u1.UserId
                        left join TbUser u2 on fewoi.FlowYjUserCode=u2.UserId where 1=1 and fewoi.ProjectId='6245721945602523136' and (fewoi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fewoi.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) ORDER BY fewoi.EarlyWarningTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:42
Text:	select 
                            cf.Capacity,
                            Tb1.WeightSmallPlan as ActualOutputValueNew,
                            cast(Tb1.WeightSmallPlan/cf.Capacity*100 as decimal(18,2)) as ActualLoadNew 
                            from TbCapacityFilling cf
                            left JOIN
                            (
                            	select 
                            	SUM(Tb.WeightSmallPlan) as WeightSmallPlan 
                            	from 
                            	(
                            		select 
                            		isnull(SUM(wod.WeightSmallPlan),0) as WeightSmallPlan 
                            		from TbDistributionPlanInfo wo
                            		left join TbDistributionPlanDetailInfo wod on wo.OrderCode=wod.OrderCode
                            		where (ISNULL(@ProcessFactoryCode,'')='' or wo.ProcessFactoryCode=@ProcessFactoryCode) 
                            		and wo.ProcessingState!='ConfirmWork' and wo.ProcessingState!='Finishing'
                            		and MONTH(wo.DistributionTime)=@month
                            		and wod.RevokeStart='正常'
                            		union ALL --扣除加工中订单明细已加工完成的数据
                            		SELECT -1*isnull(SUM(opd.AlreadyCompleted),0)as Completed 
                            		FROM TbDistributionPlanInfo wo
                            		LEFT JOIN TbOrderProgressDetail opd ON wo.OrderCode=opd.OrderCode AND opd.DaetailWorkStrat='加工完成'
                            		WHERE (ISNULL(@ProcessFactoryCode,'')='' or wo.ProcessFactoryCode=@ProcessFactoryCode) 
                            		and wo.ProcessingState='Processing'and MONTH(wo.DistributionTime)=@month
                            		union all
                            		select 
                            		isnull(sum(opd.NoCompleted),0) as NoCompleted 
                            		from TbOrderProgress op
                            		left join TbOrderProgressDetail opd on op.OrderCode=opd.OrderCode 
                            		where (ISNULL(@ProcessFactoryCode,'')='' or op.ProcessFactoryCode=@ProcessFactoryCode)
                            		and MONTH(op.DistributionTime)=@month-1
                            		and opd.RevokeStart='正常'
                            	)Tb
                            ) Tb1 on cf.CapacityMonth=@month
                            where cf.CapacityMonth=@month 
                            and (ISNULL(@ProcessFactoryCode,'')='' or cf.ProcessFactoryCode=@ProcessFactoryCode)	
Parameters:
@ProcessFactoryCode[String] = 
@month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	--原材料供货超时
                           select BatchPlanNum,cp1.CompanyFullName as BranchName,cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,sup.SupplyDate,sup.SupplyCompleteTime,sup.ProjectId,sup.Remarks from TbSupplyList sup
                           left join TbCompany cp1 on cp1.CompanyCode=sup.BranchCode
                           left join TbCompany cp2 on cp2.CompanyCode=sup.WorkAreaCode
                           left join TbCompany cp3 on cp3.CompanyCode=sup.SiteCode
                           left join TbCompany cp4 on cp4.CompanyCode=sup.ProcessFactoryCode
                           where YEAR(sup.SupplyDate)= @Year and MONTH(sup.SupplyDate)= @Month
                           and (sup.SupplyCompleteTime>sup.SupplyDate or (GETDATE()>sup.SupplyDate and sup.SupplyCompleteTime is null))  and sup.ProjectId='6245721945602523136' and (sup.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or sup.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:43
Text:	SELECT 
                            '审批超时' as YjTypeName,COUNT(1) as YjNum
                            FROM (
									SELECT a.*, row_number()over(partition BY a.FlowCode ORDER BY a.FlowNodeCode,a.EarlyWarningTime desc) as group_idx 
									FROM TbFlowEarlyWarningOtherInfo  a
									INNER JOIN  TbFlowEarlyWarningInfo b ON a.FlowCode=b.FlowCode 
									AND a.EWFormDataCode=b.EWFormDataCode AND a.FlowNodeCode=b.FlowNodeCode 
									WHERE  b.EarlyWarningStart=0 AND YEAR(a.EarlyWarningTime)= @Year and MONTH(a.EarlyWarningTime)= @Month  and a.ProjectId='6245721945602523136' and (a.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or a.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
							   ) Tb1
                            WHERE Tb1.group_idx =1
                           union all
                            select '未报月度需求计划' as YjTypeName,COUNT(1)as YjNum
                             FROM ( 
                                  SELECT *, row_number()over(partition BY EarlyWarningCode,EWFormDataCode ORDER BY EWNodeCode,EWTime desc) as group_idx 
                                  FROM TbFormEarlyWarningNodeInfo fwqi
                                  WHERE fwqi.MenuCode='RawMonthDemandPlan' AND fwqi.EWStart=0 AND YEAR(fwqi.EWTime)= @Year and MONTH(fwqi.EWTime)= @Month  and fwqi.ProjectId='6245721945602523136' and (fwqi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fwqi.WorkArea in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))  
                             ) Tb2
                             WHERE Tb2.group_idx =1
                           union all
                           select '原材料供货超时' as YjTypeName,COUNT(1) as YjNum from (
                           select BatchPlanNum,cp1.CompanyFullName as BranchName,cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,sup.SupplyDate,sup.SupplyCompleteTime,sup.ProjectId from TbSupplyList sup
                           left join TbCompany cp1 on cp1.CompanyCode=sup.BranchCode
                           left join TbCompany cp2 on cp2.CompanyCode=sup.WorkAreaCode
                           left join TbCompany cp3 on cp3.CompanyCode=sup.SiteCode
                           left join TbCompany cp4 on cp4.CompanyCode=sup.ProcessFactoryCode
                           where (sup.SupplyCompleteTime>sup.SupplyDate or (GETDATE()>sup.SupplyDate and sup.SupplyCompleteTime is null))
						   and YEAR(sup.SupplyDate)= @Year and MONTH(sup.SupplyDate)= @Month  and sup.ProjectId='6245721945602523136' and (sup.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or sup.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))) Tb3
                           union all
                           select '加急订单' as YjTypeName,COUNT(1) as YjNum from (--加急订单个数
                           select wo.OrderCode,wo.DistributionTime,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName from TbWorkOrder wo
                           left join TbCompany cp1 on wo.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on wo.ProcessFactoryCode=cp2.CompanyCode
                           where UrgentDegree='Urgent' 
						   and YEAR(wo.DistributionTime)= @Year and MONTH(wo.DistributionTime)= @Month  and wo.ProjectId='6245721945602523136' and wo.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb4
                           union all
                           select '加工进度滞后' as YjTypeName,COUNT(1) as YjNum from (--加工进度滞后
                           select op.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,op.DistributionTime,op.FinishProcessingDateTime from TbOrderProgress op 
                           left join TbCompany cp1 on op.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on op.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(op.DistributionTime)= @Year and MONTH(op.DistributionTime)= @Month
                           and (op.FinishProcessingDateTime>op.DistributionTime or (GETDATE()>op.DistributionTime and op.FinishProcessingDateTime is null))  and op.ProjectId='6245721945602523136' and op.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb5
                           union all
                           select '接收配送超期' as YjTypeName,COUNT(1) as YjNum from (--配送超期
                           select dpi.OrderCode,cp1.CompanyFullName as SIteName,cp2.CompanyFullName as ProcessFactoryName,dpi.DistributionTime,dpi.DeliveryCompleteTime from TbDistributionPlanInfo dpi
                           left join TbCompany cp1 on dpi.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on dpi.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(dpi.DistributionTime)= @Year and MONTH(dpi.DistributionTime)= @Month
                           and (dpi.DeliveryCompleteTime>dpi.DistributionTime or (GETDATE()>dpi.DistributionTime and dpi.DeliveryCompleteTime is null))  and dpi.ProjectId='6245721945602523136' and dpi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb6 
                           union all
                           select '卸货超时' as YjTypeName,COUNT(1) as YjNum from(--卸货超时
                           select TbYj.*,cp1.CompanyFullName as SiteName,tcr.EnterSpaceTime,tcr.StartDischargeTime,tcr.EndDischargeTime,disEnt.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SiteDischargeCargo' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbTransportCarReport tcr on TbYj.EWFormDataCode=tcr.DisEntOrderId
                           left join TbDistributionEnt disEnt on tcr.DistributionCode=disEnt.DistributionCode
                           left join TbCompany cp on disEnt.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb7
                           union all
                           select '签收超时' as YjTypeName,COUNT(1) as YjNum from (select TbYj.*,cp1.CompanyFullName as SiteName,sfs.DistributionCode,sdc.DistributionTime,sfs.SigninTime,sfs.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SemiFinishedSign' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbSemiFinishedSign sfs on TbYj.EWFormDataCode=sfs.ID
                           left join TbSiteDischargeCargo sdc on sfs.DistributionCode=sdc.DistributionCode and sfs.DischargeCargoCode=sdc.DischargeCargoCode
                           left join TbCompany cp on sfs.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb8	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:44
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:49:44
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:49:44
Text:	SELECT sm.MenuName,fwqi.EWContent,fwqi.EWUserCode,u.UserName,fwqi.EWFormDataCode,cp1.CompanyFullName as  FbName,cp2.CompanyFullName as GqName,fwqi.EWTime,sdd.DictionaryText as RebarType  
                   FROM (  
                    select ret.*
                    FROM ( 
                         SELECT *, row_number()over(partition BY EarlyWarningCode,EWFormDataCode ORDER BY EWNodeCode,EWTime desc) as group_idx 
                         FROM TbFormEarlyWarningNodeInfo fwqi
                         WHERE YEAR(fwqi.EWTime)= @Year and MONTH(fwqi.EWTime)= @Month AND fwqi.MenuCode='RawMonthDemandPlan' AND fwqi.EWStart=0
                    ) ret
                    WHERE ret.group_idx = 1
                   ) fwqi
                    left join TbSysMenu sm on fwqi.MenuCode=sm.MenuCode
                            left join TbCompany cp1 on fwqi.CompanyCode=cp1.CompanyCode
                            left join TbCompany cp2 on fwqi.WorkArea=cp2.CompanyCode
                            left join TbCompany cp3 on fwqi.SiteCode=cp3.CompanyCode
                            left join TbUser u on fwqi.EWUserCode=u.UserId
                            left join TbRawMaterialMonthDemandPlan rmp on fwqi.EWFormDataCode=rmp.ID
                            left join TbSysDictionaryData sdd on sdd.DictionaryCode=rmp.RebarType
                    where 1=1 and fwqi.ProjectId='6245721945602523136' and (fwqi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fwqi.WorkArea in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) ORDER BY fwqi.EWTime DESC	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	SELECT mm.MenuUrl, pp.UserCode, pp.menuCode, pp.OperationView, pp.OperationAdd
	                        , pp.OperationEdit, pp.OperationDel, pp.OperationExamination, pp.OperationOutput, pp.OperationOther1
	                        , mm.OperationOther1Fun, mm.OperationOther1IconCls, pp.OperationOther2, mm.OperationOther2Fun, mm.OperationOther2IconCls
	                        , pp.OperationOther3, mm.OperationOther3Fun, mm.OperationOther3IconCls, pp.OperationOther4, mm.OperationOther4Fun
	                        , mm.OperationOther4IconCls, pp.OperationOther5, mm.OperationOther5Fun, mm.OperationOther5IconCls
                        FROM (
	                        SELECT UserCode, menuCode, MAX(OperationView) AS OperationView
		                        , MAX(OperationAdd) AS OperationAdd, MAX(OperationEdit) AS OperationEdit
		                        , MAX(OperationDel) AS OperationDel, MAX(OperationExamination) AS OperationExamination
		                        , MAX(OperationOutput) AS OperationOutput, MAX(OperationOther1) AS OperationOther1
		                        , MAX(OperationOther2) AS OperationOther2, MAX(OperationOther3) AS OperationOther3
		                        , MAX(OperationOther4) AS OperationOther4, MAX(OperationOther5) AS OperationOther5
	                        FROM (
		                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
			                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
			                        , OperationOther3, OperationOther4, OperationOther5
		                        FROM (
			                        SELECT a.UserCode, b.menuCode, MAX(b.OperationView) AS OperationView
				                        , MAX(b.OperationAdd) AS OperationAdd, MAX(b.OperationEdit) AS OperationEdit
				                        , MAX(b.OperationDel) AS OperationDel, MAX(b.OperationExamination) AS OperationExamination
				                        , MAX(b.OperationOutput) AS OperationOutput, MAX(b.OperationOther1) AS OperationOther1
				                        , MAX(b.OperationOther2) AS OperationOther2, MAX(b.OperationOther3) AS OperationOther3
				                        , MAX(b.OperationOther4) AS OperationOther4, MAX(b.OperationOther5) AS OperationOther5
			                        FROM dbo.TbUserRole a
				                        INNER JOIN dbo.TbRoleMenu b ON a.RoleCode = b.RoleCode
                                        where b.RoleCode in('6337324142387400704','6352967650544590848')
			                        GROUP BY a.UserCode, b.menuCode
			                        UNION ALL
			                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
				                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
				                        , OperationOther3, OperationOther4, OperationOther5
			                        FROM dbo.TbUserMenu
			                        union all
			                        SELECT p.UserCode, d.menuCode, MAX(d.OperationView) AS OperationView
				                        , MAX(d.OperationAdd) AS OperationAdd, MAX(d.OperationEdit) AS OperationEdit
				                        , MAX(d.OperationDel) AS OperationDel, MAX(d.OperationExamination) AS OperationExamination
				                        , MAX(d.OperationOutput) AS OperationOutput, MAX(d.OperationOther1) AS OperationOther1
				                        , MAX(d.OperationOther2) AS OperationOther2, MAX(d.OperationOther3) AS OperationOther3
				                        , MAX(d.OperationOther4) AS OperationOther4, MAX(d.OperationOther5) AS OperationOther5
			                        FROM dbo.TbPositionUser p
				                        INNER JOIN dbo.TbPositionMenu d ON p.PositionCode = d.PositionCode
			                        GROUP BY p.UserCode, d.menuCode
			
		                        ) c
	                        ) aa
	                        GROUP BY UserCode, menuCode
                        ) pp
                        INNER JOIN dbo.TbSysMenu mm ON pp.menuCode = mm.menuCode 
                        left join dbo.TbUser u on pp.UserCode=u.UserId
                        where u.UserCode=@UserCode And mm.MenuUrl=@menuURI	
Parameters:
@UserCode[String] = 102787
@menuURI[String] = /Production/WorkOrder/Index


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	select * from TbSysDictionaryData where 1=1 and FDictionaryCode=@name order by DictionaryOrder asc	
Parameters:
@name[String] = ProcessingState


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	select * from TbSysDictionaryData where 1=1 and FDictionaryCode=@name order by DictionaryOrder asc	
Parameters:
@name[String] = UrgentDegree


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	select * from TbSysDictionaryData where 1=1 and FDictionaryCode=@name order by DictionaryOrder asc	
Parameters:
@name[String] = DistributionTimeJg


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 09:49:59
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 09:50:00
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:50:00
Text:	--订单总量(订单状态除未接收外的订单)
                        select isnull(Convert(decimal(18,5),SUM(wod.MeasurementUnitZl*wod.ItemUseNum*wod.Number)),0) as SumWeightTotal,'1' as OrderType from TbWorkOrder Tb
                        left join TbWorkOrderDetail wod on Tb.OrderCode=wod.OrderCode
                        where Tb.ProcessingState!='ConfirmWork' and wod.RevokeStart='正常' and ProjectId='6245721945602523136' and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                        union all
                        --已接收总量
                        select  isnull(Convert(decimal(18,5),SUM(wod.MeasurementUnitZl*wod.ItemUseNum*wod.Number)),0) as SumWeightTotal,'2' as OrderType from TbWorkOrder Tb
                        left join TbWorkOrderDetail wod on Tb.OrderCode=wod.OrderCode
                        where Tb.ProcessingState='Received'  and wod.RevokeStart='正常' and ProjectId='6245721945602523136' and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                        union all
                        --已领料总量
                        select  isnull(Convert(decimal(18,5),SUM(wod.MeasurementUnitZl*wod.ItemUseNum*wod.Number)),0) as SumWeightTotal,'3' as OrderType from TbWorkOrder Tb
                        left join TbWorkOrderDetail wod on Tb.OrderCode=wod.OrderCode
                        where Tb.ProcessingState='AlreadyReceived'  and wod.RevokeStart='正常' and ProjectId='6245721945602523136' and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                        union all
                        --加工中总量
                        select  isnull(Convert(decimal(18,5),SUM(wod.MeasurementUnitZl*wod.ItemUseNum*wod.Number)),0) as SumWeightTotal,'4' as OrderType from TbWorkOrder Tb
                        left join TbWorkOrderDetail wod on Tb.OrderCode=wod.OrderCode
                        where Tb.ProcessingState='Processing'  and wod.RevokeStart='正常' and ProjectId='6245721945602523136' and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                        union all
                        select isnull(Convert(decimal(18,5),sum(dpdi.MeasurementUnitZl*dpdi.ItemUseNum*dpdi.PSAmount)),0) as SumWeightTotal,'5' as OrderType  from TbDistributionPlanInfo Tb 
                        left join TbDistributionPlanDetailInfo dpdi on Tb.OrderCode=dpdi.OrderCode
                        where dpdi.PSAmount>0 and dpdi.RevokeStart='正常' and ProjectId='6245721945602523136' and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                        union all
                        select isnull(Convert(decimal(18,5),sum(dpdi.MeasurementUnitZl*dpdi.ItemUseNum*(dpdi.Number-dpdi.PSAmount))),0) as SumWeightTotal,'6' as OrderType  from TbDistributionPlanInfo Tb 
                        left join TbDistributionPlanDetailInfo dpdi on Tb.OrderCode=dpdi.OrderCode
                        where dpdi.PSAmount!=dpdi.Number and dpdi.RevokeStart='正常' and ProjectId='6245721945602523136' and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	


-----------------------------------------------------------------------------
2019-12-17 09:50:01
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:50:01
Text:	 SELECT count(*) as r_cnt FROM [TbWorkOrder] LEFT OUTER JOIN [TbCompany] ON ([TbWorkOrder].[SiteCode] = [TbCompany].[CompanyCode]) LEFT OUTER JOIN [TbSysDictionaryData] ON (([TbWorkOrder].[ProcessingState] = [TbSysDictionaryData].[DictionaryCode]) AND ([TbSysDictionaryData].[FDictionaryCode] = @FDictionaryCode99)) LEFT OUTER JOIN [TbUser] ON ([TbWorkOrder].[InsertUserCode] = [TbUser].[UserCode]) LEFT OUTER JOIN [TbDistributionPlanInfo] ON ([TbWorkOrder].[OrderCode] = [TbDistributionPlanInfo].[OrderCode]) LEFT OUTER JOIN [TbSemiFinishedSign] ON ([TbWorkOrder].[OrderCode] = [TbSemiFinishedSign].[OrderCodeH]) WHERE (([TbWorkOrder].[ProjectId] = @ProjectId26) AND ([TbWorkOrder].[SiteCode] IN (@SiteCode27,@SiteCode28,@SiteCode29,@SiteCode30,@SiteCode31,@SiteCode32,@SiteCode33,@SiteCode34,@SiteCode35,@SiteCode36,@SiteCode37,@SiteCode38,@SiteCode39,@SiteCode40,@SiteCode41,@SiteCode42,@SiteCode43,@SiteCode44,@SiteCode45,@SiteCode46,@SiteCode47,@SiteCode48,@SiteCode49,@SiteCode50,@SiteCode51,@SiteCode52,@SiteCode53,@SiteCode54,@SiteCode55,@SiteCode56,@SiteCode57,@SiteCode58,@SiteCode59,@SiteCode60,@SiteCode61,@SiteCode62,@SiteCode63,@SiteCode64,@SiteCode65,@SiteCode66,@SiteCode67,@SiteCode68,@SiteCode69,@SiteCode70,@SiteCode71,@SiteCode72,@SiteCode73,@SiteCode74,@SiteCode75,@SiteCode76,@SiteCode77,@SiteCode78,@SiteCode79,@SiteCode80,@SiteCode81,@SiteCode82,@SiteCode83,@SiteCode84,@SiteCode85,@SiteCode86,@SiteCode87,@SiteCode88,@SiteCode89,@SiteCode90,@SiteCode91,@SiteCode92,@SiteCode93,@SiteCode94,@SiteCode95,@SiteCode96,@SiteCode97)))	
Parameters:
@ProjectId26[String] = 6245721945602523136
@SiteCode27[String] = 6437060915425845248
@SiteCode28[String] = 6374383547544903680
@SiteCode29[String] = 6374384032955899904
@SiteCode30[String] = 6374384202665828352
@SiteCode31[String] = 6285121357168508928
@SiteCode32[String] = 6285122203776188416
@SiteCode33[String] = 6437059163368595456
@SiteCode34[String] = 6285120520983674880
@SiteCode35[String] = 6285120866493661184
@SiteCode36[String] = 6285119541664022528
@SiteCode37[String] = 6285120302351384576
@SiteCode38[String] = 6285181647230861312
@SiteCode39[String] = 6284878460246556672
@SiteCode40[String] = 6284879065547538432
@SiteCode41[String] = 6276140742482067456
@SiteCode42[String] = 6276141050964738048
@SiteCode43[String] = 6276141450283450368
@SiteCode44[String] = 6276141737463250944
@SiteCode45[String] = 6276141926932545536
@SiteCode46[String] = 6308426901824208896
@SiteCode47[String] = 6274028829845487616
@SiteCode48[String] = 6274029086029381632
@SiteCode49[String] = 6274029528142577664
@SiteCode50[String] = 6274029966388625408
@SiteCode51[String] = 6274030152053686272
@SiteCode52[String] = 6274030373047369728
@SiteCode53[String] = 6274030913332445184
@SiteCode54[String] = 6274027775095472128
@SiteCode55[String] = 6274027929433276416
@SiteCode56[String] = 6274028333340557312
@SiteCode57[String] = 6417410523612188672
@SiteCode58[String] = 6267798187931598848
@SiteCode59[String] = 6267798388054425600
@SiteCode60[String] = 6276760608893304832
@SiteCode61[String] = 6267797181319610368
@SiteCode62[String] = 6267796592825204736
@SiteCode63[String] = 6267796864196673536
@SiteCode64[String] = 6267797037211713536
@SiteCode65[String] = 6267793380881727488
@SiteCode66[String] = 6267793585479876608
@SiteCode67[String] = 6437059801301262336
@SiteCode68[String] = 6267790081113718784
@SiteCode69[String] = 6267790783294734336
@SiteCode70[String] = 6267791210027417600
@SiteCode71[String] = 6267791528110850048
@SiteCode72[String] = 6267791338536697856
@SiteCode73[String] = 6267791654132908032
@SiteCode74[String] = 6267791036517449728
@SiteCode75[String] = 6267789807737372672
@SiteCode76[String] = 6267790255894560768
@SiteCode77[String] = 6267790460492709888
@SiteCode78[String] = 6267790574804271104
@SiteCode79[String] = 6267785016667799552
@SiteCode80[String] = 6267785185136214016
@SiteCode81[String] = 6267785381991677952
@SiteCode82[String] = 6267785590951903232
@SiteCode83[String] = 6267785762842869760
@SiteCode84[String] = 6267783175129268224
@SiteCode85[String] = 6267783320914886656
@SiteCode86[String] = 6267783444885929984
@SiteCode87[String] = 6267783577954418688
@SiteCode88[String] = 6267784612617912320
@SiteCode89[String] = 6267749616851091456
@SiteCode90[String] = 6267750471750909952
@SiteCode91[String] = 6267750709144322048
@SiteCode92[String] = 6267750895786655744
@SiteCode93[String] = 6267751010588950528
@SiteCode94[String] = 6267753037104676864
@SiteCode95[String] = 6267754200801738752
@SiteCode96[String] = 6267754324688896000
@SiteCode97[String] = 6267797518566817792
@FDictionaryCode98[String] = UrgentDegree
@FDictionaryCode99[String] = ProcessingState


-----------------------------------------------------------------------------
2019-12-17 09:50:01
Text:	 SELECT   TOP 50 [TbWorkOrder].*,[TbCompany].[CompanyFullName] AS [SiteName],[TbSysDictionaryData].[DictionaryText] AS [ProcessingStateNew],[TbUser].[UserName],isnull([TbDistributionPlanInfo].[DistributionStart],N'') AS [DistributionStart],[TbWorkOrder].[Examinestatus] AS [ExaminestatusNew],[TbSemiFinishedSign].[ID] AS [SemiFinishedSignId],[TbSemiFinishedSign].[Enclosure] AS [EnclosureSF],( SELECT   [TbCompany].[CompanyFullName] FROM [TbCompany]  WHERE [TbCompany].[CompanyCode] = [TbWorkOrder].[ProcessFactoryCode] ) AS [ProcessFactoryName],( SELECT   [TbSysDictionaryData].[DictionaryText] FROM [TbSysDictionaryData]  WHERE ([TbSysDictionaryData].[DictionaryCode] = [TbWorkOrder].[UrgentDegree]) AND ([TbSysDictionaryData].[FDictionaryCode] = @FDictionaryCode98) ) AS [UrgentDegreeNew] FROM [TbWorkOrder] LEFT OUTER JOIN [TbCompany] ON ([TbWorkOrder].[SiteCode] = [TbCompany].[CompanyCode]) LEFT OUTER JOIN [TbSysDictionaryData] ON (([TbWorkOrder].[ProcessingState] = [TbSysDictionaryData].[DictionaryCode]) AND ([TbSysDictionaryData].[FDictionaryCode] = @FDictionaryCode99)) LEFT OUTER JOIN [TbUser] ON ([TbWorkOrder].[InsertUserCode] = [TbUser].[UserCode]) LEFT OUTER JOIN [TbDistributionPlanInfo] ON ([TbWorkOrder].[OrderCode] = [TbDistributionPlanInfo].[OrderCode]) LEFT OUTER JOIN [TbSemiFinishedSign] ON ([TbWorkOrder].[OrderCode] = [TbSemiFinishedSign].[OrderCodeH])  WHERE (([TbWorkOrder].[ProjectId] = @ProjectId26) AND ([TbWorkOrder].[SiteCode] IN (@SiteCode27,@SiteCode28,@SiteCode29,@SiteCode30,@SiteCode31,@SiteCode32,@SiteCode33,@SiteCode34,@SiteCode35,@SiteCode36,@SiteCode37,@SiteCode38,@SiteCode39,@SiteCode40,@SiteCode41,@SiteCode42,@SiteCode43,@SiteCode44,@SiteCode45,@SiteCode46,@SiteCode47,@SiteCode48,@SiteCode49,@SiteCode50,@SiteCode51,@SiteCode52,@SiteCode53,@SiteCode54,@SiteCode55,@SiteCode56,@SiteCode57,@SiteCode58,@SiteCode59,@SiteCode60,@SiteCode61,@SiteCode62,@SiteCode63,@SiteCode64,@SiteCode65,@SiteCode66,@SiteCode67,@SiteCode68,@SiteCode69,@SiteCode70,@SiteCode71,@SiteCode72,@SiteCode73,@SiteCode74,@SiteCode75,@SiteCode76,@SiteCode77,@SiteCode78,@SiteCode79,@SiteCode80,@SiteCode81,@SiteCode82,@SiteCode83,@SiteCode84,@SiteCode85,@SiteCode86,@SiteCode87,@SiteCode88,@SiteCode89,@SiteCode90,@SiteCode91,@SiteCode92,@SiteCode93,@SiteCode94,@SiteCode95,@SiteCode96,@SiteCode97))) ORDER BY [TbWorkOrder].[ID] DESC 	
Parameters:
@ProjectId26[String] = 6245721945602523136
@SiteCode27[String] = 6437060915425845248
@SiteCode28[String] = 6374383547544903680
@SiteCode29[String] = 6374384032955899904
@SiteCode30[String] = 6374384202665828352
@SiteCode31[String] = 6285121357168508928
@SiteCode32[String] = 6285122203776188416
@SiteCode33[String] = 6437059163368595456
@SiteCode34[String] = 6285120520983674880
@SiteCode35[String] = 6285120866493661184
@SiteCode36[String] = 6285119541664022528
@SiteCode37[String] = 6285120302351384576
@SiteCode38[String] = 6285181647230861312
@SiteCode39[String] = 6284878460246556672
@SiteCode40[String] = 6284879065547538432
@SiteCode41[String] = 6276140742482067456
@SiteCode42[String] = 6276141050964738048
@SiteCode43[String] = 6276141450283450368
@SiteCode44[String] = 6276141737463250944
@SiteCode45[String] = 6276141926932545536
@SiteCode46[String] = 6308426901824208896
@SiteCode47[String] = 6274028829845487616
@SiteCode48[String] = 6274029086029381632
@SiteCode49[String] = 6274029528142577664
@SiteCode50[String] = 6274029966388625408
@SiteCode51[String] = 6274030152053686272
@SiteCode52[String] = 6274030373047369728
@SiteCode53[String] = 6274030913332445184
@SiteCode54[String] = 6274027775095472128
@SiteCode55[String] = 6274027929433276416
@SiteCode56[String] = 6274028333340557312
@SiteCode57[String] = 6417410523612188672
@SiteCode58[String] = 6267798187931598848
@SiteCode59[String] = 6267798388054425600
@SiteCode60[String] = 6276760608893304832
@SiteCode61[String] = 6267797181319610368
@SiteCode62[String] = 6267796592825204736
@SiteCode63[String] = 6267796864196673536
@SiteCode64[String] = 6267797037211713536
@SiteCode65[String] = 6267793380881727488
@SiteCode66[String] = 6267793585479876608
@SiteCode67[String] = 6437059801301262336
@SiteCode68[String] = 6267790081113718784
@SiteCode69[String] = 6267790783294734336
@SiteCode70[String] = 6267791210027417600
@SiteCode71[String] = 6267791528110850048
@SiteCode72[String] = 6267791338536697856
@SiteCode73[String] = 6267791654132908032
@SiteCode74[String] = 6267791036517449728
@SiteCode75[String] = 6267789807737372672
@SiteCode76[String] = 6267790255894560768
@SiteCode77[String] = 6267790460492709888
@SiteCode78[String] = 6267790574804271104
@SiteCode79[String] = 6267785016667799552
@SiteCode80[String] = 6267785185136214016
@SiteCode81[String] = 6267785381991677952
@SiteCode82[String] = 6267785590951903232
@SiteCode83[String] = 6267785762842869760
@SiteCode84[String] = 6267783175129268224
@SiteCode85[String] = 6267783320914886656
@SiteCode86[String] = 6267783444885929984
@SiteCode87[String] = 6267783577954418688
@SiteCode88[String] = 6267784612617912320
@SiteCode89[String] = 6267749616851091456
@SiteCode90[String] = 6267750471750909952
@SiteCode91[String] = 6267750709144322048
@SiteCode92[String] = 6267750895786655744
@SiteCode93[String] = 6267751010588950528
@SiteCode94[String] = 6267753037104676864
@SiteCode95[String] = 6267754200801738752
@SiteCode96[String] = 6267754324688896000
@SiteCode97[String] = 6267797518566817792
@FDictionaryCode98[String] = UrgentDegree
@FDictionaryCode99[String] = ProcessingState


-----------------------------------------------------------------------------
2019-12-17 09:50:01
Text:	SELECT two.OrderCode,(
            	case 
            				when two.IsOffline=0
            				THEN(
            SELECT top 1 de.LoadCompleteTime FROM TbDistributionEntOrder deo
            LEFT JOIN TbDistributionEnt de ON deo.DistributionCode=de.DistributionCode
            WHERE deo.OrderCode LIKE '%'+two.OrderCode+'%'
            ORDER BY de.LoadCompleteTime desc
            )ELSE
            	(
            		SELECT DeliveryCompleteTime
            		FROM TbDistributionPlanInfo
            		WHERE OrderCode=two.OrderCode
            	)
            	END
            ) AS LoadCompleteTime 
            FROM TbWorkOrder two
            WHERE two.OrderCode IN('JGDD201902880','JGDD201902879','JGDD201902876','JGDD201902875','JGDD201902874','JGDD201902873','JGDD201902872','JGDD201902871','JGDD201902870','JGDD201902869','JGDD201902868','JGDD201902867','JGDD201902866','JGDD201902865','JGDD201902864','JGDD201902863','JGDD201902862','JGDD201902858','JGDD201902857','JGDD201902856','JGDD201902855','JGDD201902854','JGDD201902853','JGDD201902852','JGDD201902848','JGDD201902847','JGDD201902846','JGDD201902845','JGDD201902844','JGDD201902843','JGDD201902842','JGDD201902841','JGDD201902838','JGDD201902837','JGDD201902836','JGDD201902835','JGDD201902834','JGDD201902833','JGDD201902832','JGDD201902831','JGDD201902830','JGDD201902829','JGDD201902828','JGDD201902827','JGDD201902826','JGDD201902825','JGDD201902824','JGDD201902823','JGDD201902822','JGDD201902821')	


-----------------------------------------------------------------------------
2019-12-17 09:50:01
Text:	SELECT two.OrderCode,(case 
            				when two.IsOffline=0
            				THEN(
                            SELECT COUNT(1) AS number FROM TbDistributionEntOrder 
                            WHERE OrderCode LIKE '%'+two.OrderCode+'%')
                            ELSE
            	(
            		SELECT COUNT(1) FROM TbSemiFinishedSign WHERE OrderCodeH=two.OrderCode
            		)
            	END) total,(
            		case 
            				when two.IsOffline=0
            				THEN(
                            SELECT COUNT(1) AS number FROM TbDistributionEntOrder 
                            WHERE OrderCode LIKE '%'+two.OrderCode+'%'AND SignState='未签收')  ELSE
            	(
            		SELECT COUNT(1) FROM TbSemiFinishedSign WHERE OrderCodeH=two.OrderCode AND OperateState='未签收'
            		)
            	END) number
                            FROM TbWorkOrder two
                            WHERE two.OrderCode IN('JGDD201902880','JGDD201902879','JGDD201902876','JGDD201902875','JGDD201902874','JGDD201902873','JGDD201902872','JGDD201902871','JGDD201902870','JGDD201902869','JGDD201902868','JGDD201902867','JGDD201902866','JGDD201902865','JGDD201902864','JGDD201902863','JGDD201902862','JGDD201902858','JGDD201902857','JGDD201902856','JGDD201902855','JGDD201902854','JGDD201902853','JGDD201902852','JGDD201902848','JGDD201902847','JGDD201902846','JGDD201902845','JGDD201902844','JGDD201902843','JGDD201902842','JGDD201902841','JGDD201902838','JGDD201902837','JGDD201902836','JGDD201902835','JGDD201902834','JGDD201902833','JGDD201902832','JGDD201902831','JGDD201902830','JGDD201902829','JGDD201902828','JGDD201902827','JGDD201902826','JGDD201902825','JGDD201902824','JGDD201902823','JGDD201902822','JGDD201902821')	


-----------------------------------------------------------------------------
2019-12-17 09:50:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:50:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:50:05
Text:	--*********************加工订单信息查询***********************
                            SELECT O.ID,O.OrderCode,
                                O.ProjectId,                
		                        TypeName,
		                        TypeCode,
		                        UsePart CollarPosition,
		                        O.ProcessFactoryCode ProcessFactoryCode,
		                        C.CompanyFullName ProcessFactoryName,
		                        CC.CompanyFullName SiteName,
		                        CC.CompanyCode SiteCode,
		                        A.CompanyFullName WorkAreaName,
		                        A.CompanyCode WorkAreaCode,
		                        B.CompanyCode BranchCode,
		                        B.CompanyFullName BranchName
		                        FROM TbWorkOrder O
		                        LEFT JOIN TbCompany C ON O.ProcessFactoryCode=C.CompanyCode
		                        LEFT JOIN TbCompany CC ON CC.CompanyCode=O.SiteCode
		                        LEFT JOIN View_CompanyParentCodeName A ON A.OrderCode=O.OrderCode
		                        LEFT JOIN (
									 SELECT A.OrderCode,C.CompanyFullName,C.CompanyCode FROM TbCompany C
											INNER JOIN (
											SELECT C.ParentCompanyCode,V.OrderCode FROM View_CompanyParentCodeName V
											INNER JOIN TbCompany C ON V.CompanyCode=C.CompanyCode) A 
											ON A.ParentCompanyCode=C.CompanyCode
		                        ) B ON B.OrderCode=O.OrderCode
		                        WHERE O.OrderCode not in(
		                                       SELECT DISTINCT OrderCode
		                                       FROM TbRMProductionMaterial
		                                       WHERE CollarState='领料完成'
		                                      ) 
                                and O.Examinestatus='审核完成' and O.ProcessingState !='Finishing' and O.OrderStart !='全部撤销'  and TypeName like '%JGDD201902880%' or UsePart='JGDD201902880' or O.OrderCode like '%JGDD201902880%'  and O.ProjectId='6245721945602523136'  and (CC.CompanyCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or A.CompanyCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))	


-----------------------------------------------------------------------------
2019-12-17 09:50:05
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (--*********************加工订单信息查询***********************
                            SELECT O.ID,O.OrderCode,
                                O.ProjectId,                
		                        TypeName,
		                        TypeCode,
		                        UsePart CollarPosition,
		                        O.ProcessFactoryCode ProcessFactoryCode,
		                        C.CompanyFullName ProcessFactoryName,
		                        CC.CompanyFullName SiteName,
		                        CC.CompanyCode SiteCode,
		                        A.CompanyFullName WorkAreaName,
		                        A.CompanyCode WorkAreaCode,
		                        B.CompanyCode BranchCode,
		                        B.CompanyFullName BranchName
		                        FROM TbWorkOrder O
		                        LEFT JOIN TbCompany C ON O.ProcessFactoryCode=C.CompanyCode
		                        LEFT JOIN TbCompany CC ON CC.CompanyCode=O.SiteCode
		                        LEFT JOIN View_CompanyParentCodeName A ON A.OrderCode=O.OrderCode
		                        LEFT JOIN (
									 SELECT A.OrderCode,C.CompanyFullName,C.CompanyCode FROM TbCompany C
											INNER JOIN (
											SELECT C.ParentCompanyCode,V.OrderCode FROM View_CompanyParentCodeName V
											INNER JOIN TbCompany C ON V.CompanyCode=C.CompanyCode) A 
											ON A.ParentCompanyCode=C.CompanyCode
		                        ) B ON B.OrderCode=O.OrderCode
		                        WHERE O.OrderCode not in(
		                                       SELECT DISTINCT OrderCode
		                                       FROM TbRMProductionMaterial
		                                       WHERE CollarState='领料完成'
		                                      ) 
                                and O.Examinestatus='审核完成' and O.ProcessingState !='Finishing' and O.OrderStart !='全部撤销'  and TypeName like '%JGDD201902880%' or UsePart='JGDD201902880' or O.OrderCode like '%JGDD201902880%'  and O.ProjectId='6245721945602523136'  and (CC.CompanyCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or A.CompanyCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 09:50:05
Text:	SELECT
                                D.ID as WorkOrderItemId,
                                D.OrderCode,
                                D.ComponentName,
                                D.MaterialCode,
                                D.MaterialName,
                                D.SpecificationModel,
                                D.MeasurementUnitZl,
                                D.ItemUseNum,
                                D.Number,
                                D.Manufactor,
                                D.HeatNo,
                                D.TestReportNo,
                                D.WeightSmallPlan,
                               (d.WeightSmallPlan-isnull(b.WeightSmallPlanN,0)) as WeightSmallPlanNH
                               FROM TbWorkOrderDetail D
                               left join (
                                   select 
                                   OrderCode,
                                   WorkOrderItemId,
                                   sum(WeightSmallPlanN) as WeightSmallPlanN
                                   from TbRMProductionMaterialDetail
                                   group by OrderCode,WorkOrderItemId) b
                               on d.OrderCode=b.OrderCode
                               and d.ID=b.WorkOrderItemId
                               WHERE ((ISNULL(@keyword,'')='' OR D.ComponentName LIKE @keyword)
                               OR (ISNULL(@keyword,'')='' OR D.MaterialName LIKE @keyword))
                               AND D.OrderCode=@OrderCode and (d.WeightSmallPlan-isnull(b.WeightSmallPlanN,0))>0 and D.RevokeStart='正常'	
Parameters:
@keyword[String] = %%
@OrderCode[String] = JGDD201902880


-----------------------------------------------------------------------------
2019-12-17 09:50:05
Text:	select  
                                a.* ,
                                b.SpecificationModel,
                                b.MaterialName,
                                b.MeasurementUnitZl
                              FROM ( 
                                SELECT 
                                 a.MaterialCode, 
                                 SUM(a.UseCount)as Weight
                                 from TbRawMaterialStockRecord a
                                where a.ProjectId=@ProjectId and a.MaterialCode IN('MI201800050','MI201800048','MI201800043') and a.WorkAreaCode=@WorkAreaCode and a.ChackState=1 GROUP BY a.MaterialCode) AS a
                               left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode	
Parameters:
@ProjectId[String] = 6245721945602523136
@WorkAreaCode[String] = 6267782749348691968


-----------------------------------------------------------------------------
2019-12-17 09:50:14
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 09:50:14
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 09:50:14
Text:	--*********************加工订单信息查询***********************
                            SELECT O.ID,O.OrderCode,
                                O.ProjectId,                
		                        TypeName,
		                        TypeCode,
		                        UsePart CollarPosition,
		                        O.ProcessFactoryCode ProcessFactoryCode,
		                        C.CompanyFullName ProcessFactoryName,
		                        CC.CompanyFullName SiteName,
		                        CC.CompanyCode SiteCode,
		                        A.CompanyFullName WorkAreaName,
		                        A.CompanyCode WorkAreaCode,
		                        B.CompanyCode BranchCode,
		                        B.CompanyFullName BranchName
		                        FROM TbWorkOrder O
		                        LEFT JOIN TbCompany C ON O.ProcessFactoryCode=C.CompanyCode
		                        LEFT JOIN TbCompany CC ON CC.CompanyCode=O.SiteCode
		                        LEFT JOIN View_CompanyParentCodeName A ON A.OrderCode=O.OrderCode
		                        LEFT JOIN (
									 SELECT A.OrderCode,C.CompanyFullName,C.CompanyCode FROM TbCompany C
											INNER JOIN (
											SELECT C.ParentCompanyCode,V.OrderCode FROM View_CompanyParentCodeName V
											INNER JOIN TbCompany C ON V.CompanyCode=C.CompanyCode) A 
											ON A.ParentCompanyCode=C.CompanyCode
		                        ) B ON B.OrderCode=O.OrderCode
		                        WHERE O.OrderCode not in(
		                                       SELECT DISTINCT OrderCode
		                                       FROM TbRMProductionMaterial
		                                       WHERE CollarState='领料完成'
		                                      ) 
                                and O.Examinestatus='审核完成' and O.ProcessingState !='Finishing' and O.OrderStart !='全部撤销'  and TypeName like '%JGDD201902879%' or UsePart='JGDD201902879' or O.OrderCode like '%JGDD201902879%'  and O.ProjectId='6245721945602523136'  and (CC.CompanyCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or A.CompanyCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))	


-----------------------------------------------------------------------------
2019-12-17 09:50:14
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (--*********************加工订单信息查询***********************
                            SELECT O.ID,O.OrderCode,
                                O.ProjectId,                
		                        TypeName,
		                        TypeCode,
		                        UsePart CollarPosition,
		                        O.ProcessFactoryCode ProcessFactoryCode,
		                        C.CompanyFullName ProcessFactoryName,
		                        CC.CompanyFullName SiteName,
		                        CC.CompanyCode SiteCode,
		                        A.CompanyFullName WorkAreaName,
		                        A.CompanyCode WorkAreaCode,
		                        B.CompanyCode BranchCode,
		                        B.CompanyFullName BranchName
		                        FROM TbWorkOrder O
		                        LEFT JOIN TbCompany C ON O.ProcessFactoryCode=C.CompanyCode
		                        LEFT JOIN TbCompany CC ON CC.CompanyCode=O.SiteCode
		                        LEFT JOIN View_CompanyParentCodeName A ON A.OrderCode=O.OrderCode
		                        LEFT JOIN (
									 SELECT A.OrderCode,C.CompanyFullName,C.CompanyCode FROM TbCompany C
											INNER JOIN (
											SELECT C.ParentCompanyCode,V.OrderCode FROM View_CompanyParentCodeName V
											INNER JOIN TbCompany C ON V.CompanyCode=C.CompanyCode) A 
											ON A.ParentCompanyCode=C.CompanyCode
		                        ) B ON B.OrderCode=O.OrderCode
		                        WHERE O.OrderCode not in(
		                                       SELECT DISTINCT OrderCode
		                                       FROM TbRMProductionMaterial
		                                       WHERE CollarState='领料完成'
		                                      ) 
                                and O.Examinestatus='审核完成' and O.ProcessingState !='Finishing' and O.OrderStart !='全部撤销'  and TypeName like '%JGDD201902879%' or UsePart='JGDD201902879' or O.OrderCode like '%JGDD201902879%'  and O.ProjectId='6245721945602523136'  and (CC.CompanyCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or A.CompanyCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 09:50:14
Text:	SELECT
                                D.ID as WorkOrderItemId,
                                D.OrderCode,
                                D.ComponentName,
                                D.MaterialCode,
                                D.MaterialName,
                                D.SpecificationModel,
                                D.MeasurementUnitZl,
                                D.ItemUseNum,
                                D.Number,
                                D.Manufactor,
                                D.HeatNo,
                                D.TestReportNo,
                                D.WeightSmallPlan,
                               (d.WeightSmallPlan-isnull(b.WeightSmallPlanN,0)) as WeightSmallPlanNH
                               FROM TbWorkOrderDetail D
                               left join (
                                   select 
                                   OrderCode,
                                   WorkOrderItemId,
                                   sum(WeightSmallPlanN) as WeightSmallPlanN
                                   from TbRMProductionMaterialDetail
                                   group by OrderCode,WorkOrderItemId) b
                               on d.OrderCode=b.OrderCode
                               and d.ID=b.WorkOrderItemId
                               WHERE ((ISNULL(@keyword,'')='' OR D.ComponentName LIKE @keyword)
                               OR (ISNULL(@keyword,'')='' OR D.MaterialName LIKE @keyword))
                               AND D.OrderCode=@OrderCode and (d.WeightSmallPlan-isnull(b.WeightSmallPlanN,0))>0 and D.RevokeStart='正常'	
Parameters:
@keyword[String] = %%
@OrderCode[String] = JGDD201902879


-----------------------------------------------------------------------------
2019-12-17 09:50:14
Text:	select  
                                a.* ,
                                b.SpecificationModel,
                                b.MaterialName,
                                b.MeasurementUnitZl
                              FROM ( 
                                SELECT 
                                 a.MaterialCode, 
                                 SUM(a.UseCount)as Weight
                                 from TbRawMaterialStockRecord a
                                where a.ProjectId=@ProjectId and a.MaterialCode IN('MI201800049','MI201800048','MI201800050','MI201800047','MI201800042','MI201800054') and a.WorkAreaCode=@WorkAreaCode and a.ChackState=1 GROUP BY a.MaterialCode) AS a
                               left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode	
Parameters:
@ProjectId[String] = 6245721945602523136
@WorkAreaCode[String] = 6267782749348691968


-----------------------------------------------------------------------------
2019-12-17 09:51:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:51:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 09:52:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 09:53:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:53:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 09:54:20
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 09:54:21
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 09:54:21
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode100) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode101,@EWFormDataCode102,@EWFormDataCode103,@EWFormDataCode104,@EWFormDataCode105,@EWFormDataCode106,@EWFormDataCode107,@EWFormDataCode108,@EWFormDataCode109,@EWFormDataCode110,@EWFormDataCode111,@EWFormDataCode112,@EWFormDataCode113,@EWFormDataCode114,@EWFormDataCode115)) 	
Parameters:
@MenuCode100[String] = SupplyList
@EWFormDataCode101[Int32] = 4
@EWFormDataCode102[Int32] = 9
@EWFormDataCode103[Int32] = 10
@EWFormDataCode104[Int32] = 11
@EWFormDataCode105[Int32] = 13
@EWFormDataCode106[Int32] = 14
@EWFormDataCode107[Int32] = 15
@EWFormDataCode108[Int32] = 17
@EWFormDataCode109[Int32] = 19
@EWFormDataCode110[Int32] = 5
@EWFormDataCode111[Int32] = 6
@EWFormDataCode112[Int32] = 7
@EWFormDataCode113[Int32] = 8
@EWFormDataCode114[Int32] = 16
@EWFormDataCode115[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 09:55:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:55:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 09:55:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 09:57:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:57:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 09:58:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 09:59:20
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 09:59:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:59:20
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 09:59:21
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 09:59:21
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode116) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode117,@EWFormDataCode118,@EWFormDataCode119,@EWFormDataCode120,@EWFormDataCode121,@EWFormDataCode122,@EWFormDataCode123,@EWFormDataCode124,@EWFormDataCode125,@EWFormDataCode126,@EWFormDataCode127,@EWFormDataCode128,@EWFormDataCode129,@EWFormDataCode130,@EWFormDataCode131)) 	
Parameters:
@MenuCode116[String] = SupplyList
@EWFormDataCode117[Int32] = 4
@EWFormDataCode118[Int32] = 9
@EWFormDataCode119[Int32] = 10
@EWFormDataCode120[Int32] = 11
@EWFormDataCode121[Int32] = 13
@EWFormDataCode122[Int32] = 14
@EWFormDataCode123[Int32] = 15
@EWFormDataCode124[Int32] = 17
@EWFormDataCode125[Int32] = 19
@EWFormDataCode126[Int32] = 5
@EWFormDataCode127[Int32] = 6
@EWFormDataCode128[Int32] = 7
@EWFormDataCode129[Int32] = 8
@EWFormDataCode130[Int32] = 16
@EWFormDataCode131[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 09:59:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:01:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:01:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:01:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:03:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:03:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:03:42
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 10:03:42
Text:	SELECT mm.MenuUrl, pp.UserCode, pp.menuCode, pp.OperationView, pp.OperationAdd
	                        , pp.OperationEdit, pp.OperationDel, pp.OperationExamination, pp.OperationOutput, pp.OperationOther1
	                        , mm.OperationOther1Fun, mm.OperationOther1IconCls, pp.OperationOther2, mm.OperationOther2Fun, mm.OperationOther2IconCls
	                        , pp.OperationOther3, mm.OperationOther3Fun, mm.OperationOther3IconCls, pp.OperationOther4, mm.OperationOther4Fun
	                        , mm.OperationOther4IconCls, pp.OperationOther5, mm.OperationOther5Fun, mm.OperationOther5IconCls
                        FROM (
	                        SELECT UserCode, menuCode, MAX(OperationView) AS OperationView
		                        , MAX(OperationAdd) AS OperationAdd, MAX(OperationEdit) AS OperationEdit
		                        , MAX(OperationDel) AS OperationDel, MAX(OperationExamination) AS OperationExamination
		                        , MAX(OperationOutput) AS OperationOutput, MAX(OperationOther1) AS OperationOther1
		                        , MAX(OperationOther2) AS OperationOther2, MAX(OperationOther3) AS OperationOther3
		                        , MAX(OperationOther4) AS OperationOther4, MAX(OperationOther5) AS OperationOther5
	                        FROM (
		                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
			                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
			                        , OperationOther3, OperationOther4, OperationOther5
		                        FROM (
			                        SELECT a.UserCode, b.menuCode, MAX(b.OperationView) AS OperationView
				                        , MAX(b.OperationAdd) AS OperationAdd, MAX(b.OperationEdit) AS OperationEdit
				                        , MAX(b.OperationDel) AS OperationDel, MAX(b.OperationExamination) AS OperationExamination
				                        , MAX(b.OperationOutput) AS OperationOutput, MAX(b.OperationOther1) AS OperationOther1
				                        , MAX(b.OperationOther2) AS OperationOther2, MAX(b.OperationOther3) AS OperationOther3
				                        , MAX(b.OperationOther4) AS OperationOther4, MAX(b.OperationOther5) AS OperationOther5
			                        FROM dbo.TbUserRole a
				                        INNER JOIN dbo.TbRoleMenu b ON a.RoleCode = b.RoleCode
                                        where b.RoleCode in('6337324142387400704','6352967650544590848')
			                        GROUP BY a.UserCode, b.menuCode
			                        UNION ALL
			                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
				                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
				                        , OperationOther3, OperationOther4, OperationOther5
			                        FROM dbo.TbUserMenu
			                        union all
			                        SELECT p.UserCode, d.menuCode, MAX(d.OperationView) AS OperationView
				                        , MAX(d.OperationAdd) AS OperationAdd, MAX(d.OperationEdit) AS OperationEdit
				                        , MAX(d.OperationDel) AS OperationDel, MAX(d.OperationExamination) AS OperationExamination
				                        , MAX(d.OperationOutput) AS OperationOutput, MAX(d.OperationOther1) AS OperationOther1
				                        , MAX(d.OperationOther2) AS OperationOther2, MAX(d.OperationOther3) AS OperationOther3
				                        , MAX(d.OperationOther4) AS OperationOther4, MAX(d.OperationOther5) AS OperationOther5
			                        FROM dbo.TbPositionUser p
				                        INNER JOIN dbo.TbPositionMenu d ON p.PositionCode = d.PositionCode
			                        GROUP BY p.UserCode, d.menuCode
			
		                        ) c
	                        ) aa
	                        GROUP BY UserCode, menuCode
                        ) pp
                        INNER JOIN dbo.TbSysMenu mm ON pp.menuCode = mm.menuCode 
                        left join dbo.TbUser u on pp.UserCode=u.UserId
                        where u.UserCode=@UserCode And mm.MenuUrl=@menuURI	
Parameters:
@UserCode[String] = 102787
@menuURI[String] = /RawMaterial/EndingStocks/Index


-----------------------------------------------------------------------------
2019-12-17 10:03:42
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:03:42
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:03:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 10:03:43
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:03:43
Text:	select Tb1.*,isnull(dhrk.PassCount,0) as AcceptanceQuantity,isnull(yclll.WeightSmallPlanN,0) as WeightSmallPlan,(isnull(yclll.WeightSmallPlanN,0)-ISNULL(yclll.WeightSmallPlan,0)-isnull(ylk.yll,0)) as Loss,(isnull(Tb1.InitialCount,0)+isnull(dhrk.PassCount,0)-isnull(yclll.WeightSmallPlanN,0)) as RawMaterialStockQuantity,isnull(yclll.WeightSmallPlan,0) as ComponentStockQuantity,isnull(flk.StartAddUpHandleQuantity,0) as StartAddUpHandleQuantity,isnull(flk.UntreatedQuantity,0) as UntreatedQuantity from (select tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText as MeasurementUnitName,sum(tb.Count) as InitialCount from TbRawMaterialStockRecord tb
                           left join TbRawMaterialArchives rma on tb.MaterialCode=rma.MaterialCode
                           left join TbSysDictionaryData sdd on rma.MeasurementUnit=sdd.DictionaryCode
                           left join TbStorage s on s.StorageCode=tb.StorageCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId)
                           and tb.ChackState=1 
                           and (ISNULL(@MaterialNames,'')='' or tb.MaterialName=@MaterialNames) 
                           and (ISNULL(@SpecificationModel,'')='' or tb.SpecificationModel like '%'+@SpecificationModel+'%')   
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText) Tb1

                           left join (select inoi.MaterialCode,isnull(sum(inoi.PassCount),0) as PassCount from TbInOrder tb
                           left join TbInOrderItem inoi on tb.InOrderCode=inoi.InOrderCode 
                           left join TbFactoryBatchNeedPlan fbnp on tb.BatchPlanCode=fbnp.BatchPlanNum
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbnp.ProcessFactoryCode=@ProcessFactoryCode) 
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by inoi.MaterialCode) as dhrk on Tb1.MaterialCode=dhrk.MaterialCode

                           left join(select rpmd.MaterialCode,SUM(rpmd.WeightSmallPlan) as WeightSmallPlan,sum(rpmd.WeightSmallPlanN) as WeightSmallPlanN from TbRMProductionMaterial tb
                           left join TbRMProductionMaterialDetail rpmd on tb.CollarCode=rpmd.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or tb.ProcessFactoryCode=@ProcessFactoryCode)  
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by rpmd.MaterialCode) as yclll on Tb1.MaterialCode=yclll.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.WeightYes) as StartAddUpHandleQuantity,SUM(tb.WeightNot) as UntreatedQuantity from TbRubbishStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as flk on flk.MaterialCode=Tb1.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.Weight) as yll from TbCloutStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
						   and tb.SiteCode!='-1'
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as ylk on ylk.MaterialCode=Tb1.MaterialCode	
Parameters:
@ProjectId[String] = 6245721945602523136
@MaterialNames[String] = 
@SpecificationModel[String] = 
@ProcessFactoryCode[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:03:43
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select Tb1.*,isnull(dhrk.PassCount,0) as AcceptanceQuantity,isnull(yclll.WeightSmallPlanN,0) as WeightSmallPlan,(isnull(yclll.WeightSmallPlanN,0)-ISNULL(yclll.WeightSmallPlan,0)-isnull(ylk.yll,0)) as Loss,(isnull(Tb1.InitialCount,0)+isnull(dhrk.PassCount,0)-isnull(yclll.WeightSmallPlanN,0)) as RawMaterialStockQuantity,isnull(yclll.WeightSmallPlan,0) as ComponentStockQuantity,isnull(flk.StartAddUpHandleQuantity,0) as StartAddUpHandleQuantity,isnull(flk.UntreatedQuantity,0) as UntreatedQuantity from (select tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText as MeasurementUnitName,sum(tb.Count) as InitialCount from TbRawMaterialStockRecord tb
                           left join TbRawMaterialArchives rma on tb.MaterialCode=rma.MaterialCode
                           left join TbSysDictionaryData sdd on rma.MeasurementUnit=sdd.DictionaryCode
                           left join TbStorage s on s.StorageCode=tb.StorageCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId)
                           and tb.ChackState=1 
                           and (ISNULL(@MaterialNames,'')='' or tb.MaterialName=@MaterialNames) 
                           and (ISNULL(@SpecificationModel,'')='' or tb.SpecificationModel like '%'+@SpecificationModel+'%')   
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText) Tb1

                           left join (select inoi.MaterialCode,isnull(sum(inoi.PassCount),0) as PassCount from TbInOrder tb
                           left join TbInOrderItem inoi on tb.InOrderCode=inoi.InOrderCode 
                           left join TbFactoryBatchNeedPlan fbnp on tb.BatchPlanCode=fbnp.BatchPlanNum
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbnp.ProcessFactoryCode=@ProcessFactoryCode) 
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by inoi.MaterialCode) as dhrk on Tb1.MaterialCode=dhrk.MaterialCode

                           left join(select rpmd.MaterialCode,SUM(rpmd.WeightSmallPlan) as WeightSmallPlan,sum(rpmd.WeightSmallPlanN) as WeightSmallPlanN from TbRMProductionMaterial tb
                           left join TbRMProductionMaterialDetail rpmd on tb.CollarCode=rpmd.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or tb.ProcessFactoryCode=@ProcessFactoryCode)  
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by rpmd.MaterialCode) as yclll on Tb1.MaterialCode=yclll.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.WeightYes) as StartAddUpHandleQuantity,SUM(tb.WeightNot) as UntreatedQuantity from TbRubbishStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as flk on flk.MaterialCode=Tb1.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.Weight) as yll from TbCloutStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
						   and tb.SiteCode!='-1'
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as ylk on ylk.MaterialCode=Tb1.MaterialCode) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@MaterialNames[String] = 
@SpecificationModel[String] = 
@ProcessFactoryCode[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:03:44
Text:	select YEAR(InsertTime) Year,CONVERT(varchar,YEAR(InsertTime))+'年' YearName from TbWorkOrder  group by YEAR(InsertTime) order by YEAR(InsertTime) desc	


-----------------------------------------------------------------------------
2019-12-17 10:03:44
StoredProcedure:	MaterialTotalStockReport_Proc	
Parameters:
@ProcessFactoryCode[String] = 
@MaterialNames[String] = 
@SpecificationModel[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:03:44
Text:	SELECT
                        	ISNULL(dbo.GetCompanyParentName_fun(tc.CompanyCode),tc.CompanyFullName) AS CompanyName, 
                        	 (
                        	 	SELECT ISNULL(SUM(a.PlanTotal+ISNULL(b.SupplyPlanNum,0)),0) AS PlanTotal 
								FROM TbRawMaterialMonthDemandPlan a
								LEFT JOIN TbRawMaterialMonthDemandSupplyPlan b ON a.DemandPlanCode=b.DemandPlanCode AND b.IsSupply=0 AND b.Examinestatus='审核完成'
								 WHERE a.Examinestatus='审核完成'  and YEAR(a.insertTime)=2019 and MONTH(a.insertTime)=10
                        		AND a.WorkAreaCode IN
                        		(
                        		  SELECT CompanyCode from dbo.GetCompanyChild_fun(tc.CompanyCode) WHERE OrgType=4
                        		)
                        	 ) PlanTotal, --月度计划量
                        	 (
                        		SELECT ISNULL(sum(BatchPlanTotal),0) AS BatchPlanTotal 
								FROM TbFactoryBatchNeedPlan a
								 WHERE a.Examinestatus='审核完成'  and YEAR(a.insertTime)=2019 and MONTH(a.insertTime)=10
                        		AND 
                        		a.WorkAreaCode IN
                        		(
                        		  SELECT CompanyCode from dbo.GetCompanyChild_fun(tc.CompanyCode) WHERE OrgType=4
                        		) 
                        	 )BatchPlanTotal --批次计划量
                        	FROM TbCompany tc
                        	LEFT JOIN TbProjectCompany b ON tc.CompanyCode=b.CompanyCode
                        	WHERE 
                        	tc.OrgType=3 
                        	AND b.ProjectId=6245721945602523136
                        	ORDER BY PlanTotal desc	


-----------------------------------------------------------------------------
2019-12-17 10:03:44
StoredProcedure:	ProcessingRankingListReport_Proc	
Parameters:
@ProcessFactoryCode[String] = 
@MaterialCode[String] = 
@MaterialNames[String] = 
@SpecificationModel[String] = 
@Year[Int32] = 2019
@Month[Int32] = 12


-----------------------------------------------------------------------------
2019-12-17 10:03:45
StoredProcedure:	MaterialRankingListReport_Proc	
Parameters:
@ProcessFactoryCode[String] = 
@MaterialNames[String] = 
@SpecificationModel[String] = 
@Year[Int32] = 2019
@Month[Int32] = 12


-----------------------------------------------------------------------------
2019-12-17 10:03:45
StoredProcedure:	MaterialTotalStockHistoryReport_Proc	
Parameters:
@ProcessFactoryCode[String] = 
@MaterialCode[String] = 
@MaterialNames[String] = 
@SpecificationModel[String] = 
@Year[Int32] = 2019
@Month[Int32] = 12


-----------------------------------------------------------------------------
2019-12-17 10:04:18
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 10:04:18
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:04:18
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:04:18
Text:	select isnull(sum(inoi.PassCount),0) as FeedNum from TbInOrder ino
                           left join TbInOrderItem inoi on ino.InOrderCode=inoi.InOrderCode
                           where ino.Examinestatus='审核完成' and inoi.ChackState=1
                           and (ISNULL(@BegTime,'')='' or ino.InsertTime>=CONVERT(varchar,@BegTime,101)) 
                           and (ISNULL(@EndTime,'')='' or ino.InsertTime<=@EndTime)
                           and (ISNULL(@MaterialName,'')='' or inoi.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or inoi.SpecificationModel like '%'+@SpecificationModel+'%')
                           and (ISNULL(@ProjectId,'')='' or ino.ProjectId=@ProjectId)
                            
                           union all
                           select isnull(sum(rmpmp.WeightSmallPlanN),0) as YLNum from TbRMProductionMaterial rmpm
                           left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
                           left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
                           left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
                           where rmpm.Examinestatus='审核完成'
                           and rmpmp.RMTypeName='余料' 
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            
                           and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
                           union all
                           select sum(Tb.RawMaterialNum) as RawMaterialNum from (select isnull(sum(rmpmp.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterial rmpm
						   left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
						   left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
						   left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
						   where  rmpm.Examinestatus='审核完成'
						   and rmpmp.RMTypeName='原材料' 
						   and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
						   union all
						   select isnull(sum(rpmd.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterialDetail rpmd 
						   left join TbRMProductionMaterial rpm on rpmd.CollarCode=rpm.CollarCode
						   where  rpm.Examinestatus='审核完成'
						   and rpmd.WorkOrderItemId not in(select WorkOrderItemId from TbRMProductionMaterialPlan)
						   and (ISNULL(@BegTime,'')='' or rpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rpmd.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rpmd.SpecificationModel like '%'+@SpecificationModel+'%')) Tb	
Parameters:
@BegTime[DateTime] = 
@EndTime[DateTime] = 
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:04:19
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:04:19
Text:	select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:04:19
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:04:19
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:04:20
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 10:04:20
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:04:20
Text:	select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:04:20
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:04:20
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:04:21
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:04:21
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode132) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode133,@EWFormDataCode134,@EWFormDataCode135,@EWFormDataCode136,@EWFormDataCode137,@EWFormDataCode138,@EWFormDataCode139,@EWFormDataCode140,@EWFormDataCode141,@EWFormDataCode142,@EWFormDataCode143,@EWFormDataCode144,@EWFormDataCode145,@EWFormDataCode146,@EWFormDataCode147)) 	
Parameters:
@MenuCode132[String] = SupplyList
@EWFormDataCode133[Int32] = 4
@EWFormDataCode134[Int32] = 9
@EWFormDataCode135[Int32] = 10
@EWFormDataCode136[Int32] = 11
@EWFormDataCode137[Int32] = 13
@EWFormDataCode138[Int32] = 14
@EWFormDataCode139[Int32] = 15
@EWFormDataCode140[Int32] = 17
@EWFormDataCode141[Int32] = 19
@EWFormDataCode142[Int32] = 5
@EWFormDataCode143[Int32] = 6
@EWFormDataCode144[Int32] = 7
@EWFormDataCode145[Int32] = 8
@EWFormDataCode146[Int32] = 16
@EWFormDataCode147[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:04:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:05:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:05:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:07:20
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:07:21
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:07:36
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 10:07:36
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:07:36
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:07:37
Text:	select isnull(sum(inoi.PassCount),0) as FeedNum from TbInOrder ino
                           left join TbInOrderItem inoi on ino.InOrderCode=inoi.InOrderCode
                           where ino.Examinestatus='审核完成' and inoi.ChackState=1
                           and (ISNULL(@BegTime,'')='' or ino.InsertTime>=CONVERT(varchar,@BegTime,101)) 
                           and (ISNULL(@EndTime,'')='' or ino.InsertTime<=@EndTime)
                           and (ISNULL(@MaterialName,'')='' or inoi.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or inoi.SpecificationModel like '%'+@SpecificationModel+'%')
                           and (ISNULL(@ProjectId,'')='' or ino.ProjectId=@ProjectId)
                            
                           union all
                           select isnull(sum(rmpmp.WeightSmallPlanN),0) as YLNum from TbRMProductionMaterial rmpm
                           left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
                           left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
                           left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
                           where rmpm.Examinestatus='审核完成'
                           and rmpmp.RMTypeName='余料' 
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            
                           and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
                           union all
                           select sum(Tb.RawMaterialNum) as RawMaterialNum from (select isnull(sum(rmpmp.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterial rmpm
						   left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
						   left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
						   left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
						   where  rmpm.Examinestatus='审核完成'
						   and rmpmp.RMTypeName='原材料' 
						   and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
						   union all
						   select isnull(sum(rpmd.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterialDetail rpmd 
						   left join TbRMProductionMaterial rpm on rpmd.CollarCode=rpm.CollarCode
						   where  rpm.Examinestatus='审核完成'
						   and rpmd.WorkOrderItemId not in(select WorkOrderItemId from TbRMProductionMaterialPlan)
						   and (ISNULL(@BegTime,'')='' or rpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rpmd.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rpmd.SpecificationModel like '%'+@SpecificationModel+'%')) Tb	
Parameters:
@BegTime[DateTime] = 
@EndTime[DateTime] = 
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:07:37
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:07:42
Text:	select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:07:42
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:07:48
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode148) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode149,@EWFormDataCode150,@EWFormDataCode151,@EWFormDataCode152,@EWFormDataCode153,@EWFormDataCode154,@EWFormDataCode155,@EWFormDataCode156,@EWFormDataCode157,@EWFormDataCode158,@EWFormDataCode159,@EWFormDataCode160,@EWFormDataCode161,@EWFormDataCode162,@EWFormDataCode163)) 	
Parameters:
@MenuCode148[String] = SupplyList
@EWFormDataCode149[Int32] = 4
@EWFormDataCode150[Int32] = 9
@EWFormDataCode151[Int32] = 10
@EWFormDataCode152[Int32] = 11
@EWFormDataCode153[Int32] = 13
@EWFormDataCode154[Int32] = 14
@EWFormDataCode155[Int32] = 15
@EWFormDataCode156[Int32] = 17
@EWFormDataCode157[Int32] = 19
@EWFormDataCode158[Int32] = 5
@EWFormDataCode159[Int32] = 6
@EWFormDataCode160[Int32] = 7
@EWFormDataCode161[Int32] = 8
@EWFormDataCode162[Int32] = 16
@EWFormDataCode163[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:10:58
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:10:59
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 10:10:59
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:10:59
Text:	select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:10:59
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:11:02
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 10:11:02
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:11:02
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:11:02
Text:	select isnull(sum(inoi.PassCount),0) as FeedNum from TbInOrder ino
                           left join TbInOrderItem inoi on ino.InOrderCode=inoi.InOrderCode
                           where ino.Examinestatus='审核完成' and inoi.ChackState=1
                           and (ISNULL(@BegTime,'')='' or ino.InsertTime>=CONVERT(varchar,@BegTime,101)) 
                           and (ISNULL(@EndTime,'')='' or ino.InsertTime<=@EndTime)
                           and (ISNULL(@MaterialName,'')='' or inoi.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or inoi.SpecificationModel like '%'+@SpecificationModel+'%')
                           and (ISNULL(@ProjectId,'')='' or ino.ProjectId=@ProjectId)
                            
                           union all
                           select isnull(sum(rmpmp.WeightSmallPlanN),0) as YLNum from TbRMProductionMaterial rmpm
                           left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
                           left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
                           left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
                           where rmpm.Examinestatus='审核完成'
                           and rmpmp.RMTypeName='余料' 
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            
                           and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
                           union all
                           select sum(Tb.RawMaterialNum) as RawMaterialNum from (select isnull(sum(rmpmp.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterial rmpm
						   left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
						   left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
						   left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
						   where  rmpm.Examinestatus='审核完成'
						   and rmpmp.RMTypeName='原材料' 
						   and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
						   union all
						   select isnull(sum(rpmd.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterialDetail rpmd 
						   left join TbRMProductionMaterial rpm on rpmd.CollarCode=rpm.CollarCode
						   where  rpm.Examinestatus='审核完成'
						   and rpmd.WorkOrderItemId not in(select WorkOrderItemId from TbRMProductionMaterialPlan)
						   and (ISNULL(@BegTime,'')='' or rpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rpmd.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rpmd.SpecificationModel like '%'+@SpecificationModel+'%')) Tb	
Parameters:
@BegTime[DateTime] = 
@EndTime[DateTime] = 
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:11:03
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:11:30
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:12:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:12:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:13:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:14:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:14:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:15:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:15:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode164) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode165,@EWFormDataCode166,@EWFormDataCode167,@EWFormDataCode168,@EWFormDataCode169,@EWFormDataCode170,@EWFormDataCode171,@EWFormDataCode172,@EWFormDataCode173,@EWFormDataCode174,@EWFormDataCode175,@EWFormDataCode176,@EWFormDataCode177,@EWFormDataCode178,@EWFormDataCode179)) 	
Parameters:
@MenuCode164[String] = SupplyList
@EWFormDataCode165[Int32] = 4
@EWFormDataCode166[Int32] = 9
@EWFormDataCode167[Int32] = 10
@EWFormDataCode168[Int32] = 11
@EWFormDataCode169[Int32] = 13
@EWFormDataCode170[Int32] = 14
@EWFormDataCode171[Int32] = 15
@EWFormDataCode172[Int32] = 17
@EWFormDataCode173[Int32] = 19
@EWFormDataCode174[Int32] = 5
@EWFormDataCode175[Int32] = 6
@EWFormDataCode176[Int32] = 7
@EWFormDataCode177[Int32] = 8
@EWFormDataCode178[Int32] = 16
@EWFormDataCode179[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:16:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:16:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:16:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:18:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:18:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:19:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:20:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:20:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:20:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode180) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode181,@EWFormDataCode182,@EWFormDataCode183,@EWFormDataCode184,@EWFormDataCode185,@EWFormDataCode186,@EWFormDataCode187,@EWFormDataCode188,@EWFormDataCode189,@EWFormDataCode190,@EWFormDataCode191,@EWFormDataCode192,@EWFormDataCode193,@EWFormDataCode194,@EWFormDataCode195)) 	
Parameters:
@MenuCode180[String] = SupplyList
@EWFormDataCode181[Int32] = 4
@EWFormDataCode182[Int32] = 9
@EWFormDataCode183[Int32] = 10
@EWFormDataCode184[Int32] = 11
@EWFormDataCode185[Int32] = 13
@EWFormDataCode186[Int32] = 14
@EWFormDataCode187[Int32] = 15
@EWFormDataCode188[Int32] = 17
@EWFormDataCode189[Int32] = 19
@EWFormDataCode190[Int32] = 5
@EWFormDataCode191[Int32] = 6
@EWFormDataCode192[Int32] = 7
@EWFormDataCode193[Int32] = 8
@EWFormDataCode194[Int32] = 16
@EWFormDataCode195[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:20:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:22:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:22:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:22:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:24:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:24:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:25:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:25:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:25:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode196) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode197,@EWFormDataCode198,@EWFormDataCode199,@EWFormDataCode200,@EWFormDataCode201,@EWFormDataCode202,@EWFormDataCode203,@EWFormDataCode204,@EWFormDataCode205,@EWFormDataCode206,@EWFormDataCode207,@EWFormDataCode208,@EWFormDataCode209,@EWFormDataCode210,@EWFormDataCode211)) 	
Parameters:
@MenuCode196[String] = SupplyList
@EWFormDataCode197[Int32] = 4
@EWFormDataCode198[Int32] = 9
@EWFormDataCode199[Int32] = 10
@EWFormDataCode200[Int32] = 11
@EWFormDataCode201[Int32] = 13
@EWFormDataCode202[Int32] = 14
@EWFormDataCode203[Int32] = 15
@EWFormDataCode204[Int32] = 17
@EWFormDataCode205[Int32] = 19
@EWFormDataCode206[Int32] = 5
@EWFormDataCode207[Int32] = 6
@EWFormDataCode208[Int32] = 7
@EWFormDataCode209[Int32] = 8
@EWFormDataCode210[Int32] = 16
@EWFormDataCode211[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:26:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:26:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:27:24
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 10:27:24
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:27:24
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:27:24
Text:	select isnull(sum(inoi.PassCount),0) as FeedNum from TbInOrder ino
                           left join TbInOrderItem inoi on ino.InOrderCode=inoi.InOrderCode
                           where ino.Examinestatus='审核完成' and inoi.ChackState=1
                           and (ISNULL(@BegTime,'')='' or ino.InsertTime>=CONVERT(varchar,@BegTime,101)) 
                           and (ISNULL(@EndTime,'')='' or ino.InsertTime<=@EndTime)
                           and (ISNULL(@MaterialName,'')='' or inoi.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or inoi.SpecificationModel like '%'+@SpecificationModel+'%')
                           and (ISNULL(@ProjectId,'')='' or ino.ProjectId=@ProjectId)
                            
                           union all
                           select isnull(sum(rmpmp.WeightSmallPlanN),0) as YLNum from TbRMProductionMaterial rmpm
                           left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
                           left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
                           left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
                           where rmpm.Examinestatus='审核完成'
                           and rmpmp.RMTypeName='余料' 
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            
                           and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
                           union all
                           select sum(Tb.RawMaterialNum) as RawMaterialNum from (select isnull(sum(rmpmp.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterial rmpm
						   left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
						   left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
						   left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
						   where  rmpm.Examinestatus='审核完成'
						   and rmpmp.RMTypeName='原材料' 
						   and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
						   union all
						   select isnull(sum(rpmd.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterialDetail rpmd 
						   left join TbRMProductionMaterial rpm on rpmd.CollarCode=rpm.CollarCode
						   where  rpm.Examinestatus='审核完成'
						   and rpmd.WorkOrderItemId not in(select WorkOrderItemId from TbRMProductionMaterialPlan)
						   and (ISNULL(@BegTime,'')='' or rpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rpmd.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rpmd.SpecificationModel like '%'+@SpecificationModel+'%')) Tb	
Parameters:
@BegTime[DateTime] = 
@EndTime[DateTime] = 
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:27:25
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:28:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:28:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:28:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:30:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:30:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:30:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode212) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode213,@EWFormDataCode214,@EWFormDataCode215,@EWFormDataCode216,@EWFormDataCode217,@EWFormDataCode218,@EWFormDataCode219,@EWFormDataCode220,@EWFormDataCode221,@EWFormDataCode222,@EWFormDataCode223,@EWFormDataCode224,@EWFormDataCode225,@EWFormDataCode226,@EWFormDataCode227)) 	
Parameters:
@MenuCode212[String] = SupplyList
@EWFormDataCode213[Int32] = 4
@EWFormDataCode214[Int32] = 9
@EWFormDataCode215[Int32] = 10
@EWFormDataCode216[Int32] = 11
@EWFormDataCode217[Int32] = 13
@EWFormDataCode218[Int32] = 14
@EWFormDataCode219[Int32] = 15
@EWFormDataCode220[Int32] = 17
@EWFormDataCode221[Int32] = 19
@EWFormDataCode222[Int32] = 5
@EWFormDataCode223[Int32] = 6
@EWFormDataCode224[Int32] = 7
@EWFormDataCode225[Int32] = 8
@EWFormDataCode226[Int32] = 16
@EWFormDataCode227[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:30:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:31:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:32:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:32:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:34:08
Text:	select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1 	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 2019
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:34:08
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1 ) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 2019
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:34:08
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1 	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 2019
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 10:34:18
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 10:34:18
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 10:34:18
Text:	select Tb1.*,isnull(dhrk.PassCount,0) as AcceptanceQuantity,isnull(yclll.WeightSmallPlanN,0) as WeightSmallPlan,(isnull(yclll.WeightSmallPlanN,0)-ISNULL(yclll.WeightSmallPlan,0)-isnull(ylk.yll,0)) as Loss,(isnull(Tb1.InitialCount,0)+isnull(dhrk.PassCount,0)-isnull(yclll.WeightSmallPlanN,0)) as RawMaterialStockQuantity,isnull(yclll.WeightSmallPlan,0) as ComponentStockQuantity,isnull(flk.StartAddUpHandleQuantity,0) as StartAddUpHandleQuantity,isnull(flk.UntreatedQuantity,0) as UntreatedQuantity from (select tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText as MeasurementUnitName,sum(tb.Count) as InitialCount from TbRawMaterialStockRecord tb
                           left join TbRawMaterialArchives rma on tb.MaterialCode=rma.MaterialCode
                           left join TbSysDictionaryData sdd on rma.MeasurementUnit=sdd.DictionaryCode
                           left join TbStorage s on s.StorageCode=tb.StorageCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId)
                           and tb.ChackState=1 
                           and (ISNULL(@MaterialNames,'')='' or tb.MaterialName=@MaterialNames) 
                           and (ISNULL(@SpecificationModel,'')='' or tb.SpecificationModel like '%'+@SpecificationModel+'%')   
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText) Tb1

                           left join (select inoi.MaterialCode,isnull(sum(inoi.PassCount),0) as PassCount from TbInOrder tb
                           left join TbInOrderItem inoi on tb.InOrderCode=inoi.InOrderCode 
                           left join TbFactoryBatchNeedPlan fbnp on tb.BatchPlanCode=fbnp.BatchPlanNum
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbnp.ProcessFactoryCode=@ProcessFactoryCode) 
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by inoi.MaterialCode) as dhrk on Tb1.MaterialCode=dhrk.MaterialCode

                           left join(select rpmd.MaterialCode,SUM(rpmd.WeightSmallPlan) as WeightSmallPlan,sum(rpmd.WeightSmallPlanN) as WeightSmallPlanN from TbRMProductionMaterial tb
                           left join TbRMProductionMaterialDetail rpmd on tb.CollarCode=rpmd.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or tb.ProcessFactoryCode=@ProcessFactoryCode)  
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by rpmd.MaterialCode) as yclll on Tb1.MaterialCode=yclll.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.WeightYes) as StartAddUpHandleQuantity,SUM(tb.WeightNot) as UntreatedQuantity from TbRubbishStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as flk on flk.MaterialCode=Tb1.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.Weight) as yll from TbCloutStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
						   and tb.SiteCode!='-1'
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as ylk on ylk.MaterialCode=Tb1.MaterialCode	
Parameters:
@ProjectId[String] = 6245721945602523136
@MaterialNames[String] = 
@SpecificationModel[String] = 
@ProcessFactoryCode[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:34:18
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select Tb1.*,isnull(dhrk.PassCount,0) as AcceptanceQuantity,isnull(yclll.WeightSmallPlanN,0) as WeightSmallPlan,(isnull(yclll.WeightSmallPlanN,0)-ISNULL(yclll.WeightSmallPlan,0)-isnull(ylk.yll,0)) as Loss,(isnull(Tb1.InitialCount,0)+isnull(dhrk.PassCount,0)-isnull(yclll.WeightSmallPlanN,0)) as RawMaterialStockQuantity,isnull(yclll.WeightSmallPlan,0) as ComponentStockQuantity,isnull(flk.StartAddUpHandleQuantity,0) as StartAddUpHandleQuantity,isnull(flk.UntreatedQuantity,0) as UntreatedQuantity from (select tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText as MeasurementUnitName,sum(tb.Count) as InitialCount from TbRawMaterialStockRecord tb
                           left join TbRawMaterialArchives rma on tb.MaterialCode=rma.MaterialCode
                           left join TbSysDictionaryData sdd on rma.MeasurementUnit=sdd.DictionaryCode
                           left join TbStorage s on s.StorageCode=tb.StorageCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId)
                           and tb.ChackState=1 
                           and (ISNULL(@MaterialNames,'')='' or tb.MaterialName=@MaterialNames) 
                           and (ISNULL(@SpecificationModel,'')='' or tb.SpecificationModel like '%'+@SpecificationModel+'%')   
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by tb.MaterialCode,tb.MaterialName,tb.SpecificationModel,sdd.DictionaryText) Tb1

                           left join (select inoi.MaterialCode,isnull(sum(inoi.PassCount),0) as PassCount from TbInOrder tb
                           left join TbInOrderItem inoi on tb.InOrderCode=inoi.InOrderCode 
                           left join TbFactoryBatchNeedPlan fbnp on tb.BatchPlanCode=fbnp.BatchPlanNum
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbnp.ProcessFactoryCode=@ProcessFactoryCode) 
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by inoi.MaterialCode) as dhrk on Tb1.MaterialCode=dhrk.MaterialCode

                           left join(select rpmd.MaterialCode,SUM(rpmd.WeightSmallPlan) as WeightSmallPlan,sum(rpmd.WeightSmallPlanN) as WeightSmallPlanN from TbRMProductionMaterial tb
                           left join TbRMProductionMaterialDetail rpmd on tb.CollarCode=rpmd.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or tb.ProcessFactoryCode=@ProcessFactoryCode)  
                             and (tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or tb.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           group by rpmd.MaterialCode) as yclll on Tb1.MaterialCode=yclll.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.WeightYes) as StartAddUpHandleQuantity,SUM(tb.WeightNot) as UntreatedQuantity from TbRubbishStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as flk on flk.MaterialCode=Tb1.MaterialCode

                           left join (select tb.MaterialCode,SUM(tb.Weight) as yll from TbCloutStock tb 
                           left join TbRMProductionMaterial rm on tb.CollarCode=rm.CollarCode
                           where 1=1 and (ISNULL(@ProjectId,'')='' or tb.ProjectId=@ProjectId) 
                           and (ISNULL(@ProcessFactoryCode,'')='' or rm.ProcessFactoryCode=@ProcessFactoryCode)  
						   and tb.SiteCode!='-1'
                             and tb.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') 
                           group by tb.MaterialCode) as ylk on ylk.MaterialCode=Tb1.MaterialCode) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@MaterialNames[String] = 
@SpecificationModel[String] = 
@ProcessFactoryCode[String] = 


-----------------------------------------------------------------------------
2019-12-17 10:34:18
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:34:18
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:34:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:34:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:34:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:35:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:35:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode228) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode229,@EWFormDataCode230,@EWFormDataCode231,@EWFormDataCode232,@EWFormDataCode233,@EWFormDataCode234,@EWFormDataCode235,@EWFormDataCode236,@EWFormDataCode237,@EWFormDataCode238,@EWFormDataCode239,@EWFormDataCode240,@EWFormDataCode241,@EWFormDataCode242,@EWFormDataCode243)) 	
Parameters:
@MenuCode228[String] = SupplyList
@EWFormDataCode229[Int32] = 4
@EWFormDataCode230[Int32] = 9
@EWFormDataCode231[Int32] = 10
@EWFormDataCode232[Int32] = 11
@EWFormDataCode233[Int32] = 13
@EWFormDataCode234[Int32] = 14
@EWFormDataCode235[Int32] = 15
@EWFormDataCode236[Int32] = 17
@EWFormDataCode237[Int32] = 19
@EWFormDataCode238[Int32] = 5
@EWFormDataCode239[Int32] = 6
@EWFormDataCode240[Int32] = 7
@EWFormDataCode241[Int32] = 8
@EWFormDataCode242[Int32] = 16
@EWFormDataCode243[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:36:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:36:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:37:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:38:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:38:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:40:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:40:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:40:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:40:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode244) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode245,@EWFormDataCode246,@EWFormDataCode247,@EWFormDataCode248,@EWFormDataCode249,@EWFormDataCode250,@EWFormDataCode251,@EWFormDataCode252,@EWFormDataCode253,@EWFormDataCode254,@EWFormDataCode255,@EWFormDataCode256,@EWFormDataCode257,@EWFormDataCode258,@EWFormDataCode259)) 	
Parameters:
@MenuCode244[String] = SupplyList
@EWFormDataCode245[Int32] = 4
@EWFormDataCode246[Int32] = 9
@EWFormDataCode247[Int32] = 10
@EWFormDataCode248[Int32] = 11
@EWFormDataCode249[Int32] = 13
@EWFormDataCode250[Int32] = 14
@EWFormDataCode251[Int32] = 15
@EWFormDataCode252[Int32] = 17
@EWFormDataCode253[Int32] = 19
@EWFormDataCode254[Int32] = 5
@EWFormDataCode255[Int32] = 6
@EWFormDataCode256[Int32] = 7
@EWFormDataCode257[Int32] = 8
@EWFormDataCode258[Int32] = 16
@EWFormDataCode259[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:40:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:42:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:42:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:43:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:44:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:44:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:45:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:45:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode260) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode261,@EWFormDataCode262,@EWFormDataCode263,@EWFormDataCode264,@EWFormDataCode265,@EWFormDataCode266,@EWFormDataCode267,@EWFormDataCode268,@EWFormDataCode269,@EWFormDataCode270,@EWFormDataCode271,@EWFormDataCode272,@EWFormDataCode273,@EWFormDataCode274,@EWFormDataCode275)) 	
Parameters:
@MenuCode260[String] = SupplyList
@EWFormDataCode261[Int32] = 4
@EWFormDataCode262[Int32] = 9
@EWFormDataCode263[Int32] = 10
@EWFormDataCode264[Int32] = 11
@EWFormDataCode265[Int32] = 13
@EWFormDataCode266[Int32] = 14
@EWFormDataCode267[Int32] = 15
@EWFormDataCode268[Int32] = 17
@EWFormDataCode269[Int32] = 19
@EWFormDataCode270[Int32] = 5
@EWFormDataCode271[Int32] = 6
@EWFormDataCode272[Int32] = 7
@EWFormDataCode273[Int32] = 8
@EWFormDataCode274[Int32] = 16
@EWFormDataCode275[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:46:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:46:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:46:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:48:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:48:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:49:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:50:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:50:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:50:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode276) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode277,@EWFormDataCode278,@EWFormDataCode279,@EWFormDataCode280,@EWFormDataCode281,@EWFormDataCode282,@EWFormDataCode283,@EWFormDataCode284,@EWFormDataCode285,@EWFormDataCode286,@EWFormDataCode287,@EWFormDataCode288,@EWFormDataCode289,@EWFormDataCode290,@EWFormDataCode291)) 	
Parameters:
@MenuCode276[String] = SupplyList
@EWFormDataCode277[Int32] = 4
@EWFormDataCode278[Int32] = 9
@EWFormDataCode279[Int32] = 10
@EWFormDataCode280[Int32] = 11
@EWFormDataCode281[Int32] = 13
@EWFormDataCode282[Int32] = 14
@EWFormDataCode283[Int32] = 15
@EWFormDataCode284[Int32] = 17
@EWFormDataCode285[Int32] = 19
@EWFormDataCode286[Int32] = 5
@EWFormDataCode287[Int32] = 6
@EWFormDataCode288[Int32] = 7
@EWFormDataCode289[Int32] = 8
@EWFormDataCode290[Int32] = 16
@EWFormDataCode291[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:50:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:52:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:52:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:52:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:54:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:54:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:55:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 10:55:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 10:55:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode292) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode293,@EWFormDataCode294,@EWFormDataCode295,@EWFormDataCode296,@EWFormDataCode297,@EWFormDataCode298,@EWFormDataCode299,@EWFormDataCode300,@EWFormDataCode301,@EWFormDataCode302,@EWFormDataCode303,@EWFormDataCode304,@EWFormDataCode305,@EWFormDataCode306,@EWFormDataCode307)) 	
Parameters:
@MenuCode292[String] = SupplyList
@EWFormDataCode293[Int32] = 4
@EWFormDataCode294[Int32] = 9
@EWFormDataCode295[Int32] = 10
@EWFormDataCode296[Int32] = 11
@EWFormDataCode297[Int32] = 13
@EWFormDataCode298[Int32] = 14
@EWFormDataCode299[Int32] = 15
@EWFormDataCode300[Int32] = 17
@EWFormDataCode301[Int32] = 19
@EWFormDataCode302[Int32] = 5
@EWFormDataCode303[Int32] = 6
@EWFormDataCode304[Int32] = 7
@EWFormDataCode305[Int32] = 8
@EWFormDataCode306[Int32] = 16
@EWFormDataCode307[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 10:56:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:56:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 10:58:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 10:58:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 10:58:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:00:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:00:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:00:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode308) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode309,@EWFormDataCode310,@EWFormDataCode311,@EWFormDataCode312,@EWFormDataCode313,@EWFormDataCode314,@EWFormDataCode315,@EWFormDataCode316,@EWFormDataCode317,@EWFormDataCode318,@EWFormDataCode319,@EWFormDataCode320,@EWFormDataCode321,@EWFormDataCode322,@EWFormDataCode323)) 	
Parameters:
@MenuCode308[String] = SupplyList
@EWFormDataCode309[Int32] = 4
@EWFormDataCode310[Int32] = 9
@EWFormDataCode311[Int32] = 10
@EWFormDataCode312[Int32] = 11
@EWFormDataCode313[Int32] = 13
@EWFormDataCode314[Int32] = 14
@EWFormDataCode315[Int32] = 15
@EWFormDataCode316[Int32] = 17
@EWFormDataCode317[Int32] = 19
@EWFormDataCode318[Int32] = 5
@EWFormDataCode319[Int32] = 6
@EWFormDataCode320[Int32] = 7
@EWFormDataCode321[Int32] = 8
@EWFormDataCode322[Int32] = 16
@EWFormDataCode323[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:00:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:01:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:02:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:02:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:04:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:04:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:04:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:05:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:05:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode324) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode325,@EWFormDataCode326,@EWFormDataCode327,@EWFormDataCode328,@EWFormDataCode329,@EWFormDataCode330,@EWFormDataCode331,@EWFormDataCode332,@EWFormDataCode333,@EWFormDataCode334,@EWFormDataCode335,@EWFormDataCode336,@EWFormDataCode337,@EWFormDataCode338,@EWFormDataCode339)) 	
Parameters:
@MenuCode324[String] = SupplyList
@EWFormDataCode325[Int32] = 4
@EWFormDataCode326[Int32] = 9
@EWFormDataCode327[Int32] = 10
@EWFormDataCode328[Int32] = 11
@EWFormDataCode329[Int32] = 13
@EWFormDataCode330[Int32] = 14
@EWFormDataCode331[Int32] = 15
@EWFormDataCode332[Int32] = 17
@EWFormDataCode333[Int32] = 19
@EWFormDataCode334[Int32] = 5
@EWFormDataCode335[Int32] = 6
@EWFormDataCode336[Int32] = 7
@EWFormDataCode337[Int32] = 8
@EWFormDataCode338[Int32] = 16
@EWFormDataCode339[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:06:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:06:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:07:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:08:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:08:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:10:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:10:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:10:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:10:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode340) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode341,@EWFormDataCode342,@EWFormDataCode343,@EWFormDataCode344,@EWFormDataCode345,@EWFormDataCode346,@EWFormDataCode347,@EWFormDataCode348,@EWFormDataCode349,@EWFormDataCode350,@EWFormDataCode351,@EWFormDataCode352,@EWFormDataCode353,@EWFormDataCode354,@EWFormDataCode355)) 	
Parameters:
@MenuCode340[String] = SupplyList
@EWFormDataCode341[Int32] = 4
@EWFormDataCode342[Int32] = 9
@EWFormDataCode343[Int32] = 10
@EWFormDataCode344[Int32] = 11
@EWFormDataCode345[Int32] = 13
@EWFormDataCode346[Int32] = 14
@EWFormDataCode347[Int32] = 15
@EWFormDataCode348[Int32] = 17
@EWFormDataCode349[Int32] = 19
@EWFormDataCode350[Int32] = 5
@EWFormDataCode351[Int32] = 6
@EWFormDataCode352[Int32] = 7
@EWFormDataCode353[Int32] = 8
@EWFormDataCode354[Int32] = 16
@EWFormDataCode355[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:10:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:12:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:12:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:13:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:14:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:14:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:15:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:15:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode356) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode357,@EWFormDataCode358,@EWFormDataCode359,@EWFormDataCode360,@EWFormDataCode361,@EWFormDataCode362,@EWFormDataCode363,@EWFormDataCode364,@EWFormDataCode365,@EWFormDataCode366,@EWFormDataCode367,@EWFormDataCode368,@EWFormDataCode369,@EWFormDataCode370,@EWFormDataCode371)) 	
Parameters:
@MenuCode356[String] = SupplyList
@EWFormDataCode357[Int32] = 4
@EWFormDataCode358[Int32] = 9
@EWFormDataCode359[Int32] = 10
@EWFormDataCode360[Int32] = 11
@EWFormDataCode361[Int32] = 13
@EWFormDataCode362[Int32] = 14
@EWFormDataCode363[Int32] = 15
@EWFormDataCode364[Int32] = 17
@EWFormDataCode365[Int32] = 19
@EWFormDataCode366[Int32] = 5
@EWFormDataCode367[Int32] = 6
@EWFormDataCode368[Int32] = 7
@EWFormDataCode369[Int32] = 8
@EWFormDataCode370[Int32] = 16
@EWFormDataCode371[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:16:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:16:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:16:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:18:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:18:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:19:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:20:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:20:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:20:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode372) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode373,@EWFormDataCode374,@EWFormDataCode375,@EWFormDataCode376,@EWFormDataCode377,@EWFormDataCode378,@EWFormDataCode379,@EWFormDataCode380,@EWFormDataCode381,@EWFormDataCode382,@EWFormDataCode383,@EWFormDataCode384,@EWFormDataCode385,@EWFormDataCode386,@EWFormDataCode387)) 	
Parameters:
@MenuCode372[String] = SupplyList
@EWFormDataCode373[Int32] = 4
@EWFormDataCode374[Int32] = 9
@EWFormDataCode375[Int32] = 10
@EWFormDataCode376[Int32] = 11
@EWFormDataCode377[Int32] = 13
@EWFormDataCode378[Int32] = 14
@EWFormDataCode379[Int32] = 15
@EWFormDataCode380[Int32] = 17
@EWFormDataCode381[Int32] = 19
@EWFormDataCode382[Int32] = 5
@EWFormDataCode383[Int32] = 6
@EWFormDataCode384[Int32] = 7
@EWFormDataCode385[Int32] = 8
@EWFormDataCode386[Int32] = 16
@EWFormDataCode387[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:20:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:22:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:22:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:22:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:24:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:24:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:25:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:25:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:25:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode388) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode389,@EWFormDataCode390,@EWFormDataCode391,@EWFormDataCode392,@EWFormDataCode393,@EWFormDataCode394,@EWFormDataCode395,@EWFormDataCode396,@EWFormDataCode397,@EWFormDataCode398,@EWFormDataCode399,@EWFormDataCode400,@EWFormDataCode401,@EWFormDataCode402,@EWFormDataCode403)) 	
Parameters:
@MenuCode388[String] = SupplyList
@EWFormDataCode389[Int32] = 4
@EWFormDataCode390[Int32] = 9
@EWFormDataCode391[Int32] = 10
@EWFormDataCode392[Int32] = 11
@EWFormDataCode393[Int32] = 13
@EWFormDataCode394[Int32] = 14
@EWFormDataCode395[Int32] = 15
@EWFormDataCode396[Int32] = 17
@EWFormDataCode397[Int32] = 19
@EWFormDataCode398[Int32] = 5
@EWFormDataCode399[Int32] = 6
@EWFormDataCode400[Int32] = 7
@EWFormDataCode401[Int32] = 8
@EWFormDataCode402[Int32] = 16
@EWFormDataCode403[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:26:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:26:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:28:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:28:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:28:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:30:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:30:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:30:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode404) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode405,@EWFormDataCode406,@EWFormDataCode407,@EWFormDataCode408,@EWFormDataCode409,@EWFormDataCode410,@EWFormDataCode411,@EWFormDataCode412,@EWFormDataCode413,@EWFormDataCode414,@EWFormDataCode415,@EWFormDataCode416,@EWFormDataCode417,@EWFormDataCode418,@EWFormDataCode419)) 	
Parameters:
@MenuCode404[String] = SupplyList
@EWFormDataCode405[Int32] = 4
@EWFormDataCode406[Int32] = 9
@EWFormDataCode407[Int32] = 10
@EWFormDataCode408[Int32] = 11
@EWFormDataCode409[Int32] = 13
@EWFormDataCode410[Int32] = 14
@EWFormDataCode411[Int32] = 15
@EWFormDataCode412[Int32] = 17
@EWFormDataCode413[Int32] = 19
@EWFormDataCode414[Int32] = 5
@EWFormDataCode415[Int32] = 6
@EWFormDataCode416[Int32] = 7
@EWFormDataCode417[Int32] = 8
@EWFormDataCode418[Int32] = 16
@EWFormDataCode419[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:30:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:31:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:32:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:32:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:34:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:34:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:34:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:35:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:35:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode420) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode421,@EWFormDataCode422,@EWFormDataCode423,@EWFormDataCode424,@EWFormDataCode425,@EWFormDataCode426,@EWFormDataCode427,@EWFormDataCode428,@EWFormDataCode429,@EWFormDataCode430,@EWFormDataCode431,@EWFormDataCode432,@EWFormDataCode433,@EWFormDataCode434,@EWFormDataCode435)) 	
Parameters:
@MenuCode420[String] = SupplyList
@EWFormDataCode421[Int32] = 4
@EWFormDataCode422[Int32] = 9
@EWFormDataCode423[Int32] = 10
@EWFormDataCode424[Int32] = 11
@EWFormDataCode425[Int32] = 13
@EWFormDataCode426[Int32] = 14
@EWFormDataCode427[Int32] = 15
@EWFormDataCode428[Int32] = 17
@EWFormDataCode429[Int32] = 19
@EWFormDataCode430[Int32] = 5
@EWFormDataCode431[Int32] = 6
@EWFormDataCode432[Int32] = 7
@EWFormDataCode433[Int32] = 8
@EWFormDataCode434[Int32] = 16
@EWFormDataCode435[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:36:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:36:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:37:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:38:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:38:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:40:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:40:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:40:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:40:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode436) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode437,@EWFormDataCode438,@EWFormDataCode439,@EWFormDataCode440,@EWFormDataCode441,@EWFormDataCode442,@EWFormDataCode443,@EWFormDataCode444,@EWFormDataCode445,@EWFormDataCode446,@EWFormDataCode447,@EWFormDataCode448,@EWFormDataCode449,@EWFormDataCode450,@EWFormDataCode451)) 	
Parameters:
@MenuCode436[String] = SupplyList
@EWFormDataCode437[Int32] = 4
@EWFormDataCode438[Int32] = 9
@EWFormDataCode439[Int32] = 10
@EWFormDataCode440[Int32] = 11
@EWFormDataCode441[Int32] = 13
@EWFormDataCode442[Int32] = 14
@EWFormDataCode443[Int32] = 15
@EWFormDataCode444[Int32] = 17
@EWFormDataCode445[Int32] = 19
@EWFormDataCode446[Int32] = 5
@EWFormDataCode447[Int32] = 6
@EWFormDataCode448[Int32] = 7
@EWFormDataCode449[Int32] = 8
@EWFormDataCode450[Int32] = 16
@EWFormDataCode451[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:40:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:42:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:42:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:43:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:44:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:44:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:45:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:45:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode452) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode453,@EWFormDataCode454,@EWFormDataCode455,@EWFormDataCode456,@EWFormDataCode457,@EWFormDataCode458,@EWFormDataCode459,@EWFormDataCode460,@EWFormDataCode461,@EWFormDataCode462,@EWFormDataCode463,@EWFormDataCode464,@EWFormDataCode465,@EWFormDataCode466,@EWFormDataCode467)) 	
Parameters:
@MenuCode452[String] = SupplyList
@EWFormDataCode453[Int32] = 4
@EWFormDataCode454[Int32] = 9
@EWFormDataCode455[Int32] = 10
@EWFormDataCode456[Int32] = 11
@EWFormDataCode457[Int32] = 13
@EWFormDataCode458[Int32] = 14
@EWFormDataCode459[Int32] = 15
@EWFormDataCode460[Int32] = 17
@EWFormDataCode461[Int32] = 19
@EWFormDataCode462[Int32] = 5
@EWFormDataCode463[Int32] = 6
@EWFormDataCode464[Int32] = 7
@EWFormDataCode465[Int32] = 8
@EWFormDataCode466[Int32] = 16
@EWFormDataCode467[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:46:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:46:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:46:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:48:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:48:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:49:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:50:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:50:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:50:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode468) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode469,@EWFormDataCode470,@EWFormDataCode471,@EWFormDataCode472,@EWFormDataCode473,@EWFormDataCode474,@EWFormDataCode475,@EWFormDataCode476,@EWFormDataCode477,@EWFormDataCode478,@EWFormDataCode479,@EWFormDataCode480,@EWFormDataCode481,@EWFormDataCode482,@EWFormDataCode483)) 	
Parameters:
@MenuCode468[String] = SupplyList
@EWFormDataCode469[Int32] = 4
@EWFormDataCode470[Int32] = 9
@EWFormDataCode471[Int32] = 10
@EWFormDataCode472[Int32] = 11
@EWFormDataCode473[Int32] = 13
@EWFormDataCode474[Int32] = 14
@EWFormDataCode475[Int32] = 15
@EWFormDataCode476[Int32] = 17
@EWFormDataCode477[Int32] = 19
@EWFormDataCode478[Int32] = 5
@EWFormDataCode479[Int32] = 6
@EWFormDataCode480[Int32] = 7
@EWFormDataCode481[Int32] = 8
@EWFormDataCode482[Int32] = 16
@EWFormDataCode483[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:50:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:52:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:52:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:52:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:54:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:54:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:55:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 11:55:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 11:55:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode484) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode485,@EWFormDataCode486,@EWFormDataCode487,@EWFormDataCode488,@EWFormDataCode489,@EWFormDataCode490,@EWFormDataCode491,@EWFormDataCode492,@EWFormDataCode493,@EWFormDataCode494,@EWFormDataCode495,@EWFormDataCode496,@EWFormDataCode497,@EWFormDataCode498,@EWFormDataCode499)) 	
Parameters:
@MenuCode484[String] = SupplyList
@EWFormDataCode485[Int32] = 4
@EWFormDataCode486[Int32] = 9
@EWFormDataCode487[Int32] = 10
@EWFormDataCode488[Int32] = 11
@EWFormDataCode489[Int32] = 13
@EWFormDataCode490[Int32] = 14
@EWFormDataCode491[Int32] = 15
@EWFormDataCode492[Int32] = 17
@EWFormDataCode493[Int32] = 19
@EWFormDataCode494[Int32] = 5
@EWFormDataCode495[Int32] = 6
@EWFormDataCode496[Int32] = 7
@EWFormDataCode497[Int32] = 8
@EWFormDataCode498[Int32] = 16
@EWFormDataCode499[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 11:56:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:56:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 11:58:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 11:58:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 11:58:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:00:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:00:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:00:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode500) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode501,@EWFormDataCode502,@EWFormDataCode503,@EWFormDataCode504,@EWFormDataCode505,@EWFormDataCode506,@EWFormDataCode507,@EWFormDataCode508,@EWFormDataCode509,@EWFormDataCode510,@EWFormDataCode511,@EWFormDataCode512,@EWFormDataCode513,@EWFormDataCode514,@EWFormDataCode515)) 	
Parameters:
@MenuCode500[String] = SupplyList
@EWFormDataCode501[Int32] = 4
@EWFormDataCode502[Int32] = 9
@EWFormDataCode503[Int32] = 10
@EWFormDataCode504[Int32] = 11
@EWFormDataCode505[Int32] = 13
@EWFormDataCode506[Int32] = 14
@EWFormDataCode507[Int32] = 15
@EWFormDataCode508[Int32] = 17
@EWFormDataCode509[Int32] = 19
@EWFormDataCode510[Int32] = 5
@EWFormDataCode511[Int32] = 6
@EWFormDataCode512[Int32] = 7
@EWFormDataCode513[Int32] = 8
@EWFormDataCode514[Int32] = 16
@EWFormDataCode515[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:00:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:01:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:02:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:02:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:04:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:04:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:04:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:05:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:05:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode516) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode517,@EWFormDataCode518,@EWFormDataCode519,@EWFormDataCode520,@EWFormDataCode521,@EWFormDataCode522,@EWFormDataCode523,@EWFormDataCode524,@EWFormDataCode525,@EWFormDataCode526,@EWFormDataCode527,@EWFormDataCode528,@EWFormDataCode529,@EWFormDataCode530,@EWFormDataCode531)) 	
Parameters:
@MenuCode516[String] = SupplyList
@EWFormDataCode517[Int32] = 4
@EWFormDataCode518[Int32] = 9
@EWFormDataCode519[Int32] = 10
@EWFormDataCode520[Int32] = 11
@EWFormDataCode521[Int32] = 13
@EWFormDataCode522[Int32] = 14
@EWFormDataCode523[Int32] = 15
@EWFormDataCode524[Int32] = 17
@EWFormDataCode525[Int32] = 19
@EWFormDataCode526[Int32] = 5
@EWFormDataCode527[Int32] = 6
@EWFormDataCode528[Int32] = 7
@EWFormDataCode529[Int32] = 8
@EWFormDataCode530[Int32] = 16
@EWFormDataCode531[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:06:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:06:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:07:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:08:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:08:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:10:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:10:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:10:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:10:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode532) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode533,@EWFormDataCode534,@EWFormDataCode535,@EWFormDataCode536,@EWFormDataCode537,@EWFormDataCode538,@EWFormDataCode539,@EWFormDataCode540,@EWFormDataCode541,@EWFormDataCode542,@EWFormDataCode543,@EWFormDataCode544,@EWFormDataCode545,@EWFormDataCode546,@EWFormDataCode547)) 	
Parameters:
@MenuCode532[String] = SupplyList
@EWFormDataCode533[Int32] = 4
@EWFormDataCode534[Int32] = 9
@EWFormDataCode535[Int32] = 10
@EWFormDataCode536[Int32] = 11
@EWFormDataCode537[Int32] = 13
@EWFormDataCode538[Int32] = 14
@EWFormDataCode539[Int32] = 15
@EWFormDataCode540[Int32] = 17
@EWFormDataCode541[Int32] = 19
@EWFormDataCode542[Int32] = 5
@EWFormDataCode543[Int32] = 6
@EWFormDataCode544[Int32] = 7
@EWFormDataCode545[Int32] = 8
@EWFormDataCode546[Int32] = 16
@EWFormDataCode547[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:10:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:12:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:12:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:13:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:14:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:14:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:15:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:15:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode548) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode549,@EWFormDataCode550,@EWFormDataCode551,@EWFormDataCode552,@EWFormDataCode553,@EWFormDataCode554,@EWFormDataCode555,@EWFormDataCode556,@EWFormDataCode557,@EWFormDataCode558,@EWFormDataCode559,@EWFormDataCode560,@EWFormDataCode561,@EWFormDataCode562,@EWFormDataCode563)) 	
Parameters:
@MenuCode548[String] = SupplyList
@EWFormDataCode549[Int32] = 4
@EWFormDataCode550[Int32] = 9
@EWFormDataCode551[Int32] = 10
@EWFormDataCode552[Int32] = 11
@EWFormDataCode553[Int32] = 13
@EWFormDataCode554[Int32] = 14
@EWFormDataCode555[Int32] = 15
@EWFormDataCode556[Int32] = 17
@EWFormDataCode557[Int32] = 19
@EWFormDataCode558[Int32] = 5
@EWFormDataCode559[Int32] = 6
@EWFormDataCode560[Int32] = 7
@EWFormDataCode561[Int32] = 8
@EWFormDataCode562[Int32] = 16
@EWFormDataCode563[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:16:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:16:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:16:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:18:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:18:58
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:19:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:20:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:20:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:20:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode564) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode565,@EWFormDataCode566,@EWFormDataCode567,@EWFormDataCode568,@EWFormDataCode569,@EWFormDataCode570,@EWFormDataCode571,@EWFormDataCode572,@EWFormDataCode573,@EWFormDataCode574,@EWFormDataCode575,@EWFormDataCode576,@EWFormDataCode577,@EWFormDataCode578,@EWFormDataCode579)) 	
Parameters:
@MenuCode564[String] = SupplyList
@EWFormDataCode565[Int32] = 4
@EWFormDataCode566[Int32] = 9
@EWFormDataCode567[Int32] = 10
@EWFormDataCode568[Int32] = 11
@EWFormDataCode569[Int32] = 13
@EWFormDataCode570[Int32] = 14
@EWFormDataCode571[Int32] = 15
@EWFormDataCode572[Int32] = 17
@EWFormDataCode573[Int32] = 19
@EWFormDataCode574[Int32] = 5
@EWFormDataCode575[Int32] = 6
@EWFormDataCode576[Int32] = 7
@EWFormDataCode577[Int32] = 8
@EWFormDataCode578[Int32] = 16
@EWFormDataCode579[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:20:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:22:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:22:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:22:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:24:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:24:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:25:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:25:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:25:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode580) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode581,@EWFormDataCode582,@EWFormDataCode583,@EWFormDataCode584,@EWFormDataCode585,@EWFormDataCode586,@EWFormDataCode587,@EWFormDataCode588,@EWFormDataCode589,@EWFormDataCode590,@EWFormDataCode591,@EWFormDataCode592,@EWFormDataCode593,@EWFormDataCode594,@EWFormDataCode595)) 	
Parameters:
@MenuCode580[String] = SupplyList
@EWFormDataCode581[Int32] = 4
@EWFormDataCode582[Int32] = 9
@EWFormDataCode583[Int32] = 10
@EWFormDataCode584[Int32] = 11
@EWFormDataCode585[Int32] = 13
@EWFormDataCode586[Int32] = 14
@EWFormDataCode587[Int32] = 15
@EWFormDataCode588[Int32] = 17
@EWFormDataCode589[Int32] = 19
@EWFormDataCode590[Int32] = 5
@EWFormDataCode591[Int32] = 6
@EWFormDataCode592[Int32] = 7
@EWFormDataCode593[Int32] = 8
@EWFormDataCode594[Int32] = 16
@EWFormDataCode595[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:26:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:26:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:28:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:28:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:28:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:30:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:30:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:30:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode596) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode597,@EWFormDataCode598,@EWFormDataCode599,@EWFormDataCode600,@EWFormDataCode601,@EWFormDataCode602,@EWFormDataCode603,@EWFormDataCode604,@EWFormDataCode605,@EWFormDataCode606,@EWFormDataCode607,@EWFormDataCode608,@EWFormDataCode609,@EWFormDataCode610,@EWFormDataCode611)) 	
Parameters:
@MenuCode596[String] = SupplyList
@EWFormDataCode597[Int32] = 4
@EWFormDataCode598[Int32] = 9
@EWFormDataCode599[Int32] = 10
@EWFormDataCode600[Int32] = 11
@EWFormDataCode601[Int32] = 13
@EWFormDataCode602[Int32] = 14
@EWFormDataCode603[Int32] = 15
@EWFormDataCode604[Int32] = 17
@EWFormDataCode605[Int32] = 19
@EWFormDataCode606[Int32] = 5
@EWFormDataCode607[Int32] = 6
@EWFormDataCode608[Int32] = 7
@EWFormDataCode609[Int32] = 8
@EWFormDataCode610[Int32] = 16
@EWFormDataCode611[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:30:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:31:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:32:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:32:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:34:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:34:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:34:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:35:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:35:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode612) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode613,@EWFormDataCode614,@EWFormDataCode615,@EWFormDataCode616,@EWFormDataCode617,@EWFormDataCode618,@EWFormDataCode619,@EWFormDataCode620,@EWFormDataCode621,@EWFormDataCode622,@EWFormDataCode623,@EWFormDataCode624,@EWFormDataCode625,@EWFormDataCode626,@EWFormDataCode627)) 	
Parameters:
@MenuCode612[String] = SupplyList
@EWFormDataCode613[Int32] = 4
@EWFormDataCode614[Int32] = 9
@EWFormDataCode615[Int32] = 10
@EWFormDataCode616[Int32] = 11
@EWFormDataCode617[Int32] = 13
@EWFormDataCode618[Int32] = 14
@EWFormDataCode619[Int32] = 15
@EWFormDataCode620[Int32] = 17
@EWFormDataCode621[Int32] = 19
@EWFormDataCode622[Int32] = 5
@EWFormDataCode623[Int32] = 6
@EWFormDataCode624[Int32] = 7
@EWFormDataCode625[Int32] = 8
@EWFormDataCode626[Int32] = 16
@EWFormDataCode627[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:36:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:36:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:37:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:38:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:38:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:40:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:40:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:40:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:40:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode628) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode629,@EWFormDataCode630,@EWFormDataCode631,@EWFormDataCode632,@EWFormDataCode633,@EWFormDataCode634,@EWFormDataCode635,@EWFormDataCode636,@EWFormDataCode637,@EWFormDataCode638,@EWFormDataCode639,@EWFormDataCode640,@EWFormDataCode641,@EWFormDataCode642,@EWFormDataCode643)) 	
Parameters:
@MenuCode628[String] = SupplyList
@EWFormDataCode629[Int32] = 4
@EWFormDataCode630[Int32] = 9
@EWFormDataCode631[Int32] = 10
@EWFormDataCode632[Int32] = 11
@EWFormDataCode633[Int32] = 13
@EWFormDataCode634[Int32] = 14
@EWFormDataCode635[Int32] = 15
@EWFormDataCode636[Int32] = 17
@EWFormDataCode637[Int32] = 19
@EWFormDataCode638[Int32] = 5
@EWFormDataCode639[Int32] = 6
@EWFormDataCode640[Int32] = 7
@EWFormDataCode641[Int32] = 8
@EWFormDataCode642[Int32] = 16
@EWFormDataCode643[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:40:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:42:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:42:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:43:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:44:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:44:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:45:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:45:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode644) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode645,@EWFormDataCode646,@EWFormDataCode647,@EWFormDataCode648,@EWFormDataCode649,@EWFormDataCode650,@EWFormDataCode651,@EWFormDataCode652,@EWFormDataCode653,@EWFormDataCode654,@EWFormDataCode655,@EWFormDataCode656,@EWFormDataCode657,@EWFormDataCode658,@EWFormDataCode659)) 	
Parameters:
@MenuCode644[String] = SupplyList
@EWFormDataCode645[Int32] = 4
@EWFormDataCode646[Int32] = 9
@EWFormDataCode647[Int32] = 10
@EWFormDataCode648[Int32] = 11
@EWFormDataCode649[Int32] = 13
@EWFormDataCode650[Int32] = 14
@EWFormDataCode651[Int32] = 15
@EWFormDataCode652[Int32] = 17
@EWFormDataCode653[Int32] = 19
@EWFormDataCode654[Int32] = 5
@EWFormDataCode655[Int32] = 6
@EWFormDataCode656[Int32] = 7
@EWFormDataCode657[Int32] = 8
@EWFormDataCode658[Int32] = 16
@EWFormDataCode659[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:46:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:46:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:46:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:48:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:48:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:49:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:50:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:50:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:50:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode660) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode661,@EWFormDataCode662,@EWFormDataCode663,@EWFormDataCode664,@EWFormDataCode665,@EWFormDataCode666,@EWFormDataCode667,@EWFormDataCode668,@EWFormDataCode669,@EWFormDataCode670,@EWFormDataCode671,@EWFormDataCode672,@EWFormDataCode673,@EWFormDataCode674,@EWFormDataCode675)) 	
Parameters:
@MenuCode660[String] = SupplyList
@EWFormDataCode661[Int32] = 4
@EWFormDataCode662[Int32] = 9
@EWFormDataCode663[Int32] = 10
@EWFormDataCode664[Int32] = 11
@EWFormDataCode665[Int32] = 13
@EWFormDataCode666[Int32] = 14
@EWFormDataCode667[Int32] = 15
@EWFormDataCode668[Int32] = 17
@EWFormDataCode669[Int32] = 19
@EWFormDataCode670[Int32] = 5
@EWFormDataCode671[Int32] = 6
@EWFormDataCode672[Int32] = 7
@EWFormDataCode673[Int32] = 8
@EWFormDataCode674[Int32] = 16
@EWFormDataCode675[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:50:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:52:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:52:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:52:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:54:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:54:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:55:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 12:55:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 12:55:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode676) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode677,@EWFormDataCode678,@EWFormDataCode679,@EWFormDataCode680,@EWFormDataCode681,@EWFormDataCode682,@EWFormDataCode683,@EWFormDataCode684,@EWFormDataCode685,@EWFormDataCode686,@EWFormDataCode687,@EWFormDataCode688,@EWFormDataCode689,@EWFormDataCode690,@EWFormDataCode691)) 	
Parameters:
@MenuCode676[String] = SupplyList
@EWFormDataCode677[Int32] = 4
@EWFormDataCode678[Int32] = 9
@EWFormDataCode679[Int32] = 10
@EWFormDataCode680[Int32] = 11
@EWFormDataCode681[Int32] = 13
@EWFormDataCode682[Int32] = 14
@EWFormDataCode683[Int32] = 15
@EWFormDataCode684[Int32] = 17
@EWFormDataCode685[Int32] = 19
@EWFormDataCode686[Int32] = 5
@EWFormDataCode687[Int32] = 6
@EWFormDataCode688[Int32] = 7
@EWFormDataCode689[Int32] = 8
@EWFormDataCode690[Int32] = 16
@EWFormDataCode691[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 12:56:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:56:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 12:58:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 12:58:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 12:58:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:00:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:00:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:00:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode692) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode693,@EWFormDataCode694,@EWFormDataCode695,@EWFormDataCode696,@EWFormDataCode697,@EWFormDataCode698,@EWFormDataCode699,@EWFormDataCode700,@EWFormDataCode701,@EWFormDataCode702,@EWFormDataCode703,@EWFormDataCode704,@EWFormDataCode705,@EWFormDataCode706,@EWFormDataCode707)) 	
Parameters:
@MenuCode692[String] = SupplyList
@EWFormDataCode693[Int32] = 4
@EWFormDataCode694[Int32] = 9
@EWFormDataCode695[Int32] = 10
@EWFormDataCode696[Int32] = 11
@EWFormDataCode697[Int32] = 13
@EWFormDataCode698[Int32] = 14
@EWFormDataCode699[Int32] = 15
@EWFormDataCode700[Int32] = 17
@EWFormDataCode701[Int32] = 19
@EWFormDataCode702[Int32] = 5
@EWFormDataCode703[Int32] = 6
@EWFormDataCode704[Int32] = 7
@EWFormDataCode705[Int32] = 8
@EWFormDataCode706[Int32] = 16
@EWFormDataCode707[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:00:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:01:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:02:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:02:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:04:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:04:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:04:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:05:58
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:05:58
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode708) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode709,@EWFormDataCode710,@EWFormDataCode711,@EWFormDataCode712,@EWFormDataCode713,@EWFormDataCode714,@EWFormDataCode715,@EWFormDataCode716,@EWFormDataCode717,@EWFormDataCode718,@EWFormDataCode719,@EWFormDataCode720,@EWFormDataCode721,@EWFormDataCode722,@EWFormDataCode723)) 	
Parameters:
@MenuCode708[String] = SupplyList
@EWFormDataCode709[Int32] = 4
@EWFormDataCode710[Int32] = 9
@EWFormDataCode711[Int32] = 10
@EWFormDataCode712[Int32] = 11
@EWFormDataCode713[Int32] = 13
@EWFormDataCode714[Int32] = 14
@EWFormDataCode715[Int32] = 15
@EWFormDataCode716[Int32] = 17
@EWFormDataCode717[Int32] = 19
@EWFormDataCode718[Int32] = 5
@EWFormDataCode719[Int32] = 6
@EWFormDataCode720[Int32] = 7
@EWFormDataCode721[Int32] = 8
@EWFormDataCode722[Int32] = 16
@EWFormDataCode723[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:06:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:06:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:07:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:08:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:08:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:10:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:10:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:10:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:10:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode724) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode725,@EWFormDataCode726,@EWFormDataCode727,@EWFormDataCode728,@EWFormDataCode729,@EWFormDataCode730,@EWFormDataCode731,@EWFormDataCode732,@EWFormDataCode733,@EWFormDataCode734,@EWFormDataCode735,@EWFormDataCode736,@EWFormDataCode737,@EWFormDataCode738,@EWFormDataCode739)) 	
Parameters:
@MenuCode724[String] = SupplyList
@EWFormDataCode725[Int32] = 4
@EWFormDataCode726[Int32] = 9
@EWFormDataCode727[Int32] = 10
@EWFormDataCode728[Int32] = 11
@EWFormDataCode729[Int32] = 13
@EWFormDataCode730[Int32] = 14
@EWFormDataCode731[Int32] = 15
@EWFormDataCode732[Int32] = 17
@EWFormDataCode733[Int32] = 19
@EWFormDataCode734[Int32] = 5
@EWFormDataCode735[Int32] = 6
@EWFormDataCode736[Int32] = 7
@EWFormDataCode737[Int32] = 8
@EWFormDataCode738[Int32] = 16
@EWFormDataCode739[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:10:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:12:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:12:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:13:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:14:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:14:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:15:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:15:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode740) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode741,@EWFormDataCode742,@EWFormDataCode743,@EWFormDataCode744,@EWFormDataCode745,@EWFormDataCode746,@EWFormDataCode747,@EWFormDataCode748,@EWFormDataCode749,@EWFormDataCode750,@EWFormDataCode751,@EWFormDataCode752,@EWFormDataCode753,@EWFormDataCode754,@EWFormDataCode755)) 	
Parameters:
@MenuCode740[String] = SupplyList
@EWFormDataCode741[Int32] = 4
@EWFormDataCode742[Int32] = 9
@EWFormDataCode743[Int32] = 10
@EWFormDataCode744[Int32] = 11
@EWFormDataCode745[Int32] = 13
@EWFormDataCode746[Int32] = 14
@EWFormDataCode747[Int32] = 15
@EWFormDataCode748[Int32] = 17
@EWFormDataCode749[Int32] = 19
@EWFormDataCode750[Int32] = 5
@EWFormDataCode751[Int32] = 6
@EWFormDataCode752[Int32] = 7
@EWFormDataCode753[Int32] = 8
@EWFormDataCode754[Int32] = 16
@EWFormDataCode755[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:16:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:16:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:16:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:18:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:18:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:19:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:20:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:20:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:20:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode756) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode757,@EWFormDataCode758,@EWFormDataCode759,@EWFormDataCode760,@EWFormDataCode761,@EWFormDataCode762,@EWFormDataCode763,@EWFormDataCode764,@EWFormDataCode765,@EWFormDataCode766,@EWFormDataCode767,@EWFormDataCode768,@EWFormDataCode769,@EWFormDataCode770,@EWFormDataCode771)) 	
Parameters:
@MenuCode756[String] = SupplyList
@EWFormDataCode757[Int32] = 4
@EWFormDataCode758[Int32] = 9
@EWFormDataCode759[Int32] = 10
@EWFormDataCode760[Int32] = 11
@EWFormDataCode761[Int32] = 13
@EWFormDataCode762[Int32] = 14
@EWFormDataCode763[Int32] = 15
@EWFormDataCode764[Int32] = 17
@EWFormDataCode765[Int32] = 19
@EWFormDataCode766[Int32] = 5
@EWFormDataCode767[Int32] = 6
@EWFormDataCode768[Int32] = 7
@EWFormDataCode769[Int32] = 8
@EWFormDataCode770[Int32] = 16
@EWFormDataCode771[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:20:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:22:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:22:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:22:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:24:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:24:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:25:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:25:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:25:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode772) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode773,@EWFormDataCode774,@EWFormDataCode775,@EWFormDataCode776,@EWFormDataCode777,@EWFormDataCode778,@EWFormDataCode779,@EWFormDataCode780,@EWFormDataCode781,@EWFormDataCode782,@EWFormDataCode783,@EWFormDataCode784,@EWFormDataCode785,@EWFormDataCode786,@EWFormDataCode787)) 	
Parameters:
@MenuCode772[String] = SupplyList
@EWFormDataCode773[Int32] = 4
@EWFormDataCode774[Int32] = 9
@EWFormDataCode775[Int32] = 10
@EWFormDataCode776[Int32] = 11
@EWFormDataCode777[Int32] = 13
@EWFormDataCode778[Int32] = 14
@EWFormDataCode779[Int32] = 15
@EWFormDataCode780[Int32] = 17
@EWFormDataCode781[Int32] = 19
@EWFormDataCode782[Int32] = 5
@EWFormDataCode783[Int32] = 6
@EWFormDataCode784[Int32] = 7
@EWFormDataCode785[Int32] = 8
@EWFormDataCode786[Int32] = 16
@EWFormDataCode787[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:26:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:26:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:28:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:28:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:28:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:30:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:30:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:30:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode788) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode789,@EWFormDataCode790,@EWFormDataCode791,@EWFormDataCode792,@EWFormDataCode793,@EWFormDataCode794,@EWFormDataCode795,@EWFormDataCode796,@EWFormDataCode797,@EWFormDataCode798,@EWFormDataCode799,@EWFormDataCode800,@EWFormDataCode801,@EWFormDataCode802,@EWFormDataCode803)) 	
Parameters:
@MenuCode788[String] = SupplyList
@EWFormDataCode789[Int32] = 4
@EWFormDataCode790[Int32] = 9
@EWFormDataCode791[Int32] = 10
@EWFormDataCode792[Int32] = 11
@EWFormDataCode793[Int32] = 13
@EWFormDataCode794[Int32] = 14
@EWFormDataCode795[Int32] = 15
@EWFormDataCode796[Int32] = 17
@EWFormDataCode797[Int32] = 19
@EWFormDataCode798[Int32] = 5
@EWFormDataCode799[Int32] = 6
@EWFormDataCode800[Int32] = 7
@EWFormDataCode801[Int32] = 8
@EWFormDataCode802[Int32] = 16
@EWFormDataCode803[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:30:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:31:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:32:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:32:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:34:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:34:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:34:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:35:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:35:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode804) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode805,@EWFormDataCode806,@EWFormDataCode807,@EWFormDataCode808,@EWFormDataCode809,@EWFormDataCode810,@EWFormDataCode811,@EWFormDataCode812,@EWFormDataCode813,@EWFormDataCode814,@EWFormDataCode815,@EWFormDataCode816,@EWFormDataCode817,@EWFormDataCode818,@EWFormDataCode819)) 	
Parameters:
@MenuCode804[String] = SupplyList
@EWFormDataCode805[Int32] = 4
@EWFormDataCode806[Int32] = 9
@EWFormDataCode807[Int32] = 10
@EWFormDataCode808[Int32] = 11
@EWFormDataCode809[Int32] = 13
@EWFormDataCode810[Int32] = 14
@EWFormDataCode811[Int32] = 15
@EWFormDataCode812[Int32] = 17
@EWFormDataCode813[Int32] = 19
@EWFormDataCode814[Int32] = 5
@EWFormDataCode815[Int32] = 6
@EWFormDataCode816[Int32] = 7
@EWFormDataCode817[Int32] = 8
@EWFormDataCode818[Int32] = 16
@EWFormDataCode819[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:36:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:36:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:37:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:38:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:38:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:40:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:40:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:40:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:40:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode820) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode821,@EWFormDataCode822,@EWFormDataCode823,@EWFormDataCode824,@EWFormDataCode825,@EWFormDataCode826,@EWFormDataCode827,@EWFormDataCode828,@EWFormDataCode829,@EWFormDataCode830,@EWFormDataCode831,@EWFormDataCode832,@EWFormDataCode833,@EWFormDataCode834,@EWFormDataCode835)) 	
Parameters:
@MenuCode820[String] = SupplyList
@EWFormDataCode821[Int32] = 4
@EWFormDataCode822[Int32] = 9
@EWFormDataCode823[Int32] = 10
@EWFormDataCode824[Int32] = 11
@EWFormDataCode825[Int32] = 13
@EWFormDataCode826[Int32] = 14
@EWFormDataCode827[Int32] = 15
@EWFormDataCode828[Int32] = 17
@EWFormDataCode829[Int32] = 19
@EWFormDataCode830[Int32] = 5
@EWFormDataCode831[Int32] = 6
@EWFormDataCode832[Int32] = 7
@EWFormDataCode833[Int32] = 8
@EWFormDataCode834[Int32] = 16
@EWFormDataCode835[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:40:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:42:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:42:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:43:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:44:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:44:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:45:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:45:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode836) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode837,@EWFormDataCode838,@EWFormDataCode839,@EWFormDataCode840,@EWFormDataCode841,@EWFormDataCode842,@EWFormDataCode843,@EWFormDataCode844,@EWFormDataCode845,@EWFormDataCode846,@EWFormDataCode847,@EWFormDataCode848,@EWFormDataCode849,@EWFormDataCode850,@EWFormDataCode851)) 	
Parameters:
@MenuCode836[String] = SupplyList
@EWFormDataCode837[Int32] = 4
@EWFormDataCode838[Int32] = 9
@EWFormDataCode839[Int32] = 10
@EWFormDataCode840[Int32] = 11
@EWFormDataCode841[Int32] = 13
@EWFormDataCode842[Int32] = 14
@EWFormDataCode843[Int32] = 15
@EWFormDataCode844[Int32] = 17
@EWFormDataCode845[Int32] = 19
@EWFormDataCode846[Int32] = 5
@EWFormDataCode847[Int32] = 6
@EWFormDataCode848[Int32] = 7
@EWFormDataCode849[Int32] = 8
@EWFormDataCode850[Int32] = 16
@EWFormDataCode851[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:46:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:46:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:46:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:48:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:48:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:49:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:50:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:50:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:50:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode852) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode853,@EWFormDataCode854,@EWFormDataCode855,@EWFormDataCode856,@EWFormDataCode857,@EWFormDataCode858,@EWFormDataCode859,@EWFormDataCode860,@EWFormDataCode861,@EWFormDataCode862,@EWFormDataCode863,@EWFormDataCode864,@EWFormDataCode865,@EWFormDataCode866,@EWFormDataCode867)) 	
Parameters:
@MenuCode852[String] = SupplyList
@EWFormDataCode853[Int32] = 4
@EWFormDataCode854[Int32] = 9
@EWFormDataCode855[Int32] = 10
@EWFormDataCode856[Int32] = 11
@EWFormDataCode857[Int32] = 13
@EWFormDataCode858[Int32] = 14
@EWFormDataCode859[Int32] = 15
@EWFormDataCode860[Int32] = 17
@EWFormDataCode861[Int32] = 19
@EWFormDataCode862[Int32] = 5
@EWFormDataCode863[Int32] = 6
@EWFormDataCode864[Int32] = 7
@EWFormDataCode865[Int32] = 8
@EWFormDataCode866[Int32] = 16
@EWFormDataCode867[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:50:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:52:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:52:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:52:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:54:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:54:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:55:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 13:55:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 13:55:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode868) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode869,@EWFormDataCode870,@EWFormDataCode871,@EWFormDataCode872,@EWFormDataCode873,@EWFormDataCode874,@EWFormDataCode875,@EWFormDataCode876,@EWFormDataCode877,@EWFormDataCode878,@EWFormDataCode879,@EWFormDataCode880,@EWFormDataCode881,@EWFormDataCode882,@EWFormDataCode883)) 	
Parameters:
@MenuCode868[String] = SupplyList
@EWFormDataCode869[Int32] = 4
@EWFormDataCode870[Int32] = 9
@EWFormDataCode871[Int32] = 10
@EWFormDataCode872[Int32] = 11
@EWFormDataCode873[Int32] = 13
@EWFormDataCode874[Int32] = 14
@EWFormDataCode875[Int32] = 15
@EWFormDataCode876[Int32] = 17
@EWFormDataCode877[Int32] = 19
@EWFormDataCode878[Int32] = 5
@EWFormDataCode879[Int32] = 6
@EWFormDataCode880[Int32] = 7
@EWFormDataCode881[Int32] = 8
@EWFormDataCode882[Int32] = 16
@EWFormDataCode883[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 13:56:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:56:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 13:58:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 13:58:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 13:58:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:00:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:00:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:00:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode884) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode885,@EWFormDataCode886,@EWFormDataCode887,@EWFormDataCode888,@EWFormDataCode889,@EWFormDataCode890,@EWFormDataCode891,@EWFormDataCode892,@EWFormDataCode893,@EWFormDataCode894,@EWFormDataCode895,@EWFormDataCode896,@EWFormDataCode897,@EWFormDataCode898,@EWFormDataCode899)) 	
Parameters:
@MenuCode884[String] = SupplyList
@EWFormDataCode885[Int32] = 4
@EWFormDataCode886[Int32] = 9
@EWFormDataCode887[Int32] = 10
@EWFormDataCode888[Int32] = 11
@EWFormDataCode889[Int32] = 13
@EWFormDataCode890[Int32] = 14
@EWFormDataCode891[Int32] = 15
@EWFormDataCode892[Int32] = 17
@EWFormDataCode893[Int32] = 19
@EWFormDataCode894[Int32] = 5
@EWFormDataCode895[Int32] = 6
@EWFormDataCode896[Int32] = 7
@EWFormDataCode897[Int32] = 8
@EWFormDataCode898[Int32] = 16
@EWFormDataCode899[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:00:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:01:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:02:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:02:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:04:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:04:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:04:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:05:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:05:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode900) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode901,@EWFormDataCode902,@EWFormDataCode903,@EWFormDataCode904,@EWFormDataCode905,@EWFormDataCode906,@EWFormDataCode907,@EWFormDataCode908,@EWFormDataCode909,@EWFormDataCode910,@EWFormDataCode911,@EWFormDataCode912,@EWFormDataCode913,@EWFormDataCode914,@EWFormDataCode915)) 	
Parameters:
@MenuCode900[String] = SupplyList
@EWFormDataCode901[Int32] = 4
@EWFormDataCode902[Int32] = 9
@EWFormDataCode903[Int32] = 10
@EWFormDataCode904[Int32] = 11
@EWFormDataCode905[Int32] = 13
@EWFormDataCode906[Int32] = 14
@EWFormDataCode907[Int32] = 15
@EWFormDataCode908[Int32] = 17
@EWFormDataCode909[Int32] = 19
@EWFormDataCode910[Int32] = 5
@EWFormDataCode911[Int32] = 6
@EWFormDataCode912[Int32] = 7
@EWFormDataCode913[Int32] = 8
@EWFormDataCode914[Int32] = 16
@EWFormDataCode915[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:06:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:06:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:07:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:08:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:08:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:10:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:10:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:10:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:10:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode916) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode917,@EWFormDataCode918,@EWFormDataCode919,@EWFormDataCode920,@EWFormDataCode921,@EWFormDataCode922,@EWFormDataCode923,@EWFormDataCode924,@EWFormDataCode925,@EWFormDataCode926,@EWFormDataCode927,@EWFormDataCode928,@EWFormDataCode929,@EWFormDataCode930,@EWFormDataCode931)) 	
Parameters:
@MenuCode916[String] = SupplyList
@EWFormDataCode917[Int32] = 4
@EWFormDataCode918[Int32] = 9
@EWFormDataCode919[Int32] = 10
@EWFormDataCode920[Int32] = 11
@EWFormDataCode921[Int32] = 13
@EWFormDataCode922[Int32] = 14
@EWFormDataCode923[Int32] = 15
@EWFormDataCode924[Int32] = 17
@EWFormDataCode925[Int32] = 19
@EWFormDataCode926[Int32] = 5
@EWFormDataCode927[Int32] = 6
@EWFormDataCode928[Int32] = 7
@EWFormDataCode929[Int32] = 8
@EWFormDataCode930[Int32] = 16
@EWFormDataCode931[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:10:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:12:58
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:12:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:13:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:14:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:14:59
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:15:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:15:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode932) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode933,@EWFormDataCode934,@EWFormDataCode935,@EWFormDataCode936,@EWFormDataCode937,@EWFormDataCode938,@EWFormDataCode939,@EWFormDataCode940,@EWFormDataCode941,@EWFormDataCode942,@EWFormDataCode943,@EWFormDataCode944,@EWFormDataCode945,@EWFormDataCode946,@EWFormDataCode947)) 	
Parameters:
@MenuCode932[String] = SupplyList
@EWFormDataCode933[Int32] = 4
@EWFormDataCode934[Int32] = 9
@EWFormDataCode935[Int32] = 10
@EWFormDataCode936[Int32] = 11
@EWFormDataCode937[Int32] = 13
@EWFormDataCode938[Int32] = 14
@EWFormDataCode939[Int32] = 15
@EWFormDataCode940[Int32] = 17
@EWFormDataCode941[Int32] = 19
@EWFormDataCode942[Int32] = 5
@EWFormDataCode943[Int32] = 6
@EWFormDataCode944[Int32] = 7
@EWFormDataCode945[Int32] = 8
@EWFormDataCode946[Int32] = 16
@EWFormDataCode947[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:16:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:16:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:17:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:18:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:19:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:19:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:20:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:20:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:20:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode948) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode949,@EWFormDataCode950,@EWFormDataCode951,@EWFormDataCode952,@EWFormDataCode953,@EWFormDataCode954,@EWFormDataCode955,@EWFormDataCode956,@EWFormDataCode957,@EWFormDataCode958,@EWFormDataCode959,@EWFormDataCode960,@EWFormDataCode961,@EWFormDataCode962,@EWFormDataCode963)) 	
Parameters:
@MenuCode948[String] = SupplyList
@EWFormDataCode949[Int32] = 4
@EWFormDataCode950[Int32] = 9
@EWFormDataCode951[Int32] = 10
@EWFormDataCode952[Int32] = 11
@EWFormDataCode953[Int32] = 13
@EWFormDataCode954[Int32] = 14
@EWFormDataCode955[Int32] = 15
@EWFormDataCode956[Int32] = 17
@EWFormDataCode957[Int32] = 19
@EWFormDataCode958[Int32] = 5
@EWFormDataCode959[Int32] = 6
@EWFormDataCode960[Int32] = 7
@EWFormDataCode961[Int32] = 8
@EWFormDataCode962[Int32] = 16
@EWFormDataCode963[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:21:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:22:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:22:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:23:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:24:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:25:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:25:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:25:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:25:59
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode964) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode965,@EWFormDataCode966,@EWFormDataCode967,@EWFormDataCode968,@EWFormDataCode969,@EWFormDataCode970,@EWFormDataCode971,@EWFormDataCode972,@EWFormDataCode973,@EWFormDataCode974,@EWFormDataCode975,@EWFormDataCode976,@EWFormDataCode977,@EWFormDataCode978,@EWFormDataCode979)) 	
Parameters:
@MenuCode964[String] = SupplyList
@EWFormDataCode965[Int32] = 4
@EWFormDataCode966[Int32] = 9
@EWFormDataCode967[Int32] = 10
@EWFormDataCode968[Int32] = 11
@EWFormDataCode969[Int32] = 13
@EWFormDataCode970[Int32] = 14
@EWFormDataCode971[Int32] = 15
@EWFormDataCode972[Int32] = 17
@EWFormDataCode973[Int32] = 19
@EWFormDataCode974[Int32] = 5
@EWFormDataCode975[Int32] = 6
@EWFormDataCode976[Int32] = 7
@EWFormDataCode977[Int32] = 8
@EWFormDataCode978[Int32] = 16
@EWFormDataCode979[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:26:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:27:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:28:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:28:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:29:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:30:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:30:59
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:31:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode980) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode981,@EWFormDataCode982,@EWFormDataCode983,@EWFormDataCode984,@EWFormDataCode985,@EWFormDataCode986,@EWFormDataCode987,@EWFormDataCode988,@EWFormDataCode989,@EWFormDataCode990,@EWFormDataCode991,@EWFormDataCode992,@EWFormDataCode993,@EWFormDataCode994,@EWFormDataCode995)) 	
Parameters:
@MenuCode980[String] = SupplyList
@EWFormDataCode981[Int32] = 4
@EWFormDataCode982[Int32] = 9
@EWFormDataCode983[Int32] = 10
@EWFormDataCode984[Int32] = 11
@EWFormDataCode985[Int32] = 13
@EWFormDataCode986[Int32] = 14
@EWFormDataCode987[Int32] = 15
@EWFormDataCode988[Int32] = 17
@EWFormDataCode989[Int32] = 19
@EWFormDataCode990[Int32] = 5
@EWFormDataCode991[Int32] = 6
@EWFormDataCode992[Int32] = 7
@EWFormDataCode993[Int32] = 8
@EWFormDataCode994[Int32] = 16
@EWFormDataCode995[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:31:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:31:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:32:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:33:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:34:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:34:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:35:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:36:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:36:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode996) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode997,@EWFormDataCode998,@EWFormDataCode999,@EWFormDataCode1000,@EWFormDataCode1001,@EWFormDataCode1002,@EWFormDataCode1003,@EWFormDataCode1004,@EWFormDataCode1005,@EWFormDataCode1006,@EWFormDataCode1007,@EWFormDataCode1008,@EWFormDataCode1009,@EWFormDataCode1010,@EWFormDataCode1011)) 	
Parameters:
@MenuCode996[String] = SupplyList
@EWFormDataCode997[Int32] = 4
@EWFormDataCode998[Int32] = 9
@EWFormDataCode999[Int32] = 10
@EWFormDataCode1000[Int32] = 11
@EWFormDataCode1001[Int32] = 13
@EWFormDataCode1002[Int32] = 14
@EWFormDataCode1003[Int32] = 15
@EWFormDataCode1004[Int32] = 17
@EWFormDataCode1005[Int32] = 19
@EWFormDataCode1006[Int32] = 5
@EWFormDataCode1007[Int32] = 6
@EWFormDataCode1008[Int32] = 7
@EWFormDataCode1009[Int32] = 8
@EWFormDataCode1010[Int32] = 16
@EWFormDataCode1011[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:36:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:37:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:37:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:38:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:39:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:40:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:40:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:41:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:41:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1012) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1013,@EWFormDataCode1014,@EWFormDataCode1015,@EWFormDataCode1016,@EWFormDataCode1017,@EWFormDataCode1018,@EWFormDataCode1019,@EWFormDataCode1020,@EWFormDataCode1021,@EWFormDataCode1022,@EWFormDataCode1023,@EWFormDataCode1024,@EWFormDataCode1025,@EWFormDataCode1026,@EWFormDataCode1027)) 	
Parameters:
@MenuCode1012[String] = SupplyList
@EWFormDataCode1013[Int32] = 4
@EWFormDataCode1014[Int32] = 9
@EWFormDataCode1015[Int32] = 10
@EWFormDataCode1016[Int32] = 11
@EWFormDataCode1017[Int32] = 13
@EWFormDataCode1018[Int32] = 14
@EWFormDataCode1019[Int32] = 15
@EWFormDataCode1020[Int32] = 17
@EWFormDataCode1021[Int32] = 19
@EWFormDataCode1022[Int32] = 5
@EWFormDataCode1023[Int32] = 6
@EWFormDataCode1024[Int32] = 7
@EWFormDataCode1025[Int32] = 8
@EWFormDataCode1026[Int32] = 16
@EWFormDataCode1027[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:41:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:42:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:43:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:43:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:44:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:45:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:46:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:46:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1028) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1029,@EWFormDataCode1030,@EWFormDataCode1031,@EWFormDataCode1032,@EWFormDataCode1033,@EWFormDataCode1034,@EWFormDataCode1035,@EWFormDataCode1036,@EWFormDataCode1037,@EWFormDataCode1038,@EWFormDataCode1039,@EWFormDataCode1040,@EWFormDataCode1041,@EWFormDataCode1042,@EWFormDataCode1043)) 	
Parameters:
@MenuCode1028[String] = SupplyList
@EWFormDataCode1029[Int32] = 4
@EWFormDataCode1030[Int32] = 9
@EWFormDataCode1031[Int32] = 10
@EWFormDataCode1032[Int32] = 11
@EWFormDataCode1033[Int32] = 13
@EWFormDataCode1034[Int32] = 14
@EWFormDataCode1035[Int32] = 15
@EWFormDataCode1036[Int32] = 17
@EWFormDataCode1037[Int32] = 19
@EWFormDataCode1038[Int32] = 5
@EWFormDataCode1039[Int32] = 6
@EWFormDataCode1040[Int32] = 7
@EWFormDataCode1041[Int32] = 8
@EWFormDataCode1042[Int32] = 16
@EWFormDataCode1043[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:46:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:46:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:47:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:48:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:49:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:49:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:50:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:51:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:51:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1044) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1045,@EWFormDataCode1046,@EWFormDataCode1047,@EWFormDataCode1048,@EWFormDataCode1049,@EWFormDataCode1050,@EWFormDataCode1051,@EWFormDataCode1052,@EWFormDataCode1053,@EWFormDataCode1054,@EWFormDataCode1055,@EWFormDataCode1056,@EWFormDataCode1057,@EWFormDataCode1058,@EWFormDataCode1059)) 	
Parameters:
@MenuCode1044[String] = SupplyList
@EWFormDataCode1045[Int32] = 4
@EWFormDataCode1046[Int32] = 9
@EWFormDataCode1047[Int32] = 10
@EWFormDataCode1048[Int32] = 11
@EWFormDataCode1049[Int32] = 13
@EWFormDataCode1050[Int32] = 14
@EWFormDataCode1051[Int32] = 15
@EWFormDataCode1052[Int32] = 17
@EWFormDataCode1053[Int32] = 19
@EWFormDataCode1054[Int32] = 5
@EWFormDataCode1055[Int32] = 6
@EWFormDataCode1056[Int32] = 7
@EWFormDataCode1057[Int32] = 8
@EWFormDataCode1058[Int32] = 16
@EWFormDataCode1059[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:51:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:52:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:52:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:53:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:54:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:55:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:55:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 14:56:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 14:56:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1060) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1061,@EWFormDataCode1062,@EWFormDataCode1063,@EWFormDataCode1064,@EWFormDataCode1065,@EWFormDataCode1066,@EWFormDataCode1067,@EWFormDataCode1068,@EWFormDataCode1069,@EWFormDataCode1070,@EWFormDataCode1071,@EWFormDataCode1072,@EWFormDataCode1073,@EWFormDataCode1074,@EWFormDataCode1075)) 	
Parameters:
@MenuCode1060[String] = SupplyList
@EWFormDataCode1061[Int32] = 4
@EWFormDataCode1062[Int32] = 9
@EWFormDataCode1063[Int32] = 10
@EWFormDataCode1064[Int32] = 11
@EWFormDataCode1065[Int32] = 13
@EWFormDataCode1066[Int32] = 14
@EWFormDataCode1067[Int32] = 15
@EWFormDataCode1068[Int32] = 17
@EWFormDataCode1069[Int32] = 19
@EWFormDataCode1070[Int32] = 5
@EWFormDataCode1071[Int32] = 6
@EWFormDataCode1072[Int32] = 7
@EWFormDataCode1073[Int32] = 8
@EWFormDataCode1074[Int32] = 16
@EWFormDataCode1075[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 14:56:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:57:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 14:58:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 14:58:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 14:59:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:00:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:01:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:01:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1076) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1077,@EWFormDataCode1078,@EWFormDataCode1079,@EWFormDataCode1080,@EWFormDataCode1081,@EWFormDataCode1082,@EWFormDataCode1083,@EWFormDataCode1084,@EWFormDataCode1085,@EWFormDataCode1086,@EWFormDataCode1087,@EWFormDataCode1088,@EWFormDataCode1089,@EWFormDataCode1090,@EWFormDataCode1091)) 	
Parameters:
@MenuCode1076[String] = SupplyList
@EWFormDataCode1077[Int32] = 4
@EWFormDataCode1078[Int32] = 9
@EWFormDataCode1079[Int32] = 10
@EWFormDataCode1080[Int32] = 11
@EWFormDataCode1081[Int32] = 13
@EWFormDataCode1082[Int32] = 14
@EWFormDataCode1083[Int32] = 15
@EWFormDataCode1084[Int32] = 17
@EWFormDataCode1085[Int32] = 19
@EWFormDataCode1086[Int32] = 5
@EWFormDataCode1087[Int32] = 6
@EWFormDataCode1088[Int32] = 7
@EWFormDataCode1089[Int32] = 8
@EWFormDataCode1090[Int32] = 16
@EWFormDataCode1091[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:01:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:01:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:02:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:03:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:04:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:04:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:05:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:06:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:06:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1092) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1093,@EWFormDataCode1094,@EWFormDataCode1095,@EWFormDataCode1096,@EWFormDataCode1097,@EWFormDataCode1098,@EWFormDataCode1099,@EWFormDataCode1100,@EWFormDataCode1101,@EWFormDataCode1102,@EWFormDataCode1103,@EWFormDataCode1104,@EWFormDataCode1105,@EWFormDataCode1106,@EWFormDataCode1107)) 	
Parameters:
@MenuCode1092[String] = SupplyList
@EWFormDataCode1093[Int32] = 4
@EWFormDataCode1094[Int32] = 9
@EWFormDataCode1095[Int32] = 10
@EWFormDataCode1096[Int32] = 11
@EWFormDataCode1097[Int32] = 13
@EWFormDataCode1098[Int32] = 14
@EWFormDataCode1099[Int32] = 15
@EWFormDataCode1100[Int32] = 17
@EWFormDataCode1101[Int32] = 19
@EWFormDataCode1102[Int32] = 5
@EWFormDataCode1103[Int32] = 6
@EWFormDataCode1104[Int32] = 7
@EWFormDataCode1105[Int32] = 8
@EWFormDataCode1106[Int32] = 16
@EWFormDataCode1107[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:06:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:07:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:07:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:08:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:09:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:10:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:10:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:11:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:11:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1108) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1109,@EWFormDataCode1110,@EWFormDataCode1111,@EWFormDataCode1112,@EWFormDataCode1113,@EWFormDataCode1114,@EWFormDataCode1115,@EWFormDataCode1116,@EWFormDataCode1117,@EWFormDataCode1118,@EWFormDataCode1119,@EWFormDataCode1120,@EWFormDataCode1121,@EWFormDataCode1122,@EWFormDataCode1123)) 	
Parameters:
@MenuCode1108[String] = SupplyList
@EWFormDataCode1109[Int32] = 4
@EWFormDataCode1110[Int32] = 9
@EWFormDataCode1111[Int32] = 10
@EWFormDataCode1112[Int32] = 11
@EWFormDataCode1113[Int32] = 13
@EWFormDataCode1114[Int32] = 14
@EWFormDataCode1115[Int32] = 15
@EWFormDataCode1116[Int32] = 17
@EWFormDataCode1117[Int32] = 19
@EWFormDataCode1118[Int32] = 5
@EWFormDataCode1119[Int32] = 6
@EWFormDataCode1120[Int32] = 7
@EWFormDataCode1121[Int32] = 8
@EWFormDataCode1122[Int32] = 16
@EWFormDataCode1123[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:11:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:12:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:13:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:13:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:14:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:15:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:16:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:16:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1124) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1125,@EWFormDataCode1126,@EWFormDataCode1127,@EWFormDataCode1128,@EWFormDataCode1129,@EWFormDataCode1130,@EWFormDataCode1131,@EWFormDataCode1132,@EWFormDataCode1133,@EWFormDataCode1134,@EWFormDataCode1135,@EWFormDataCode1136,@EWFormDataCode1137,@EWFormDataCode1138,@EWFormDataCode1139)) 	
Parameters:
@MenuCode1124[String] = SupplyList
@EWFormDataCode1125[Int32] = 4
@EWFormDataCode1126[Int32] = 9
@EWFormDataCode1127[Int32] = 10
@EWFormDataCode1128[Int32] = 11
@EWFormDataCode1129[Int32] = 13
@EWFormDataCode1130[Int32] = 14
@EWFormDataCode1131[Int32] = 15
@EWFormDataCode1132[Int32] = 17
@EWFormDataCode1133[Int32] = 19
@EWFormDataCode1134[Int32] = 5
@EWFormDataCode1135[Int32] = 6
@EWFormDataCode1136[Int32] = 7
@EWFormDataCode1137[Int32] = 8
@EWFormDataCode1138[Int32] = 16
@EWFormDataCode1139[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:16:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:16:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:17:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:18:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:19:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:19:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:20:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:21:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:21:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1140) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1141,@EWFormDataCode1142,@EWFormDataCode1143,@EWFormDataCode1144,@EWFormDataCode1145,@EWFormDataCode1146,@EWFormDataCode1147,@EWFormDataCode1148,@EWFormDataCode1149,@EWFormDataCode1150,@EWFormDataCode1151,@EWFormDataCode1152,@EWFormDataCode1153,@EWFormDataCode1154,@EWFormDataCode1155)) 	
Parameters:
@MenuCode1140[String] = SupplyList
@EWFormDataCode1141[Int32] = 4
@EWFormDataCode1142[Int32] = 9
@EWFormDataCode1143[Int32] = 10
@EWFormDataCode1144[Int32] = 11
@EWFormDataCode1145[Int32] = 13
@EWFormDataCode1146[Int32] = 14
@EWFormDataCode1147[Int32] = 15
@EWFormDataCode1148[Int32] = 17
@EWFormDataCode1149[Int32] = 19
@EWFormDataCode1150[Int32] = 5
@EWFormDataCode1151[Int32] = 6
@EWFormDataCode1152[Int32] = 7
@EWFormDataCode1153[Int32] = 8
@EWFormDataCode1154[Int32] = 16
@EWFormDataCode1155[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:21:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:22:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:22:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:23:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:24:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:25:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:25:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:26:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:26:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1156) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1157,@EWFormDataCode1158,@EWFormDataCode1159,@EWFormDataCode1160,@EWFormDataCode1161,@EWFormDataCode1162,@EWFormDataCode1163,@EWFormDataCode1164,@EWFormDataCode1165,@EWFormDataCode1166,@EWFormDataCode1167,@EWFormDataCode1168,@EWFormDataCode1169,@EWFormDataCode1170,@EWFormDataCode1171)) 	
Parameters:
@MenuCode1156[String] = SupplyList
@EWFormDataCode1157[Int32] = 4
@EWFormDataCode1158[Int32] = 9
@EWFormDataCode1159[Int32] = 10
@EWFormDataCode1160[Int32] = 11
@EWFormDataCode1161[Int32] = 13
@EWFormDataCode1162[Int32] = 14
@EWFormDataCode1163[Int32] = 15
@EWFormDataCode1164[Int32] = 17
@EWFormDataCode1165[Int32] = 19
@EWFormDataCode1166[Int32] = 5
@EWFormDataCode1167[Int32] = 6
@EWFormDataCode1168[Int32] = 7
@EWFormDataCode1169[Int32] = 8
@EWFormDataCode1170[Int32] = 16
@EWFormDataCode1171[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:26:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:27:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:28:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:28:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:29:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:30:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:31:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:31:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1172) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1173,@EWFormDataCode1174,@EWFormDataCode1175,@EWFormDataCode1176,@EWFormDataCode1177,@EWFormDataCode1178,@EWFormDataCode1179,@EWFormDataCode1180,@EWFormDataCode1181,@EWFormDataCode1182,@EWFormDataCode1183,@EWFormDataCode1184,@EWFormDataCode1185,@EWFormDataCode1186,@EWFormDataCode1187)) 	
Parameters:
@MenuCode1172[String] = SupplyList
@EWFormDataCode1173[Int32] = 4
@EWFormDataCode1174[Int32] = 9
@EWFormDataCode1175[Int32] = 10
@EWFormDataCode1176[Int32] = 11
@EWFormDataCode1177[Int32] = 13
@EWFormDataCode1178[Int32] = 14
@EWFormDataCode1179[Int32] = 15
@EWFormDataCode1180[Int32] = 17
@EWFormDataCode1181[Int32] = 19
@EWFormDataCode1182[Int32] = 5
@EWFormDataCode1183[Int32] = 6
@EWFormDataCode1184[Int32] = 7
@EWFormDataCode1185[Int32] = 8
@EWFormDataCode1186[Int32] = 16
@EWFormDataCode1187[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:31:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:31:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:32:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:33:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:34:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:34:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:35:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:36:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:36:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1188) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1189,@EWFormDataCode1190,@EWFormDataCode1191,@EWFormDataCode1192,@EWFormDataCode1193,@EWFormDataCode1194,@EWFormDataCode1195,@EWFormDataCode1196,@EWFormDataCode1197,@EWFormDataCode1198,@EWFormDataCode1199,@EWFormDataCode1200,@EWFormDataCode1201,@EWFormDataCode1202,@EWFormDataCode1203)) 	
Parameters:
@MenuCode1188[String] = SupplyList
@EWFormDataCode1189[Int32] = 4
@EWFormDataCode1190[Int32] = 9
@EWFormDataCode1191[Int32] = 10
@EWFormDataCode1192[Int32] = 11
@EWFormDataCode1193[Int32] = 13
@EWFormDataCode1194[Int32] = 14
@EWFormDataCode1195[Int32] = 15
@EWFormDataCode1196[Int32] = 17
@EWFormDataCode1197[Int32] = 19
@EWFormDataCode1198[Int32] = 5
@EWFormDataCode1199[Int32] = 6
@EWFormDataCode1200[Int32] = 7
@EWFormDataCode1201[Int32] = 8
@EWFormDataCode1202[Int32] = 16
@EWFormDataCode1203[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:36:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:37:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:37:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:38:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:39:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:40:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:40:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:41:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:41:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1204) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1205,@EWFormDataCode1206,@EWFormDataCode1207,@EWFormDataCode1208,@EWFormDataCode1209,@EWFormDataCode1210,@EWFormDataCode1211,@EWFormDataCode1212,@EWFormDataCode1213,@EWFormDataCode1214,@EWFormDataCode1215,@EWFormDataCode1216,@EWFormDataCode1217,@EWFormDataCode1218,@EWFormDataCode1219)) 	
Parameters:
@MenuCode1204[String] = SupplyList
@EWFormDataCode1205[Int32] = 4
@EWFormDataCode1206[Int32] = 9
@EWFormDataCode1207[Int32] = 10
@EWFormDataCode1208[Int32] = 11
@EWFormDataCode1209[Int32] = 13
@EWFormDataCode1210[Int32] = 14
@EWFormDataCode1211[Int32] = 15
@EWFormDataCode1212[Int32] = 17
@EWFormDataCode1213[Int32] = 19
@EWFormDataCode1214[Int32] = 5
@EWFormDataCode1215[Int32] = 6
@EWFormDataCode1216[Int32] = 7
@EWFormDataCode1217[Int32] = 8
@EWFormDataCode1218[Int32] = 16
@EWFormDataCode1219[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:41:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:42:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:43:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:43:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:44:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:45:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:46:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:46:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1220) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1221,@EWFormDataCode1222,@EWFormDataCode1223,@EWFormDataCode1224,@EWFormDataCode1225,@EWFormDataCode1226,@EWFormDataCode1227,@EWFormDataCode1228,@EWFormDataCode1229,@EWFormDataCode1230,@EWFormDataCode1231,@EWFormDataCode1232,@EWFormDataCode1233,@EWFormDataCode1234,@EWFormDataCode1235)) 	
Parameters:
@MenuCode1220[String] = SupplyList
@EWFormDataCode1221[Int32] = 4
@EWFormDataCode1222[Int32] = 9
@EWFormDataCode1223[Int32] = 10
@EWFormDataCode1224[Int32] = 11
@EWFormDataCode1225[Int32] = 13
@EWFormDataCode1226[Int32] = 14
@EWFormDataCode1227[Int32] = 15
@EWFormDataCode1228[Int32] = 17
@EWFormDataCode1229[Int32] = 19
@EWFormDataCode1230[Int32] = 5
@EWFormDataCode1231[Int32] = 6
@EWFormDataCode1232[Int32] = 7
@EWFormDataCode1233[Int32] = 8
@EWFormDataCode1234[Int32] = 16
@EWFormDataCode1235[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:46:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:46:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:47:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:48:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:49:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:49:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:50:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:51:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:51:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1236) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1237,@EWFormDataCode1238,@EWFormDataCode1239,@EWFormDataCode1240,@EWFormDataCode1241,@EWFormDataCode1242,@EWFormDataCode1243,@EWFormDataCode1244,@EWFormDataCode1245,@EWFormDataCode1246,@EWFormDataCode1247,@EWFormDataCode1248,@EWFormDataCode1249,@EWFormDataCode1250,@EWFormDataCode1251)) 	
Parameters:
@MenuCode1236[String] = SupplyList
@EWFormDataCode1237[Int32] = 4
@EWFormDataCode1238[Int32] = 9
@EWFormDataCode1239[Int32] = 10
@EWFormDataCode1240[Int32] = 11
@EWFormDataCode1241[Int32] = 13
@EWFormDataCode1242[Int32] = 14
@EWFormDataCode1243[Int32] = 15
@EWFormDataCode1244[Int32] = 17
@EWFormDataCode1245[Int32] = 19
@EWFormDataCode1246[Int32] = 5
@EWFormDataCode1247[Int32] = 6
@EWFormDataCode1248[Int32] = 7
@EWFormDataCode1249[Int32] = 8
@EWFormDataCode1250[Int32] = 16
@EWFormDataCode1251[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:51:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:52:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:52:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:53:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:54:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:55:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:55:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 15:56:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 15:56:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1252) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1253,@EWFormDataCode1254,@EWFormDataCode1255,@EWFormDataCode1256,@EWFormDataCode1257,@EWFormDataCode1258,@EWFormDataCode1259,@EWFormDataCode1260,@EWFormDataCode1261,@EWFormDataCode1262,@EWFormDataCode1263,@EWFormDataCode1264,@EWFormDataCode1265,@EWFormDataCode1266,@EWFormDataCode1267)) 	
Parameters:
@MenuCode1252[String] = SupplyList
@EWFormDataCode1253[Int32] = 4
@EWFormDataCode1254[Int32] = 9
@EWFormDataCode1255[Int32] = 10
@EWFormDataCode1256[Int32] = 11
@EWFormDataCode1257[Int32] = 13
@EWFormDataCode1258[Int32] = 14
@EWFormDataCode1259[Int32] = 15
@EWFormDataCode1260[Int32] = 17
@EWFormDataCode1261[Int32] = 19
@EWFormDataCode1262[Int32] = 5
@EWFormDataCode1263[Int32] = 6
@EWFormDataCode1264[Int32] = 7
@EWFormDataCode1265[Int32] = 8
@EWFormDataCode1266[Int32] = 16
@EWFormDataCode1267[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 15:56:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:57:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 15:58:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 15:58:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 15:59:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:00:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:01:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:01:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1268) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1269,@EWFormDataCode1270,@EWFormDataCode1271,@EWFormDataCode1272,@EWFormDataCode1273,@EWFormDataCode1274,@EWFormDataCode1275,@EWFormDataCode1276,@EWFormDataCode1277,@EWFormDataCode1278,@EWFormDataCode1279,@EWFormDataCode1280,@EWFormDataCode1281,@EWFormDataCode1282,@EWFormDataCode1283)) 	
Parameters:
@MenuCode1268[String] = SupplyList
@EWFormDataCode1269[Int32] = 4
@EWFormDataCode1270[Int32] = 9
@EWFormDataCode1271[Int32] = 10
@EWFormDataCode1272[Int32] = 11
@EWFormDataCode1273[Int32] = 13
@EWFormDataCode1274[Int32] = 14
@EWFormDataCode1275[Int32] = 15
@EWFormDataCode1276[Int32] = 17
@EWFormDataCode1277[Int32] = 19
@EWFormDataCode1278[Int32] = 5
@EWFormDataCode1279[Int32] = 6
@EWFormDataCode1280[Int32] = 7
@EWFormDataCode1281[Int32] = 8
@EWFormDataCode1282[Int32] = 16
@EWFormDataCode1283[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:01:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:01:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:02:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:03:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:04:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:04:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:05:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:06:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:06:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1284) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1285,@EWFormDataCode1286,@EWFormDataCode1287,@EWFormDataCode1288,@EWFormDataCode1289,@EWFormDataCode1290,@EWFormDataCode1291,@EWFormDataCode1292,@EWFormDataCode1293,@EWFormDataCode1294,@EWFormDataCode1295,@EWFormDataCode1296,@EWFormDataCode1297,@EWFormDataCode1298,@EWFormDataCode1299)) 	
Parameters:
@MenuCode1284[String] = SupplyList
@EWFormDataCode1285[Int32] = 4
@EWFormDataCode1286[Int32] = 9
@EWFormDataCode1287[Int32] = 10
@EWFormDataCode1288[Int32] = 11
@EWFormDataCode1289[Int32] = 13
@EWFormDataCode1290[Int32] = 14
@EWFormDataCode1291[Int32] = 15
@EWFormDataCode1292[Int32] = 17
@EWFormDataCode1293[Int32] = 19
@EWFormDataCode1294[Int32] = 5
@EWFormDataCode1295[Int32] = 6
@EWFormDataCode1296[Int32] = 7
@EWFormDataCode1297[Int32] = 8
@EWFormDataCode1298[Int32] = 16
@EWFormDataCode1299[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:06:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:07:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:07:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:08:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:09:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:10:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:10:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:11:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:11:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1300) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1301,@EWFormDataCode1302,@EWFormDataCode1303,@EWFormDataCode1304,@EWFormDataCode1305,@EWFormDataCode1306,@EWFormDataCode1307,@EWFormDataCode1308,@EWFormDataCode1309,@EWFormDataCode1310,@EWFormDataCode1311,@EWFormDataCode1312,@EWFormDataCode1313,@EWFormDataCode1314,@EWFormDataCode1315)) 	
Parameters:
@MenuCode1300[String] = SupplyList
@EWFormDataCode1301[Int32] = 4
@EWFormDataCode1302[Int32] = 9
@EWFormDataCode1303[Int32] = 10
@EWFormDataCode1304[Int32] = 11
@EWFormDataCode1305[Int32] = 13
@EWFormDataCode1306[Int32] = 14
@EWFormDataCode1307[Int32] = 15
@EWFormDataCode1308[Int32] = 17
@EWFormDataCode1309[Int32] = 19
@EWFormDataCode1310[Int32] = 5
@EWFormDataCode1311[Int32] = 6
@EWFormDataCode1312[Int32] = 7
@EWFormDataCode1313[Int32] = 8
@EWFormDataCode1314[Int32] = 16
@EWFormDataCode1315[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:11:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:12:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:13:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:13:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:14:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:15:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:16:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:16:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1316) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1317,@EWFormDataCode1318,@EWFormDataCode1319,@EWFormDataCode1320,@EWFormDataCode1321,@EWFormDataCode1322,@EWFormDataCode1323,@EWFormDataCode1324,@EWFormDataCode1325,@EWFormDataCode1326,@EWFormDataCode1327,@EWFormDataCode1328,@EWFormDataCode1329,@EWFormDataCode1330,@EWFormDataCode1331)) 	
Parameters:
@MenuCode1316[String] = SupplyList
@EWFormDataCode1317[Int32] = 4
@EWFormDataCode1318[Int32] = 9
@EWFormDataCode1319[Int32] = 10
@EWFormDataCode1320[Int32] = 11
@EWFormDataCode1321[Int32] = 13
@EWFormDataCode1322[Int32] = 14
@EWFormDataCode1323[Int32] = 15
@EWFormDataCode1324[Int32] = 17
@EWFormDataCode1325[Int32] = 19
@EWFormDataCode1326[Int32] = 5
@EWFormDataCode1327[Int32] = 6
@EWFormDataCode1328[Int32] = 7
@EWFormDataCode1329[Int32] = 8
@EWFormDataCode1330[Int32] = 16
@EWFormDataCode1331[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:16:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:16:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:17:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:18:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:19:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:19:37
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:20:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:21:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:21:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1332) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1333,@EWFormDataCode1334,@EWFormDataCode1335,@EWFormDataCode1336,@EWFormDataCode1337,@EWFormDataCode1338,@EWFormDataCode1339,@EWFormDataCode1340,@EWFormDataCode1341,@EWFormDataCode1342,@EWFormDataCode1343,@EWFormDataCode1344,@EWFormDataCode1345,@EWFormDataCode1346,@EWFormDataCode1347)) 	
Parameters:
@MenuCode1332[String] = SupplyList
@EWFormDataCode1333[Int32] = 4
@EWFormDataCode1334[Int32] = 9
@EWFormDataCode1335[Int32] = 10
@EWFormDataCode1336[Int32] = 11
@EWFormDataCode1337[Int32] = 13
@EWFormDataCode1338[Int32] = 14
@EWFormDataCode1339[Int32] = 15
@EWFormDataCode1340[Int32] = 17
@EWFormDataCode1341[Int32] = 19
@EWFormDataCode1342[Int32] = 5
@EWFormDataCode1343[Int32] = 6
@EWFormDataCode1344[Int32] = 7
@EWFormDataCode1345[Int32] = 8
@EWFormDataCode1346[Int32] = 16
@EWFormDataCode1347[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:21:00
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:22:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:22:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:23:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:24:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:25:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:25:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:26:00
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:26:00
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1348) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1349,@EWFormDataCode1350,@EWFormDataCode1351,@EWFormDataCode1352,@EWFormDataCode1353,@EWFormDataCode1354,@EWFormDataCode1355,@EWFormDataCode1356,@EWFormDataCode1357,@EWFormDataCode1358,@EWFormDataCode1359,@EWFormDataCode1360,@EWFormDataCode1361,@EWFormDataCode1362,@EWFormDataCode1363)) 	
Parameters:
@MenuCode1348[String] = SupplyList
@EWFormDataCode1349[Int32] = 4
@EWFormDataCode1350[Int32] = 9
@EWFormDataCode1351[Int32] = 10
@EWFormDataCode1352[Int32] = 11
@EWFormDataCode1353[Int32] = 13
@EWFormDataCode1354[Int32] = 14
@EWFormDataCode1355[Int32] = 15
@EWFormDataCode1356[Int32] = 17
@EWFormDataCode1357[Int32] = 19
@EWFormDataCode1358[Int32] = 5
@EWFormDataCode1359[Int32] = 6
@EWFormDataCode1360[Int32] = 7
@EWFormDataCode1361[Int32] = 8
@EWFormDataCode1362[Int32] = 16
@EWFormDataCode1363[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:26:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:27:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:28:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:28:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:29:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:30:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:31:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:31:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:31:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1364) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1365,@EWFormDataCode1366,@EWFormDataCode1367,@EWFormDataCode1368,@EWFormDataCode1369,@EWFormDataCode1370,@EWFormDataCode1371,@EWFormDataCode1372,@EWFormDataCode1373,@EWFormDataCode1374,@EWFormDataCode1375,@EWFormDataCode1376,@EWFormDataCode1377,@EWFormDataCode1378,@EWFormDataCode1379)) 	
Parameters:
@MenuCode1364[String] = SupplyList
@EWFormDataCode1365[Int32] = 4
@EWFormDataCode1366[Int32] = 9
@EWFormDataCode1367[Int32] = 10
@EWFormDataCode1368[Int32] = 11
@EWFormDataCode1369[Int32] = 13
@EWFormDataCode1370[Int32] = 14
@EWFormDataCode1371[Int32] = 15
@EWFormDataCode1372[Int32] = 17
@EWFormDataCode1373[Int32] = 19
@EWFormDataCode1374[Int32] = 5
@EWFormDataCode1375[Int32] = 6
@EWFormDataCode1376[Int32] = 7
@EWFormDataCode1377[Int32] = 8
@EWFormDataCode1378[Int32] = 16
@EWFormDataCode1379[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:31:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:32:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:33:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:34:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:34:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:35:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:36:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:36:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1380) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1381,@EWFormDataCode1382,@EWFormDataCode1383,@EWFormDataCode1384,@EWFormDataCode1385,@EWFormDataCode1386,@EWFormDataCode1387,@EWFormDataCode1388,@EWFormDataCode1389,@EWFormDataCode1390,@EWFormDataCode1391,@EWFormDataCode1392,@EWFormDataCode1393,@EWFormDataCode1394,@EWFormDataCode1395)) 	
Parameters:
@MenuCode1380[String] = SupplyList
@EWFormDataCode1381[Int32] = 4
@EWFormDataCode1382[Int32] = 9
@EWFormDataCode1383[Int32] = 10
@EWFormDataCode1384[Int32] = 11
@EWFormDataCode1385[Int32] = 13
@EWFormDataCode1386[Int32] = 14
@EWFormDataCode1387[Int32] = 15
@EWFormDataCode1388[Int32] = 17
@EWFormDataCode1389[Int32] = 19
@EWFormDataCode1390[Int32] = 5
@EWFormDataCode1391[Int32] = 6
@EWFormDataCode1392[Int32] = 7
@EWFormDataCode1393[Int32] = 8
@EWFormDataCode1394[Int32] = 16
@EWFormDataCode1395[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:36:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:37:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:37:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:38:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:39:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:40:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:40:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:40:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:40:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:41:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:41:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1396) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1397,@EWFormDataCode1398,@EWFormDataCode1399,@EWFormDataCode1400,@EWFormDataCode1401,@EWFormDataCode1402,@EWFormDataCode1403,@EWFormDataCode1404,@EWFormDataCode1405,@EWFormDataCode1406,@EWFormDataCode1407,@EWFormDataCode1408,@EWFormDataCode1409,@EWFormDataCode1410,@EWFormDataCode1411)) 	
Parameters:
@MenuCode1396[String] = SupplyList
@EWFormDataCode1397[Int32] = 4
@EWFormDataCode1398[Int32] = 9
@EWFormDataCode1399[Int32] = 10
@EWFormDataCode1400[Int32] = 11
@EWFormDataCode1401[Int32] = 13
@EWFormDataCode1402[Int32] = 14
@EWFormDataCode1403[Int32] = 15
@EWFormDataCode1404[Int32] = 17
@EWFormDataCode1405[Int32] = 19
@EWFormDataCode1406[Int32] = 5
@EWFormDataCode1407[Int32] = 6
@EWFormDataCode1408[Int32] = 7
@EWFormDataCode1409[Int32] = 8
@EWFormDataCode1410[Int32] = 16
@EWFormDataCode1411[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:41:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:42:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:43:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:43:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:44:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:45:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:45:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:46:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:46:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1412) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1413,@EWFormDataCode1414,@EWFormDataCode1415,@EWFormDataCode1416,@EWFormDataCode1417,@EWFormDataCode1418,@EWFormDataCode1419,@EWFormDataCode1420,@EWFormDataCode1421,@EWFormDataCode1422,@EWFormDataCode1423,@EWFormDataCode1424,@EWFormDataCode1425,@EWFormDataCode1426,@EWFormDataCode1427)) 	
Parameters:
@MenuCode1412[String] = SupplyList
@EWFormDataCode1413[Int32] = 4
@EWFormDataCode1414[Int32] = 9
@EWFormDataCode1415[Int32] = 10
@EWFormDataCode1416[Int32] = 11
@EWFormDataCode1417[Int32] = 13
@EWFormDataCode1418[Int32] = 14
@EWFormDataCode1419[Int32] = 15
@EWFormDataCode1420[Int32] = 17
@EWFormDataCode1421[Int32] = 19
@EWFormDataCode1422[Int32] = 5
@EWFormDataCode1423[Int32] = 6
@EWFormDataCode1424[Int32] = 7
@EWFormDataCode1425[Int32] = 8
@EWFormDataCode1426[Int32] = 16
@EWFormDataCode1427[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:46:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:46:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:47:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:48:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:49:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:49:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:50:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:50:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:50:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:51:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:51:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1428) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1429,@EWFormDataCode1430,@EWFormDataCode1431,@EWFormDataCode1432,@EWFormDataCode1433,@EWFormDataCode1434,@EWFormDataCode1435,@EWFormDataCode1436,@EWFormDataCode1437,@EWFormDataCode1438,@EWFormDataCode1439,@EWFormDataCode1440,@EWFormDataCode1441,@EWFormDataCode1442,@EWFormDataCode1443)) 	
Parameters:
@MenuCode1428[String] = SupplyList
@EWFormDataCode1429[Int32] = 4
@EWFormDataCode1430[Int32] = 9
@EWFormDataCode1431[Int32] = 10
@EWFormDataCode1432[Int32] = 11
@EWFormDataCode1433[Int32] = 13
@EWFormDataCode1434[Int32] = 14
@EWFormDataCode1435[Int32] = 15
@EWFormDataCode1436[Int32] = 17
@EWFormDataCode1437[Int32] = 19
@EWFormDataCode1438[Int32] = 5
@EWFormDataCode1439[Int32] = 6
@EWFormDataCode1440[Int32] = 7
@EWFormDataCode1441[Int32] = 8
@EWFormDataCode1442[Int32] = 16
@EWFormDataCode1443[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:51:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:52:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:52:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:53:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:54:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:55:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:55:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:55:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 16:56:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 16:56:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1444) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1445,@EWFormDataCode1446,@EWFormDataCode1447,@EWFormDataCode1448,@EWFormDataCode1449,@EWFormDataCode1450,@EWFormDataCode1451,@EWFormDataCode1452,@EWFormDataCode1453,@EWFormDataCode1454,@EWFormDataCode1455,@EWFormDataCode1456,@EWFormDataCode1457,@EWFormDataCode1458,@EWFormDataCode1459)) 	
Parameters:
@MenuCode1444[String] = SupplyList
@EWFormDataCode1445[Int32] = 4
@EWFormDataCode1446[Int32] = 9
@EWFormDataCode1447[Int32] = 10
@EWFormDataCode1448[Int32] = 11
@EWFormDataCode1449[Int32] = 13
@EWFormDataCode1450[Int32] = 14
@EWFormDataCode1451[Int32] = 15
@EWFormDataCode1452[Int32] = 17
@EWFormDataCode1453[Int32] = 19
@EWFormDataCode1454[Int32] = 5
@EWFormDataCode1455[Int32] = 6
@EWFormDataCode1456[Int32] = 7
@EWFormDataCode1457[Int32] = 8
@EWFormDataCode1458[Int32] = 16
@EWFormDataCode1459[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 16:56:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:57:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 16:58:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 16:58:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 16:59:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:00:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:00:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:00:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:01:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:01:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1460) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1461,@EWFormDataCode1462,@EWFormDataCode1463,@EWFormDataCode1464,@EWFormDataCode1465,@EWFormDataCode1466,@EWFormDataCode1467,@EWFormDataCode1468,@EWFormDataCode1469,@EWFormDataCode1470,@EWFormDataCode1471,@EWFormDataCode1472,@EWFormDataCode1473,@EWFormDataCode1474,@EWFormDataCode1475)) 	
Parameters:
@MenuCode1460[String] = SupplyList
@EWFormDataCode1461[Int32] = 4
@EWFormDataCode1462[Int32] = 9
@EWFormDataCode1463[Int32] = 10
@EWFormDataCode1464[Int32] = 11
@EWFormDataCode1465[Int32] = 13
@EWFormDataCode1466[Int32] = 14
@EWFormDataCode1467[Int32] = 15
@EWFormDataCode1468[Int32] = 17
@EWFormDataCode1469[Int32] = 19
@EWFormDataCode1470[Int32] = 5
@EWFormDataCode1471[Int32] = 6
@EWFormDataCode1472[Int32] = 7
@EWFormDataCode1473[Int32] = 8
@EWFormDataCode1474[Int32] = 16
@EWFormDataCode1475[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:01:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:01:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:02:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:03:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:04:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:04:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:05:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:05:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:06:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:06:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1476) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1477,@EWFormDataCode1478,@EWFormDataCode1479,@EWFormDataCode1480,@EWFormDataCode1481,@EWFormDataCode1482,@EWFormDataCode1483,@EWFormDataCode1484,@EWFormDataCode1485,@EWFormDataCode1486,@EWFormDataCode1487,@EWFormDataCode1488,@EWFormDataCode1489,@EWFormDataCode1490,@EWFormDataCode1491)) 	
Parameters:
@MenuCode1476[String] = SupplyList
@EWFormDataCode1477[Int32] = 4
@EWFormDataCode1478[Int32] = 9
@EWFormDataCode1479[Int32] = 10
@EWFormDataCode1480[Int32] = 11
@EWFormDataCode1481[Int32] = 13
@EWFormDataCode1482[Int32] = 14
@EWFormDataCode1483[Int32] = 15
@EWFormDataCode1484[Int32] = 17
@EWFormDataCode1485[Int32] = 19
@EWFormDataCode1486[Int32] = 5
@EWFormDataCode1487[Int32] = 6
@EWFormDataCode1488[Int32] = 7
@EWFormDataCode1489[Int32] = 8
@EWFormDataCode1490[Int32] = 16
@EWFormDataCode1491[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:06:59
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:07:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:07:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:09:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:09:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:10:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:10:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:10:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:11:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:11:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:11:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1492) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1493,@EWFormDataCode1494,@EWFormDataCode1495,@EWFormDataCode1496,@EWFormDataCode1497,@EWFormDataCode1498,@EWFormDataCode1499,@EWFormDataCode1500,@EWFormDataCode1501,@EWFormDataCode1502,@EWFormDataCode1503,@EWFormDataCode1504,@EWFormDataCode1505,@EWFormDataCode1506,@EWFormDataCode1507)) 	
Parameters:
@MenuCode1492[String] = SupplyList
@EWFormDataCode1493[Int32] = 4
@EWFormDataCode1494[Int32] = 9
@EWFormDataCode1495[Int32] = 10
@EWFormDataCode1496[Int32] = 11
@EWFormDataCode1497[Int32] = 13
@EWFormDataCode1498[Int32] = 14
@EWFormDataCode1499[Int32] = 15
@EWFormDataCode1500[Int32] = 17
@EWFormDataCode1501[Int32] = 19
@EWFormDataCode1502[Int32] = 5
@EWFormDataCode1503[Int32] = 6
@EWFormDataCode1504[Int32] = 7
@EWFormDataCode1505[Int32] = 8
@EWFormDataCode1506[Int32] = 16
@EWFormDataCode1507[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:11:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:13:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:13:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:13:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:15:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:15:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:15:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:16:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:16:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1508) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1509,@EWFormDataCode1510,@EWFormDataCode1511,@EWFormDataCode1512,@EWFormDataCode1513,@EWFormDataCode1514,@EWFormDataCode1515,@EWFormDataCode1516,@EWFormDataCode1517,@EWFormDataCode1518,@EWFormDataCode1519,@EWFormDataCode1520,@EWFormDataCode1521,@EWFormDataCode1522,@EWFormDataCode1523)) 	
Parameters:
@MenuCode1508[String] = SupplyList
@EWFormDataCode1509[Int32] = 4
@EWFormDataCode1510[Int32] = 9
@EWFormDataCode1511[Int32] = 10
@EWFormDataCode1512[Int32] = 11
@EWFormDataCode1513[Int32] = 13
@EWFormDataCode1514[Int32] = 14
@EWFormDataCode1515[Int32] = 15
@EWFormDataCode1516[Int32] = 17
@EWFormDataCode1517[Int32] = 19
@EWFormDataCode1518[Int32] = 5
@EWFormDataCode1519[Int32] = 6
@EWFormDataCode1520[Int32] = 7
@EWFormDataCode1521[Int32] = 8
@EWFormDataCode1522[Int32] = 16
@EWFormDataCode1523[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:16:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:17:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:17:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:19:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:19:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:19:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:20:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:20:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:21:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:21:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:21:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1524) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1525,@EWFormDataCode1526,@EWFormDataCode1527,@EWFormDataCode1528,@EWFormDataCode1529,@EWFormDataCode1530,@EWFormDataCode1531,@EWFormDataCode1532,@EWFormDataCode1533,@EWFormDataCode1534,@EWFormDataCode1535,@EWFormDataCode1536,@EWFormDataCode1537,@EWFormDataCode1538,@EWFormDataCode1539)) 	
Parameters:
@MenuCode1524[String] = SupplyList
@EWFormDataCode1525[Int32] = 4
@EWFormDataCode1526[Int32] = 9
@EWFormDataCode1527[Int32] = 10
@EWFormDataCode1528[Int32] = 11
@EWFormDataCode1529[Int32] = 13
@EWFormDataCode1530[Int32] = 14
@EWFormDataCode1531[Int32] = 15
@EWFormDataCode1532[Int32] = 17
@EWFormDataCode1533[Int32] = 19
@EWFormDataCode1534[Int32] = 5
@EWFormDataCode1535[Int32] = 6
@EWFormDataCode1536[Int32] = 7
@EWFormDataCode1537[Int32] = 8
@EWFormDataCode1538[Int32] = 16
@EWFormDataCode1539[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:21:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:22:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:23:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:23:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:25:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:25:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:25:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:25:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:26:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:26:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1540) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1541,@EWFormDataCode1542,@EWFormDataCode1543,@EWFormDataCode1544,@EWFormDataCode1545,@EWFormDataCode1546,@EWFormDataCode1547,@EWFormDataCode1548,@EWFormDataCode1549,@EWFormDataCode1550,@EWFormDataCode1551,@EWFormDataCode1552,@EWFormDataCode1553,@EWFormDataCode1554,@EWFormDataCode1555)) 	
Parameters:
@MenuCode1540[String] = SupplyList
@EWFormDataCode1541[Int32] = 4
@EWFormDataCode1542[Int32] = 9
@EWFormDataCode1543[Int32] = 10
@EWFormDataCode1544[Int32] = 11
@EWFormDataCode1545[Int32] = 13
@EWFormDataCode1546[Int32] = 14
@EWFormDataCode1547[Int32] = 15
@EWFormDataCode1548[Int32] = 17
@EWFormDataCode1549[Int32] = 19
@EWFormDataCode1550[Int32] = 5
@EWFormDataCode1551[Int32] = 6
@EWFormDataCode1552[Int32] = 7
@EWFormDataCode1553[Int32] = 8
@EWFormDataCode1554[Int32] = 16
@EWFormDataCode1555[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:27:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:27:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:28:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:29:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:29:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:30:58
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:30:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:31:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:31:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:31:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1556) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1557,@EWFormDataCode1558,@EWFormDataCode1559,@EWFormDataCode1560,@EWFormDataCode1561,@EWFormDataCode1562,@EWFormDataCode1563,@EWFormDataCode1564,@EWFormDataCode1565,@EWFormDataCode1566,@EWFormDataCode1567,@EWFormDataCode1568,@EWFormDataCode1569,@EWFormDataCode1570,@EWFormDataCode1571)) 	
Parameters:
@MenuCode1556[String] = SupplyList
@EWFormDataCode1557[Int32] = 4
@EWFormDataCode1558[Int32] = 9
@EWFormDataCode1559[Int32] = 10
@EWFormDataCode1560[Int32] = 11
@EWFormDataCode1561[Int32] = 13
@EWFormDataCode1562[Int32] = 14
@EWFormDataCode1563[Int32] = 15
@EWFormDataCode1564[Int32] = 17
@EWFormDataCode1565[Int32] = 19
@EWFormDataCode1566[Int32] = 5
@EWFormDataCode1567[Int32] = 6
@EWFormDataCode1568[Int32] = 7
@EWFormDataCode1569[Int32] = 8
@EWFormDataCode1570[Int32] = 16
@EWFormDataCode1571[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:31:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:31:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:33:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:33:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:34:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:35:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:35:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:35:58
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:36:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:36:01
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1572) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode1573,@EWFormDataCode1574,@EWFormDataCode1575,@EWFormDataCode1576,@EWFormDataCode1577,@EWFormDataCode1578,@EWFormDataCode1579,@EWFormDataCode1580,@EWFormDataCode1581,@EWFormDataCode1582,@EWFormDataCode1583,@EWFormDataCode1584,@EWFormDataCode1585,@EWFormDataCode1586,@EWFormDataCode1587)) 	
Parameters:
@MenuCode1572[String] = SupplyList
@EWFormDataCode1573[Int32] = 4
@EWFormDataCode1574[Int32] = 9
@EWFormDataCode1575[Int32] = 10
@EWFormDataCode1576[Int32] = 11
@EWFormDataCode1577[Int32] = 13
@EWFormDataCode1578[Int32] = 14
@EWFormDataCode1579[Int32] = 15
@EWFormDataCode1580[Int32] = 17
@EWFormDataCode1581[Int32] = 19
@EWFormDataCode1582[Int32] = 5
@EWFormDataCode1583[Int32] = 6
@EWFormDataCode1584[Int32] = 7
@EWFormDataCode1585[Int32] = 8
@EWFormDataCode1586[Int32] = 16
@EWFormDataCode1587[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:37:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:37:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:37:38
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 6487716734823440384
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:39:00
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:39:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:41:02
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode2,@EWFormDataCode3,@EWFormDataCode4,@EWFormDataCode5,@EWFormDataCode6,@EWFormDataCode7,@EWFormDataCode8,@EWFormDataCode9,@EWFormDataCode10,@EWFormDataCode11,@EWFormDataCode12,@EWFormDataCode13,@EWFormDataCode14,@EWFormDataCode15,@EWFormDataCode16)) 	
Parameters:
@MenuCode1[String] = SupplyList
@EWFormDataCode2[Int32] = 4
@EWFormDataCode3[Int32] = 9
@EWFormDataCode4[Int32] = 10
@EWFormDataCode5[Int32] = 11
@EWFormDataCode6[Int32] = 13
@EWFormDataCode7[Int32] = 14
@EWFormDataCode8[Int32] = 15
@EWFormDataCode9[Int32] = 17
@EWFormDataCode10[Int32] = 19
@EWFormDataCode11[Int32] = 5
@EWFormDataCode12[Int32] = 6
@EWFormDataCode13[Int32] = 7
@EWFormDataCode14[Int32] = 8
@EWFormDataCode15[Int32] = 16
@EWFormDataCode16[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:42:03
Text:	select tsm.* from TbRoleMenu tum
                           left join TbSysMenu tsm on tum.MenuCode=tsm.MenuCode
                           where tsm.IsShow=0 and tsm.MenuType='PC' and tum.RoleCode in('6337324142387400704','6352967650544590848') order by tsm.Sort asc	


-----------------------------------------------------------------------------
2019-12-17 17:42:03
Text:	select 
                        	tsm.*
                        from TbUserMenu tum
                        left join TbSysMenu tsm on tum.MenuCode=tsm.MenuCode
                        where tsm.IsShow=0 and tsm.MenuType='PC' and tum.UserCode=@userCode order by tsm.Sort asc	
Parameters:
@userCode[String] = 6487716734823440384


-----------------------------------------------------------------------------
2019-12-17 17:42:03
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	select 
                            cf.Capacity,
                            Tb1.WeightSmallPlan as ActualOutputValueNew,
                            cast(Tb1.WeightSmallPlan/cf.Capacity*100 as decimal(18,2)) as ActualLoadNew 
                            from TbCapacityFilling cf
                            left JOIN
                            (
                            	select 
                            	SUM(Tb.WeightSmallPlan) as WeightSmallPlan 
                            	from 
                            	(
                            		select 
                            		isnull(SUM(wod.WeightSmallPlan),0) as WeightSmallPlan 
                            		from TbDistributionPlanInfo wo
                            		left join TbDistributionPlanDetailInfo wod on wo.OrderCode=wod.OrderCode
                            		where (ISNULL(@ProcessFactoryCode,'')='' or wo.ProcessFactoryCode=@ProcessFactoryCode) 
                            		and wo.ProcessingState!='ConfirmWork' and wo.ProcessingState!='Finishing'
                            		and MONTH(wo.DistributionTime)=@month
                            		and wod.RevokeStart='正常'
                            		union ALL --扣除加工中订单明细已加工完成的数据
                            		SELECT -1*isnull(SUM(opd.AlreadyCompleted),0)as Completed 
                            		FROM TbDistributionPlanInfo wo
                            		LEFT JOIN TbOrderProgressDetail opd ON wo.OrderCode=opd.OrderCode AND opd.DaetailWorkStrat='加工完成'
                            		WHERE (ISNULL(@ProcessFactoryCode,'')='' or wo.ProcessFactoryCode=@ProcessFactoryCode) 
                            		and wo.ProcessingState='Processing'and MONTH(wo.DistributionTime)=@month
                            		union all
                            		select 
                            		isnull(sum(opd.NoCompleted),0) as NoCompleted 
                            		from TbOrderProgress op
                            		left join TbOrderProgressDetail opd on op.OrderCode=opd.OrderCode 
                            		where (ISNULL(@ProcessFactoryCode,'')='' or op.ProcessFactoryCode=@ProcessFactoryCode)
                            		and MONTH(op.DistributionTime)=@month-1
                            		and opd.RevokeStart='正常'
                            	)Tb
                            ) Tb1 on cf.CapacityMonth=@month
                            where cf.CapacityMonth=@month 
                            and (ISNULL(@ProcessFactoryCode,'')='' or cf.ProcessFactoryCode=@ProcessFactoryCode)	
Parameters:
@ProcessFactoryCode[String] = 
@month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	--库存量
                           select isnull(sum(rsr.Count),0) as TotelNum from TbRawMaterialStockRecord rsr
                           left join TbStorage s on rsr.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) and rsr.ChackState=1
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode) and (rsr.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rsr.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           union all
                           --配送量
                           select isnull(SUM(WeightTotal),0.0000) DistributionTotal 
                           from TbDistributionPlanInfo 
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) 
                           --and datediff(month,InsertTime,getdate())=0
                           and MONTH(InsertTime)=@Month and DistributionStart='配送完成'
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           union all
                           --签收量
                           select isnull(Sum(SumTotal),0.0000) SumTotal 
                           from TbSemiFinishedSign 
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) 
                           --and datediff(month,SigninTime,getdate())=0
                           and MONTH(SigninTime)=@Month
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           union all
                           --加工完成量
                           select isnull(sum(opd.AlreadyCompleted),0) as AlreadyCompleted 
                           from TbOrderProgress op left join TbOrderProgressDetail opd on op.OrderCode=opd.OrderCode  
                           --where MONTH(op.InsertTime)=DATENAME(MONTH,GETDATE()) 
                           and MONTH(op.InsertTime)=@Month
                           and WeightSmallPlan=AlreadyCompleted 
                           and (ISNULL(@ProjectId,'')='' or op.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	SELECT sm.MenuName,fwqi.EWContent,fwqi.EWUserCode,u.UserName,fwqi.EWFormDataCode,cp1.CompanyFullName as  FbName,cp2.CompanyFullName as GqName,fwqi.EWTime,sdd.DictionaryText as RebarType  
                   FROM (  
                    select ret.*
                    FROM ( 
                         SELECT *, row_number()over(partition BY EarlyWarningCode,EWFormDataCode ORDER BY EWNodeCode,EWTime desc) as group_idx 
                         FROM TbFormEarlyWarningNodeInfo fwqi
                         WHERE YEAR(fwqi.EWTime)= @Year and MONTH(fwqi.EWTime)= @Month AND fwqi.MenuCode='RawMonthDemandPlan' AND fwqi.EWStart=0
                    ) ret
                    WHERE ret.group_idx = 1
                   ) fwqi
                    left join TbSysMenu sm on fwqi.MenuCode=sm.MenuCode
                            left join TbCompany cp1 on fwqi.CompanyCode=cp1.CompanyCode
                            left join TbCompany cp2 on fwqi.WorkArea=cp2.CompanyCode
                            left join TbCompany cp3 on fwqi.SiteCode=cp3.CompanyCode
                            left join TbUser u on fwqi.EWUserCode=u.UserId
                            left join TbRawMaterialMonthDemandPlan rmp on fwqi.EWFormDataCode=rmp.ID
                            left join TbSysDictionaryData sdd on sdd.DictionaryCode=rmp.RebarType
                    where 1=1 and fwqi.ProjectId='6245721945602523136' and (fwqi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fwqi.WorkArea in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) ORDER BY fwqi.EWTime DESC	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:05
Text:	
                        select 
                         left(substring(fewoi.EarlyWarningContent, charindex(N'《',fewoi.EarlyWarningContent)+1, charindex(N'》',
                         fewoi.EarlyWarningContent)-1),charindex('》',substring(fewoi.EarlyWarningContent, charindex(N'《',fewoi.EarlyWarningContent)+1, charindex(N'》',fewoi.EarlyWarningContent)-1))-1) as OddNumbers,
                         fewoi.EarlyWarningContent,
                         fewoi.EWFormDataCode,
                         CONVERT(varchar(100), fewoi.EarlyWarningTime, 120) as EarlyWarningTime,
                         EWFormCode,sm.MenuName,fn.FlowNodeName,cp1.CompanyFullName as BranchName,
                         cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,
                         u1.UserName as FlowSpUserName,u2.UserName as FlowYjUserName 
                        FROM (
                        select*
                           FROM ( 
                        		SELECT a.*, row_number()over(partition BY a.FlowCode ORDER BY a.FlowNodeCode,a.EarlyWarningTime desc) as group_idx 
                        		FROM TbFlowEarlyWarningOtherInfo  a
                        		INNER JOIN  TbFlowEarlyWarningInfo b ON a.FlowCode=b.FlowCode 
                        		AND a.EWFormDataCode=b.EWFormDataCode AND a.FlowNodeCode=b.FlowNodeCode 
                        		WHERE YEAR(a.EarlyWarningTime)= @Year and MONTH(a.EarlyWarningTime)= @Month AND b.EarlyWarningStart=0
                           ) ret
                        WHERE ret.group_idx =1
                        ) fewoi
                        left join TbFlowNode fn on fewoi.FlowCode=fn.FlowCode and fewoi.FlowNodeCode=fn.FlowNodeCode
                        left join TbSysMenu sm on fewoi.EWFormCode=sm.MenuCode
                        left join TbCompany cp1 on fewoi.BranchCode=cp1.CompanyCode
                        left join TbCompany cp2 on fewoi.WorkAreaCode=cp2.CompanyCode
                        left join TbCompany cp3 on fewoi.SiteCode=cp3.CompanyCode
                        left join TbCompany cp4 on fewoi.ProcessFactoryCode=cp4.CompanyCode
                        left join TbUser u1 on fewoi.FlowSpUserCode=u1.UserId
                        left join TbUser u2 on fewoi.FlowYjUserCode=u2.UserId where 1=1 and fewoi.ProjectId='6245721945602523136' and (fewoi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fewoi.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) ORDER BY fewoi.EarlyWarningTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	--加急订单个数
                           select wo.OrderCode,wo.DistributionTime,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName from TbWorkOrder wo
                           left join TbCompany cp1 on wo.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on wo.ProcessFactoryCode=cp2.CompanyCode
                           where UrgentDegree='Urgent'
                           and YEAR(wo.DistributionTime)= @Year and MONTH(wo.DistributionTime)= @Month  and wo.ProjectId='6245721945602523136' and wo.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')  ORDER BY wo.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	--加工进度滞后
                           select op.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,op.DistributionTime,op.FinishProcessingDateTime from TbOrderProgress op 
                           left join TbCompany cp1 on op.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on op.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(op.DistributionTime)= @Year and MONTH(op.DistributionTime)= @Month
                           and (op.FinishProcessingDateTime>op.DistributionTime or (GETDATE()>op.DistributionTime and op.FinishProcessingDateTime is null))  and op.ProjectId='6245721945602523136' and op.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY op.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	SELECT 
                            '审批超时' as YjTypeName,COUNT(1) as YjNum
                            FROM (
									SELECT a.*, row_number()over(partition BY a.FlowCode ORDER BY a.FlowNodeCode,a.EarlyWarningTime desc) as group_idx 
									FROM TbFlowEarlyWarningOtherInfo  a
									INNER JOIN  TbFlowEarlyWarningInfo b ON a.FlowCode=b.FlowCode 
									AND a.EWFormDataCode=b.EWFormDataCode AND a.FlowNodeCode=b.FlowNodeCode 
									WHERE  b.EarlyWarningStart=0 AND YEAR(a.EarlyWarningTime)= @Year and MONTH(a.EarlyWarningTime)= @Month  and a.ProjectId='6245721945602523136' and (a.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or a.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
							   ) Tb1
                            WHERE Tb1.group_idx =1
                           union all
                            select '未报月度需求计划' as YjTypeName,COUNT(1)as YjNum
                             FROM ( 
                                  SELECT *, row_number()over(partition BY EarlyWarningCode,EWFormDataCode ORDER BY EWNodeCode,EWTime desc) as group_idx 
                                  FROM TbFormEarlyWarningNodeInfo fwqi
                                  WHERE fwqi.MenuCode='RawMonthDemandPlan' AND fwqi.EWStart=0 AND YEAR(fwqi.EWTime)= @Year and MONTH(fwqi.EWTime)= @Month  and fwqi.ProjectId='6245721945602523136' and (fwqi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fwqi.WorkArea in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))  
                             ) Tb2
                             WHERE Tb2.group_idx =1
                           union all
                           select '原材料供货超时' as YjTypeName,COUNT(1) as YjNum from (
                           select BatchPlanNum,cp1.CompanyFullName as BranchName,cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,sup.SupplyDate,sup.SupplyCompleteTime,sup.ProjectId from TbSupplyList sup
                           left join TbCompany cp1 on cp1.CompanyCode=sup.BranchCode
                           left join TbCompany cp2 on cp2.CompanyCode=sup.WorkAreaCode
                           left join TbCompany cp3 on cp3.CompanyCode=sup.SiteCode
                           left join TbCompany cp4 on cp4.CompanyCode=sup.ProcessFactoryCode
                           where (sup.SupplyCompleteTime>sup.SupplyDate or (GETDATE()>sup.SupplyDate and sup.SupplyCompleteTime is null))
						   and YEAR(sup.SupplyDate)= @Year and MONTH(sup.SupplyDate)= @Month  and sup.ProjectId='6245721945602523136' and (sup.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or sup.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))) Tb3
                           union all
                           select '加急订单' as YjTypeName,COUNT(1) as YjNum from (--加急订单个数
                           select wo.OrderCode,wo.DistributionTime,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName from TbWorkOrder wo
                           left join TbCompany cp1 on wo.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on wo.ProcessFactoryCode=cp2.CompanyCode
                           where UrgentDegree='Urgent' 
						   and YEAR(wo.DistributionTime)= @Year and MONTH(wo.DistributionTime)= @Month  and wo.ProjectId='6245721945602523136' and wo.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb4
                           union all
                           select '加工进度滞后' as YjTypeName,COUNT(1) as YjNum from (--加工进度滞后
                           select op.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,op.DistributionTime,op.FinishProcessingDateTime from TbOrderProgress op 
                           left join TbCompany cp1 on op.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on op.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(op.DistributionTime)= @Year and MONTH(op.DistributionTime)= @Month
                           and (op.FinishProcessingDateTime>op.DistributionTime or (GETDATE()>op.DistributionTime and op.FinishProcessingDateTime is null))  and op.ProjectId='6245721945602523136' and op.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb5
                           union all
                           select '接收配送超期' as YjTypeName,COUNT(1) as YjNum from (--配送超期
                           select dpi.OrderCode,cp1.CompanyFullName as SIteName,cp2.CompanyFullName as ProcessFactoryName,dpi.DistributionTime,dpi.DeliveryCompleteTime from TbDistributionPlanInfo dpi
                           left join TbCompany cp1 on dpi.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on dpi.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(dpi.DistributionTime)= @Year and MONTH(dpi.DistributionTime)= @Month
                           and (dpi.DeliveryCompleteTime>dpi.DistributionTime or (GETDATE()>dpi.DistributionTime and dpi.DeliveryCompleteTime is null))  and dpi.ProjectId='6245721945602523136' and dpi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb6 
                           union all
                           select '卸货超时' as YjTypeName,COUNT(1) as YjNum from(--卸货超时
                           select TbYj.*,cp1.CompanyFullName as SiteName,tcr.EnterSpaceTime,tcr.StartDischargeTime,tcr.EndDischargeTime,disEnt.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SiteDischargeCargo' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbTransportCarReport tcr on TbYj.EWFormDataCode=tcr.DisEntOrderId
                           left join TbDistributionEnt disEnt on tcr.DistributionCode=disEnt.DistributionCode
                           left join TbCompany cp on disEnt.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb7
                           union all
                           select '签收超时' as YjTypeName,COUNT(1) as YjNum from (select TbYj.*,cp1.CompanyFullName as SiteName,sfs.DistributionCode,sdc.DistributionTime,sfs.SigninTime,sfs.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SemiFinishedSign' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbSemiFinishedSign sfs on TbYj.EWFormDataCode=sfs.ID
                           left join TbSiteDischargeCargo sdc on sfs.DistributionCode=sdc.DistributionCode and sfs.DischargeCargoCode=sdc.DischargeCargoCode
                           left join TbCompany cp on sfs.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb8	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	--配送超期
                           select dpi.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,dpi.DistributionTime,dpi.DeliveryCompleteTime,dpi.Remark from TbDistributionPlanInfo dpi
                           left join TbCompany cp1 on dpi.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on dpi.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(dpi.DistributionTime)= @Year and MONTH(dpi.DistributionTime)= @Month
                           and (dpi.DeliveryCompleteTime>dpi.DistributionTime or (GETDATE()>dpi.DistributionTime and dpi.DeliveryCompleteTime is null))  and dpi.ProjectId='6245721945602523136' and dpi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY dpi.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	select TbYj.*,cp1.CompanyFullName as SiteName,tcr.EnterSpaceTime,tcr.StartDischargeTime,tcr.EndDischargeTime,disEnt.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SiteDischargeCargo' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbTransportCarReport tcr on TbYj.EWFormDataCode=tcr.DisEntOrderId
                           left join TbDistributionEnt disEnt on tcr.DistributionCode=disEnt.DistributionCode
                           left join TbCompany cp on disEnt.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY tcr.EnterSpaceTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	select TbYj.*,cp1.CompanyFullName as SiteName,sfs.DistributionCode,sdc.DistributionTime,sfs.SigninTime,sfs.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SemiFinishedSign' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbSemiFinishedSign sfs on TbYj.EWFormDataCode=sfs.ID
                           left join TbSiteDischargeCargo sdc on sfs.DistributionCode=sdc.DistributionCode and sfs.DischargeCargoCode=sdc.DischargeCargoCode
                           left join TbCompany cp on sfs.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:06
Text:	--原材料供货超时
                           select BatchPlanNum,cp1.CompanyFullName as BranchName,cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,sup.SupplyDate,sup.SupplyCompleteTime,sup.ProjectId,sup.Remarks from TbSupplyList sup
                           left join TbCompany cp1 on cp1.CompanyCode=sup.BranchCode
                           left join TbCompany cp2 on cp2.CompanyCode=sup.WorkAreaCode
                           left join TbCompany cp3 on cp3.CompanyCode=sup.SiteCode
                           left join TbCompany cp4 on cp4.CompanyCode=sup.ProcessFactoryCode
                           where YEAR(sup.SupplyDate)= @Year and MONTH(sup.SupplyDate)= @Month
                           and (sup.SupplyCompleteTime>sup.SupplyDate or (GETDATE()>sup.SupplyDate and sup.SupplyCompleteTime is null))  and sup.ProjectId='6245721945602523136' and (sup.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or sup.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:07
Text:	select tcr.*,cp.CompanyFullName as SiteName,ci.CarCph+tu.UserName AS CarCph,de.Enclosure from TbTransportCarReport  tcr
                           left join TbCompany cp on tcr.SiteCode=cp.CompanyCode
                           left join TbCarInfo ci on tcr.VehicleCode=ci.CarCode
                           left join TbDistributionEnt de on tcr.DistributionCode=de.DistributionCode
                           LEFT JOIN TbUser tu ON tu.UserCode=de.Driver
                           where (ISNULL(@ProjectId,'')='' or tcr.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or de.ProcessFactoryCode=@ProcessFactoryCode)
                           and (tcr.IsProblem='是' or tcr.FlowState=2) 
                           and YEAR(tcr.EndDischargeTime)= @Year and MONTH(tcr.EndDischargeTime)= @Month and tcr.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           order by id desc	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	SELECT mm.MenuUrl, pp.UserCode, pp.menuCode, pp.OperationView, pp.OperationAdd
	                        , pp.OperationEdit, pp.OperationDel, pp.OperationExamination, pp.OperationOutput, pp.OperationOther1
	                        , mm.OperationOther1Fun, mm.OperationOther1IconCls, pp.OperationOther2, mm.OperationOther2Fun, mm.OperationOther2IconCls
	                        , pp.OperationOther3, mm.OperationOther3Fun, mm.OperationOther3IconCls, pp.OperationOther4, mm.OperationOther4Fun
	                        , mm.OperationOther4IconCls, pp.OperationOther5, mm.OperationOther5Fun, mm.OperationOther5IconCls
                        FROM (
	                        SELECT UserCode, menuCode, MAX(OperationView) AS OperationView
		                        , MAX(OperationAdd) AS OperationAdd, MAX(OperationEdit) AS OperationEdit
		                        , MAX(OperationDel) AS OperationDel, MAX(OperationExamination) AS OperationExamination
		                        , MAX(OperationOutput) AS OperationOutput, MAX(OperationOther1) AS OperationOther1
		                        , MAX(OperationOther2) AS OperationOther2, MAX(OperationOther3) AS OperationOther3
		                        , MAX(OperationOther4) AS OperationOther4, MAX(OperationOther5) AS OperationOther5
	                        FROM (
		                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
			                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
			                        , OperationOther3, OperationOther4, OperationOther5
		                        FROM (
			                        SELECT a.UserCode, b.menuCode, MAX(b.OperationView) AS OperationView
				                        , MAX(b.OperationAdd) AS OperationAdd, MAX(b.OperationEdit) AS OperationEdit
				                        , MAX(b.OperationDel) AS OperationDel, MAX(b.OperationExamination) AS OperationExamination
				                        , MAX(b.OperationOutput) AS OperationOutput, MAX(b.OperationOther1) AS OperationOther1
				                        , MAX(b.OperationOther2) AS OperationOther2, MAX(b.OperationOther3) AS OperationOther3
				                        , MAX(b.OperationOther4) AS OperationOther4, MAX(b.OperationOther5) AS OperationOther5
			                        FROM dbo.TbUserRole a
				                        INNER JOIN dbo.TbRoleMenu b ON a.RoleCode = b.RoleCode
                                        where b.RoleCode in('6337324142387400704','6352967650544590848')
			                        GROUP BY a.UserCode, b.menuCode
			                        UNION ALL
			                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
				                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
				                        , OperationOther3, OperationOther4, OperationOther5
			                        FROM dbo.TbUserMenu
			                        union all
			                        SELECT p.UserCode, d.menuCode, MAX(d.OperationView) AS OperationView
				                        , MAX(d.OperationAdd) AS OperationAdd, MAX(d.OperationEdit) AS OperationEdit
				                        , MAX(d.OperationDel) AS OperationDel, MAX(d.OperationExamination) AS OperationExamination
				                        , MAX(d.OperationOutput) AS OperationOutput, MAX(d.OperationOther1) AS OperationOther1
				                        , MAX(d.OperationOther2) AS OperationOther2, MAX(d.OperationOther3) AS OperationOther3
				                        , MAX(d.OperationOther4) AS OperationOther4, MAX(d.OperationOther5) AS OperationOther5
			                        FROM dbo.TbPositionUser p
				                        INNER JOIN dbo.TbPositionMenu d ON p.PositionCode = d.PositionCode
			                        GROUP BY p.UserCode, d.menuCode
			
		                        ) c
	                        ) aa
	                        GROUP BY UserCode, menuCode
                        ) pp
                        INNER JOIN dbo.TbSysMenu mm ON pp.menuCode = mm.menuCode 
                        left join dbo.TbUser u on pp.UserCode=u.UserId
                        where u.UserCode=@UserCode And mm.MenuUrl=@menuURI	
Parameters:
@UserCode[String] = 102787
@menuURI[String] = /RawMaterial/RawMaterialStock/Index


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rms.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:42:50
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rms.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:42:51
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:42:55
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:42:55
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 17:42:55
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:42:55
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688') and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688') and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1 	


-----------------------------------------------------------------------------
2019-12-17 17:43:14
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:43:14
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	SELECT mm.MenuUrl, pp.UserCode, pp.menuCode, pp.OperationView, pp.OperationAdd
	                        , pp.OperationEdit, pp.OperationDel, pp.OperationExamination, pp.OperationOutput, pp.OperationOther1
	                        , mm.OperationOther1Fun, mm.OperationOther1IconCls, pp.OperationOther2, mm.OperationOther2Fun, mm.OperationOther2IconCls
	                        , pp.OperationOther3, mm.OperationOther3Fun, mm.OperationOther3IconCls, pp.OperationOther4, mm.OperationOther4Fun
	                        , mm.OperationOther4IconCls, pp.OperationOther5, mm.OperationOther5Fun, mm.OperationOther5IconCls
                        FROM (
	                        SELECT UserCode, menuCode, MAX(OperationView) AS OperationView
		                        , MAX(OperationAdd) AS OperationAdd, MAX(OperationEdit) AS OperationEdit
		                        , MAX(OperationDel) AS OperationDel, MAX(OperationExamination) AS OperationExamination
		                        , MAX(OperationOutput) AS OperationOutput, MAX(OperationOther1) AS OperationOther1
		                        , MAX(OperationOther2) AS OperationOther2, MAX(OperationOther3) AS OperationOther3
		                        , MAX(OperationOther4) AS OperationOther4, MAX(OperationOther5) AS OperationOther5
	                        FROM (
		                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
			                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
			                        , OperationOther3, OperationOther4, OperationOther5
		                        FROM (
			                        SELECT a.UserCode, b.menuCode, MAX(b.OperationView) AS OperationView
				                        , MAX(b.OperationAdd) AS OperationAdd, MAX(b.OperationEdit) AS OperationEdit
				                        , MAX(b.OperationDel) AS OperationDel, MAX(b.OperationExamination) AS OperationExamination
				                        , MAX(b.OperationOutput) AS OperationOutput, MAX(b.OperationOther1) AS OperationOther1
				                        , MAX(b.OperationOther2) AS OperationOther2, MAX(b.OperationOther3) AS OperationOther3
				                        , MAX(b.OperationOther4) AS OperationOther4, MAX(b.OperationOther5) AS OperationOther5
			                        FROM dbo.TbUserRole a
				                        INNER JOIN dbo.TbRoleMenu b ON a.RoleCode = b.RoleCode
                                        where b.RoleCode in('6337324142387400704','6352967650544590848')
			                        GROUP BY a.UserCode, b.menuCode
			                        UNION ALL
			                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
				                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
				                        , OperationOther3, OperationOther4, OperationOther5
			                        FROM dbo.TbUserMenu
			                        union all
			                        SELECT p.UserCode, d.menuCode, MAX(d.OperationView) AS OperationView
				                        , MAX(d.OperationAdd) AS OperationAdd, MAX(d.OperationEdit) AS OperationEdit
				                        , MAX(d.OperationDel) AS OperationDel, MAX(d.OperationExamination) AS OperationExamination
				                        , MAX(d.OperationOutput) AS OperationOutput, MAX(d.OperationOther1) AS OperationOther1
				                        , MAX(d.OperationOther2) AS OperationOther2, MAX(d.OperationOther3) AS OperationOther3
				                        , MAX(d.OperationOther4) AS OperationOther4, MAX(d.OperationOther5) AS OperationOther5
			                        FROM dbo.TbPositionUser p
				                        INNER JOIN dbo.TbPositionMenu d ON p.PositionCode = d.PositionCode
			                        GROUP BY p.UserCode, d.menuCode
			
		                        ) c
	                        ) aa
	                        GROUP BY UserCode, menuCode
                        ) pp
                        INNER JOIN dbo.TbSysMenu mm ON pp.menuCode = mm.menuCode 
                        left join dbo.TbUser u on pp.UserCode=u.UserId
                        where u.UserCode=@UserCode And mm.MenuUrl=@menuURI	
Parameters:
@UserCode[String] = 102787
@menuURI[String] = /RawMaterial/RawMaterialStock/Index


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rms.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:43:21
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rms.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:43:26
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 17:43:28
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:43:28
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688') and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688') and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1 	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode17) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode18,@EWFormDataCode19,@EWFormDataCode20,@EWFormDataCode21,@EWFormDataCode22,@EWFormDataCode23,@EWFormDataCode24,@EWFormDataCode25,@EWFormDataCode26,@EWFormDataCode27,@EWFormDataCode28,@EWFormDataCode29,@EWFormDataCode30,@EWFormDataCode31,@EWFormDataCode32)) 	
Parameters:
@MenuCode17[String] = SupplyList
@EWFormDataCode18[Int32] = 4
@EWFormDataCode19[Int32] = 9
@EWFormDataCode20[Int32] = 10
@EWFormDataCode21[Int32] = 11
@EWFormDataCode22[Int32] = 13
@EWFormDataCode23[Int32] = 14
@EWFormDataCode24[Int32] = 15
@EWFormDataCode25[Int32] = 17
@EWFormDataCode26[Int32] = 19
@EWFormDataCode27[Int32] = 5
@EWFormDataCode28[Int32] = 6
@EWFormDataCode29[Int32] = 7
@EWFormDataCode30[Int32] = 8
@EWFormDataCode31[Int32] = 16
@EWFormDataCode32[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:51:13
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:53:01
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:53:01
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:53:01
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:53:01
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:53:01
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:53:02
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode1) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode2,@EWFormDataCode3,@EWFormDataCode4,@EWFormDataCode5,@EWFormDataCode6,@EWFormDataCode7,@EWFormDataCode8,@EWFormDataCode9,@EWFormDataCode10,@EWFormDataCode11,@EWFormDataCode12,@EWFormDataCode13,@EWFormDataCode14,@EWFormDataCode15,@EWFormDataCode16)) 	
Parameters:
@MenuCode1[String] = SupplyList
@EWFormDataCode2[Int32] = 4
@EWFormDataCode3[Int32] = 9
@EWFormDataCode4[Int32] = 10
@EWFormDataCode5[Int32] = 11
@EWFormDataCode6[Int32] = 13
@EWFormDataCode7[Int32] = 14
@EWFormDataCode8[Int32] = 15
@EWFormDataCode9[Int32] = 17
@EWFormDataCode10[Int32] = 19
@EWFormDataCode11[Int32] = 5
@EWFormDataCode12[Int32] = 6
@EWFormDataCode13[Int32] = 7
@EWFormDataCode14[Int32] = 8
@EWFormDataCode15[Int32] = 16
@EWFormDataCode16[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:53:05
Text:	select tsm.* from TbRoleMenu tum
                           left join TbSysMenu tsm on tum.MenuCode=tsm.MenuCode
                           where tsm.IsShow=0 and tsm.MenuType='PC' and tum.RoleCode in('6337324142387400704','6352967650544590848') order by tsm.Sort asc	


-----------------------------------------------------------------------------
2019-12-17 17:53:05
Text:	select 
                        	tsm.*
                        from TbUserMenu tum
                        left join TbSysMenu tsm on tum.MenuCode=tsm.MenuCode
                        where tsm.IsShow=0 and tsm.MenuType='PC' and tum.UserCode=@userCode order by tsm.Sort asc	
Parameters:
@userCode[String] = 6487716734823440384


-----------------------------------------------------------------------------
2019-12-17 17:53:06
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	--库存量
                           select isnull(sum(rsr.Count),0) as TotelNum from TbRawMaterialStockRecord rsr
                           left join TbStorage s on rsr.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) and rsr.ChackState=1
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode) and (rsr.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rsr.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
                           union all
                           --配送量
                           select isnull(SUM(WeightTotal),0.0000) DistributionTotal 
                           from TbDistributionPlanInfo 
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) 
                           --and datediff(month,InsertTime,getdate())=0
                           and MONTH(InsertTime)=@Month and DistributionStart='配送完成'
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           union all
                           --签收量
                           select isnull(Sum(SumTotal),0.0000) SumTotal 
                           from TbSemiFinishedSign 
                           where (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId) 
                           --and datediff(month,SigninTime,getdate())=0
                           and MONTH(SigninTime)=@Month
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           union all
                           --加工完成量
                           select isnull(sum(opd.AlreadyCompleted),0) as AlreadyCompleted 
                           from TbOrderProgress op left join TbOrderProgressDetail opd on op.OrderCode=opd.OrderCode  
                           --where MONTH(op.InsertTime)=DATENAME(MONTH,GETDATE()) 
                           and MONTH(op.InsertTime)=@Month
                           and WeightSmallPlan=AlreadyCompleted 
                           and (ISNULL(@ProjectId,'')='' or op.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or ProcessFactoryCode=@ProcessFactoryCode) and SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	select 
                            cf.Capacity,
                            Tb1.WeightSmallPlan as ActualOutputValueNew,
                            cast(Tb1.WeightSmallPlan/cf.Capacity*100 as decimal(18,2)) as ActualLoadNew 
                            from TbCapacityFilling cf
                            left JOIN
                            (
                            	select 
                            	SUM(Tb.WeightSmallPlan) as WeightSmallPlan 
                            	from 
                            	(
                            		select 
                            		isnull(SUM(wod.WeightSmallPlan),0) as WeightSmallPlan 
                            		from TbDistributionPlanInfo wo
                            		left join TbDistributionPlanDetailInfo wod on wo.OrderCode=wod.OrderCode
                            		where (ISNULL(@ProcessFactoryCode,'')='' or wo.ProcessFactoryCode=@ProcessFactoryCode) 
                            		and wo.ProcessingState!='ConfirmWork' and wo.ProcessingState!='Finishing'
                            		and MONTH(wo.DistributionTime)=@month
                            		and wod.RevokeStart='正常'
                            		union ALL --扣除加工中订单明细已加工完成的数据
                            		SELECT -1*isnull(SUM(opd.AlreadyCompleted),0)as Completed 
                            		FROM TbDistributionPlanInfo wo
                            		LEFT JOIN TbOrderProgressDetail opd ON wo.OrderCode=opd.OrderCode AND opd.DaetailWorkStrat='加工完成'
                            		WHERE (ISNULL(@ProcessFactoryCode,'')='' or wo.ProcessFactoryCode=@ProcessFactoryCode) 
                            		and wo.ProcessingState='Processing'and MONTH(wo.DistributionTime)=@month
                            		union all
                            		select 
                            		isnull(sum(opd.NoCompleted),0) as NoCompleted 
                            		from TbOrderProgress op
                            		left join TbOrderProgressDetail opd on op.OrderCode=opd.OrderCode 
                            		where (ISNULL(@ProcessFactoryCode,'')='' or op.ProcessFactoryCode=@ProcessFactoryCode)
                            		and MONTH(op.DistributionTime)=@month-1
                            		and opd.RevokeStart='正常'
                            	)Tb
                            ) Tb1 on cf.CapacityMonth=@month
                            where cf.CapacityMonth=@month 
                            and (ISNULL(@ProcessFactoryCode,'')='' or cf.ProcessFactoryCode=@ProcessFactoryCode)	
Parameters:
@ProcessFactoryCode[String] = 
@month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	
                        select 
                         left(substring(fewoi.EarlyWarningContent, charindex(N'《',fewoi.EarlyWarningContent)+1, charindex(N'》',
                         fewoi.EarlyWarningContent)-1),charindex('》',substring(fewoi.EarlyWarningContent, charindex(N'《',fewoi.EarlyWarningContent)+1, charindex(N'》',fewoi.EarlyWarningContent)-1))-1) as OddNumbers,
                         fewoi.EarlyWarningContent,
                         fewoi.EWFormDataCode,
                         CONVERT(varchar(100), fewoi.EarlyWarningTime, 120) as EarlyWarningTime,
                         EWFormCode,sm.MenuName,fn.FlowNodeName,cp1.CompanyFullName as BranchName,
                         cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,
                         u1.UserName as FlowSpUserName,u2.UserName as FlowYjUserName 
                        FROM (
                        select*
                           FROM ( 
                        		SELECT a.*, row_number()over(partition BY a.FlowCode ORDER BY a.FlowNodeCode,a.EarlyWarningTime desc) as group_idx 
                        		FROM TbFlowEarlyWarningOtherInfo  a
                        		INNER JOIN  TbFlowEarlyWarningInfo b ON a.FlowCode=b.FlowCode 
                        		AND a.EWFormDataCode=b.EWFormDataCode AND a.FlowNodeCode=b.FlowNodeCode 
                        		WHERE YEAR(a.EarlyWarningTime)= @Year and MONTH(a.EarlyWarningTime)= @Month AND b.EarlyWarningStart=0
                           ) ret
                        WHERE ret.group_idx =1
                        ) fewoi
                        left join TbFlowNode fn on fewoi.FlowCode=fn.FlowCode and fewoi.FlowNodeCode=fn.FlowNodeCode
                        left join TbSysMenu sm on fewoi.EWFormCode=sm.MenuCode
                        left join TbCompany cp1 on fewoi.BranchCode=cp1.CompanyCode
                        left join TbCompany cp2 on fewoi.WorkAreaCode=cp2.CompanyCode
                        left join TbCompany cp3 on fewoi.SiteCode=cp3.CompanyCode
                        left join TbCompany cp4 on fewoi.ProcessFactoryCode=cp4.CompanyCode
                        left join TbUser u1 on fewoi.FlowSpUserCode=u1.UserId
                        left join TbUser u2 on fewoi.FlowYjUserCode=u2.UserId where 1=1 and fewoi.ProjectId='6245721945602523136' and (fewoi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fewoi.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) ORDER BY fewoi.EarlyWarningTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	SELECT sm.MenuName,fwqi.EWContent,fwqi.EWUserCode,u.UserName,fwqi.EWFormDataCode,cp1.CompanyFullName as  FbName,cp2.CompanyFullName as GqName,fwqi.EWTime,sdd.DictionaryText as RebarType  
                   FROM (  
                    select ret.*
                    FROM ( 
                         SELECT *, row_number()over(partition BY EarlyWarningCode,EWFormDataCode ORDER BY EWNodeCode,EWTime desc) as group_idx 
                         FROM TbFormEarlyWarningNodeInfo fwqi
                         WHERE YEAR(fwqi.EWTime)= @Year and MONTH(fwqi.EWTime)= @Month AND fwqi.MenuCode='RawMonthDemandPlan' AND fwqi.EWStart=0
                    ) ret
                    WHERE ret.group_idx = 1
                   ) fwqi
                    left join TbSysMenu sm on fwqi.MenuCode=sm.MenuCode
                            left join TbCompany cp1 on fwqi.CompanyCode=cp1.CompanyCode
                            left join TbCompany cp2 on fwqi.WorkArea=cp2.CompanyCode
                            left join TbCompany cp3 on fwqi.SiteCode=cp3.CompanyCode
                            left join TbUser u on fwqi.EWUserCode=u.UserId
                            left join TbRawMaterialMonthDemandPlan rmp on fwqi.EWFormDataCode=rmp.ID
                            left join TbSysDictionaryData sdd on sdd.DictionaryCode=rmp.RebarType
                    where 1=1 and fwqi.ProjectId='6245721945602523136' and (fwqi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fwqi.WorkArea in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) ORDER BY fwqi.EWTime DESC	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	--原材料供货超时
                           select BatchPlanNum,cp1.CompanyFullName as BranchName,cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,sup.SupplyDate,sup.SupplyCompleteTime,sup.ProjectId,sup.Remarks from TbSupplyList sup
                           left join TbCompany cp1 on cp1.CompanyCode=sup.BranchCode
                           left join TbCompany cp2 on cp2.CompanyCode=sup.WorkAreaCode
                           left join TbCompany cp3 on cp3.CompanyCode=sup.SiteCode
                           left join TbCompany cp4 on cp4.CompanyCode=sup.ProcessFactoryCode
                           where YEAR(sup.SupplyDate)= @Year and MONTH(sup.SupplyDate)= @Month
                           and (sup.SupplyCompleteTime>sup.SupplyDate or (GETDATE()>sup.SupplyDate and sup.SupplyCompleteTime is null))  and sup.ProjectId='6245721945602523136' and (sup.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or sup.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	--加工进度滞后
                           select op.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,op.DistributionTime,op.FinishProcessingDateTime from TbOrderProgress op 
                           left join TbCompany cp1 on op.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on op.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(op.DistributionTime)= @Year and MONTH(op.DistributionTime)= @Month
                           and (op.FinishProcessingDateTime>op.DistributionTime or (GETDATE()>op.DistributionTime and op.FinishProcessingDateTime is null))  and op.ProjectId='6245721945602523136' and op.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY op.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:07
Text:	--加急订单个数
                           select wo.OrderCode,wo.DistributionTime,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName from TbWorkOrder wo
                           left join TbCompany cp1 on wo.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on wo.ProcessFactoryCode=cp2.CompanyCode
                           where UrgentDegree='Urgent'
                           and YEAR(wo.DistributionTime)= @Year and MONTH(wo.DistributionTime)= @Month  and wo.ProjectId='6245721945602523136' and wo.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')  ORDER BY wo.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	--配送超期
                           select dpi.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,dpi.DistributionTime,dpi.DeliveryCompleteTime,dpi.Remark from TbDistributionPlanInfo dpi
                           left join TbCompany cp1 on dpi.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on dpi.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(dpi.DistributionTime)= @Year and MONTH(dpi.DistributionTime)= @Month
                           and (dpi.DeliveryCompleteTime>dpi.DistributionTime or (GETDATE()>dpi.DistributionTime and dpi.DeliveryCompleteTime is null))  and dpi.ProjectId='6245721945602523136' and dpi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY dpi.DistributionTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	select TbYj.*,cp1.CompanyFullName as SiteName,tcr.EnterSpaceTime,tcr.StartDischargeTime,tcr.EndDischargeTime,disEnt.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SiteDischargeCargo' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbTransportCarReport tcr on TbYj.EWFormDataCode=tcr.DisEntOrderId
                           left join TbDistributionEnt disEnt on tcr.DistributionCode=disEnt.DistributionCode
                           left join TbCompany cp on disEnt.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ORDER BY tcr.EnterSpaceTime desc	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	select tcr.*,cp.CompanyFullName as SiteName,ci.CarCph+tu.UserName AS CarCph,de.Enclosure from TbTransportCarReport  tcr
                           left join TbCompany cp on tcr.SiteCode=cp.CompanyCode
                           left join TbCarInfo ci on tcr.VehicleCode=ci.CarCode
                           left join TbDistributionEnt de on tcr.DistributionCode=de.DistributionCode
                           LEFT JOIN TbUser tu ON tu.UserCode=de.Driver
                           where (ISNULL(@ProjectId,'')='' or tcr.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or de.ProcessFactoryCode=@ProcessFactoryCode)
                           and (tcr.IsProblem='是' or tcr.FlowState=2) 
                           and YEAR(tcr.EndDischargeTime)= @Year and MONTH(tcr.EndDischargeTime)= @Month and tcr.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           order by id desc	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	select TbYj.*,cp1.CompanyFullName as SiteName,sfs.DistributionCode,sdc.DistributionTime,sfs.SigninTime,sfs.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SemiFinishedSign' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbSemiFinishedSign sfs on TbYj.EWFormDataCode=sfs.ID
                           left join TbSiteDischargeCargo sdc on sfs.DistributionCode=sdc.DistributionCode and sfs.DischargeCargoCode=sdc.DischargeCargoCode
                           left join TbCompany cp on sfs.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:08
Text:	SELECT 
                            '审批超时' as YjTypeName,COUNT(1) as YjNum
                            FROM (
									SELECT a.*, row_number()over(partition BY a.FlowCode ORDER BY a.FlowNodeCode,a.EarlyWarningTime desc) as group_idx 
									FROM TbFlowEarlyWarningOtherInfo  a
									INNER JOIN  TbFlowEarlyWarningInfo b ON a.FlowCode=b.FlowCode 
									AND a.EWFormDataCode=b.EWFormDataCode AND a.FlowNodeCode=b.FlowNodeCode 
									WHERE  b.EarlyWarningStart=0 AND YEAR(a.EarlyWarningTime)= @Year and MONTH(a.EarlyWarningTime)= @Month  and a.ProjectId='6245721945602523136' and (a.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or a.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))
							   ) Tb1
                            WHERE Tb1.group_idx =1
                           union all
                            select '未报月度需求计划' as YjTypeName,COUNT(1)as YjNum
                             FROM ( 
                                  SELECT *, row_number()over(partition BY EarlyWarningCode,EWFormDataCode ORDER BY EWNodeCode,EWTime desc) as group_idx 
                                  FROM TbFormEarlyWarningNodeInfo fwqi
                                  WHERE fwqi.MenuCode='RawMonthDemandPlan' AND fwqi.EWStart=0 AND YEAR(fwqi.EWTime)= @Year and MONTH(fwqi.EWTime)= @Month  and fwqi.ProjectId='6245721945602523136' and (fwqi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or fwqi.WorkArea in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))  
                             ) Tb2
                             WHERE Tb2.group_idx =1
                           union all
                           select '原材料供货超时' as YjTypeName,COUNT(1) as YjNum from (
                           select BatchPlanNum,cp1.CompanyFullName as BranchName,cp2.CompanyFullName as WorkAreaName,cp3.CompanyFullName as SiteName,cp4.CompanyFullName as ProcessFactoryName,sup.SupplyDate,sup.SupplyCompleteTime,sup.ProjectId from TbSupplyList sup
                           left join TbCompany cp1 on cp1.CompanyCode=sup.BranchCode
                           left join TbCompany cp2 on cp2.CompanyCode=sup.WorkAreaCode
                           left join TbCompany cp3 on cp3.CompanyCode=sup.SiteCode
                           left join TbCompany cp4 on cp4.CompanyCode=sup.ProcessFactoryCode
                           where (sup.SupplyCompleteTime>sup.SupplyDate or (GETDATE()>sup.SupplyDate and sup.SupplyCompleteTime is null))
						   and YEAR(sup.SupplyDate)= @Year and MONTH(sup.SupplyDate)= @Month  and sup.ProjectId='6245721945602523136' and (sup.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or sup.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688'))) Tb3
                           union all
                           select '加急订单' as YjTypeName,COUNT(1) as YjNum from (--加急订单个数
                           select wo.OrderCode,wo.DistributionTime,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName from TbWorkOrder wo
                           left join TbCompany cp1 on wo.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on wo.ProcessFactoryCode=cp2.CompanyCode
                           where UrgentDegree='Urgent' 
						   and YEAR(wo.DistributionTime)= @Year and MONTH(wo.DistributionTime)= @Month  and wo.ProjectId='6245721945602523136' and wo.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb4
                           union all
                           select '加工进度滞后' as YjTypeName,COUNT(1) as YjNum from (--加工进度滞后
                           select op.OrderCode,cp1.CompanyFullName as SiteName,cp2.CompanyFullName as ProcessFactoryName,op.DistributionTime,op.FinishProcessingDateTime from TbOrderProgress op 
                           left join TbCompany cp1 on op.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on op.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(op.DistributionTime)= @Year and MONTH(op.DistributionTime)= @Month
                           and (op.FinishProcessingDateTime>op.DistributionTime or (GETDATE()>op.DistributionTime and op.FinishProcessingDateTime is null))  and op.ProjectId='6245721945602523136' and op.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb5
                           union all
                           select '接收配送超期' as YjTypeName,COUNT(1) as YjNum from (--配送超期
                           select dpi.OrderCode,cp1.CompanyFullName as SIteName,cp2.CompanyFullName as ProcessFactoryName,dpi.DistributionTime,dpi.DeliveryCompleteTime from TbDistributionPlanInfo dpi
                           left join TbCompany cp1 on dpi.SiteCode=cp1.CompanyCode
                           left join TbCompany cp2 on dpi.ProcessFactoryCode=cp2.CompanyCode
                           where YEAR(dpi.DistributionTime)= @Year and MONTH(dpi.DistributionTime)= @Month
                           and (dpi.DeliveryCompleteTime>dpi.DistributionTime or (GETDATE()>dpi.DistributionTime and dpi.DeliveryCompleteTime is null))  and dpi.ProjectId='6245721945602523136' and dpi.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb6 
                           union all
                           select '卸货超时' as YjTypeName,COUNT(1) as YjNum from(--卸货超时
                           select TbYj.*,cp1.CompanyFullName as SiteName,tcr.EnterSpaceTime,tcr.StartDischargeTime,tcr.EndDischargeTime,disEnt.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SiteDischargeCargo' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbTransportCarReport tcr on TbYj.EWFormDataCode=tcr.DisEntOrderId
                           left join TbDistributionEnt disEnt on tcr.DistributionCode=disEnt.DistributionCode
                           left join TbCompany cp on disEnt.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb7
                           union all
                           select '签收超时' as YjTypeName,COUNT(1) as YjNum from (select TbYj.*,cp1.CompanyFullName as SiteName,sfs.DistributionCode,sdc.DistributionTime,sfs.SigninTime,sfs.ProcessFactoryCode,cp.CompanyFullName as ProcessFactoryName from (select min(EwTime) as EwTime,MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId from TbFormEarlyWarningNodeInfo where  MenuCode='SemiFinishedSign' 
						   group by MenuCode,EWFormDataCode,CompanyCode,WorkArea,SiteCode,ProjectId) TbYj
						   left join TbSemiFinishedSign sfs on TbYj.EWFormDataCode=sfs.ID
                           left join TbSiteDischargeCargo sdc on sfs.DistributionCode=sdc.DistributionCode and sfs.DischargeCargoCode=sdc.DischargeCargoCode
                           left join TbCompany cp on sfs.ProcessFactoryCode=cp.CompanyCode
                           left join TbCompany cp1 on TbYj.SiteCode=cp1.CompanyCode
						   where YEAR(TbYj.EWTime)= @Year and MONTH(TbYj.EWTime)= @Month  and TbYj.ProjectId='6245721945602523136' and TbYj.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') ) Tb8	
Parameters:
@Year[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:23
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 17:53:23
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:53:23
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:53:23
Text:	select isnull(sum(inoi.PassCount),0) as FeedNum from TbInOrder ino
                           left join TbInOrderItem inoi on ino.InOrderCode=inoi.InOrderCode
                           where ino.Examinestatus='审核完成' and inoi.ChackState=1
                           and (ISNULL(@BegTime,'')='' or ino.InsertTime>=CONVERT(varchar,@BegTime,101)) 
                           and (ISNULL(@EndTime,'')='' or ino.InsertTime<=@EndTime)
                           and (ISNULL(@MaterialName,'')='' or inoi.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or inoi.SpecificationModel like '%'+@SpecificationModel+'%')
                           and (ISNULL(@ProjectId,'')='' or ino.ProjectId=@ProjectId)
                            
                           union all
                           select isnull(sum(rmpmp.WeightSmallPlanN),0) as YLNum from TbRMProductionMaterial rmpm
                           left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
                           left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
                           left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
                           where rmpm.Examinestatus='审核完成'
                           and rmpmp.RMTypeName='余料' 
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            
                           and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
                           union all
                           select sum(Tb.RawMaterialNum) as RawMaterialNum from (select isnull(sum(rmpmp.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterial rmpm
						   left join TbRMProductionMaterialDetail rmpmd on rmpm.CollarCode=rmpmd.CollarCode
						   left join TbRMProductionMaterialPlan rmpmp on rmpmd.CollarCode=rmpmp.CollarCode and rmpmd.MaterialCode=rmpmp.MaterialCode and rmpmd.WorkOrderItemId=rmpmp.WorkOrderItemId
						   left join TbRawMaterialArchives rma on rmpmp.MaterialCode=rma.MaterialCode
						   where  rmpm.Examinestatus='审核完成'
						   and rmpmp.RMTypeName='原材料' 
						   and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rma.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rma.SpecificationModel like '%'+@SpecificationModel+'%')
						   union all
						   select isnull(sum(rpmd.WeightSmallPlanN),0) as RawMaterialNum from TbRMProductionMaterialDetail rpmd 
						   left join TbRMProductionMaterial rpm on rpmd.CollarCode=rpm.CollarCode
						   where  rpm.Examinestatus='审核完成'
						   and rpmd.WorkOrderItemId not in(select WorkOrderItemId from TbRMProductionMaterialPlan)
						   and (ISNULL(@BegTime,'')='' or rpm.CollarDate>=@BegTime)
						   and (ISNULL(@EndTime,'')='' or rpm.CollarDate<=@EndTime)
						   and (ISNULL(@ProjectId,'')='' or rpm.ProjectId=@ProjectId)
						   and (ISNULL(@ProcessFactoryCode,'')='' or rpm.ProcessFactoryCode=@ProcessFactoryCode)
						   
						   and (ISNULL(@MaterialName,'')='' or rpmd.MaterialName like '%'+@MaterialName+'%')
						   and (ISNULL(@SpecificationModel,'')='' or rpmd.SpecificationModel like '%'+@SpecificationModel+'%')) Tb	
Parameters:
@BegTime[DateTime] = 
@EndTime[DateTime] = 
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select 
                           a.RootNumber,
                           a.SizeSelection,
                           a.MaterialCode,
                           a.WeightSmallPlanN,
                           b.MaterialName,
                           b.SpecificationModel,
                           b.MeasurementUnitZl,
                           c.CompanyFullName StartSiteName,
                           d.CompanyFullName EndSiteName
                           from 
                           (
                           select 
                           a.MaterialCode,
                           a.Size as SizeSelection,
                           a.StartSiteCode,
                           a.EndSiteCode,
                           sum(a.Number) RootNumber,
                           sum(a.Weight) WeightSmallPlanN
                           from TbCloutStockPlace a
                           left join TbRMProductionMaterial rmpm on a.CollarCode=rmpm.CollarCode
                           where a.State=1 
                           and (ISNULL(@ProjectId,'')='' OR a.ProjectId=@ProjectId)
                           and (ISNULL(@BegTime,'')='' or rmpm.CollarDate>=@BegTime)
                           and (ISNULL(@EndTime,'')='' or rmpm.CollarDate<=@EndTime)
                           and (ISNULL(@ProjectId,'')='' or rmpm.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmpm.ProcessFactoryCode=@ProcessFactoryCode)
                            and a.EndSiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792')
                           group by a.MaterialCode,a.Size,a.StartSiteCode,a.EndSiteCode
                           ) a
                           left join TbRawMaterialArchives b on a.MaterialCode=b.MaterialCode
                           left join TbCompany c on c.CompanyCode=a.StartSiteCode
                           left join TbCompany d on d.CompanyCode=a.EndSiteCode
                           where 1=1 
                           and (ISNULL(@MaterialName,'')='' or b.MaterialName like '%'+@MaterialName+'%')
                           and (ISNULL(@SpecificationModel,'')='' or b.SpecificationModel like '%'+@SpecificationModel+'%')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@MaterialName[String] = 
@SpecificationModel[String] = 
@BegTime[DateTime] = 
@EndTime[DateTime] = 


-----------------------------------------------------------------------------
2019-12-17 17:53:24
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode asc)AS Row, * from (select * from (
	select Tb.*,isnull(TbXqPlan.DemandNum,0) as LjDemandNum,isnull(TbPcPlan.BatchPlanQuantity,0) as LjBatchPlanQuantity,isnull(TbGh.HasSupplier,0) as LjHasSupplier,isnull(ProcessFinishData.HistoryMonthCount,0) as HistoryMonthCount from (select rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode as BranchCode,cp1.CompanyFullName as BranchName,rs.WorkAreaCode,cp.CompanyFullName as WorkAreaName,sum(rs.Count) as InitialCount,rs.ProjectId from TbRawMaterialStockRecord rs
                           left join TbCompany cp on cp.CompanyCode=rs.WorkAreaCode
                           left join TbCompany cp1 on cp1.CompanyCode=cp.ParentCompanyCode
                           left join TbStorage s on rs.StorageCode=s.StorageCode
                           where (ISNULL(@ProjectId,'')='' or rs.ProjectId=@ProjectId)
                           and (ISNULL(@ProcessFactoryCode,'')='' or s.ProcessFactoryCode=@ProcessFactoryCode)
                           and rs.ChackState=1
                           group by rs.MaterialCode,rs.MaterialName,rs.SpecificationModel,cp1.CompanyCode,cp1.CompanyFullName,rs.WorkAreaCode,cp.CompanyFullName,rs.ProjectId) Tb
                           left join (select rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode,sum(rmpd.DemandNum) as DemandNum from TbRawMaterialMonthDemandPlan rmp
                           left join TbRawMaterialMonthDemandPlanDetail rmpd on rmp.DemandPlanCode=rmpd.DemandPlanCode 
                           where rmp.Examinestatus='审核完成' 
                           and rmp.DemandPlanCode not in(select DemandPlanCode from TbRawMaterialMonthDemandSupplyPlan where Examinestatus='审核完成') 
                           and (ISNULL(@Year,'')='' or (YEAR(rmp.DeliveryDate)=@Year and MONTH(rmp.DeliveryDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmp.ProjectId=@ProjectId) group by rmpd.MaterialCode,rmp.WorkAreaCode,rmp.ProjectId,rmp.ProcessFactoryCode
                           union all
                           select rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode,sum((rmspd.SupplyNum+rmspd.DemandNum)) as DemandNum  from TbRawMaterialMonthDemandSupplyPlan rmsp
                           left join TbRawMaterialMonthDemandSupplyPlanDetail rmspd on rmsp.SupplyPlanCode=rmspd.SupplyPlanCode 
                           where rmsp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(rmsp.SupplyTime)=@Year and MONTH(rmsp.SupplyTime)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or rmsp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or rmsp.ProjectId=@ProjectId) group by rmspd.MaterialCode,rmsp.WorkAreaCode,rmsp.ProjectId,rmsp.ProcessFactoryCode) TbXqPlan 
                           on Tb.WorkAreaCode=TbXqPlan.WorkAreaCode and Tb.MaterialCode=TbXqPlan.MaterialCode
                           left join (select fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode,sum(fbpi.BatchPlanQuantity) as BatchPlanQuantity from TbFactoryBatchNeedPlan fbp
                           left join TbFactoryBatchNeedPlanItem fbpi on fbp.BatchPlanNum=fbpi.BatchPlanNum where fbp.Examinestatus='审核完成'
                           and (ISNULL(@Year,'')='' or (YEAR(fbp.ArrivalDate)=@Year and MONTH(fbp.ArrivalDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or fbp.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or fbp.ProjectId=@ProjectId) group by fbpi.RawMaterialNum,fbp.WorkAreaCode,fbp.ProjectId,fbp.ProcessFactoryCode) TbPcPlan 
                           on Tb.WorkAreaCode=TbPcPlan.WorkAreaCode and Tb.MaterialCode=TbPcPlan.RawMaterialNum
                           left join (select sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode,sum(sld.HasSupplier) as HasSupplier from TbSupplyList sl
                           left join TbSupplyListDetail sld on sl.BatchPlanNum=sld.BatchPlanNum where 1=1
                           and (ISNULL(@Year,'')='' or (YEAR(sl.SupplyDate)=@Year and MONTH(sl.SupplyDate)=@Month))
                           and (ISNULL(@ProcessFactoryCode,'')='' or sl.ProcessFactoryCode=@ProcessFactoryCode) 
                           and (ISNULL(@ProjectId,'')='' or sl.ProjectId=@ProjectId)
                           group by sld.RawMaterialNum,sl.WorkAreaCode,sl.ProjectId,sl.ProcessFactoryCode) TbGh on Tb.WorkAreaCode=TbGh.WorkAreaCode and Tb.MaterialCode=TbGh.RawMaterialNum
                           LEFT JOIN --历史月份加工完成量
                           (
                           	    SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and MONTH(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode
							)ProcessFinishData ON Tb.WorkAreaCode=ProcessFinishData.WorkAreaCode and Tb.MaterialCode=ProcessFinishData.MaterialCode 
                           ) Tb1   where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) as a)  SELECT * FROM temptbl where Row between 1 and 50	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:25
Text:	select ISNULL(sum(Tb1.HistoryMonthCount),0) from (SELECT 
								tc.ParentCompanyCode AS WorkAreaCode,
								twod.MaterialCode,
								twod.MaterialName,
								twod.SpecificationModel,
								SUM(twod.WeightSmallPlan) AS HistoryMonthCount
								FROM
									TbWorkOrderDetail twod
									INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
									LEFT JOIN TbCompany tc ON two.SiteCode=tc.CompanyCode
								WHERE 
								twod.DaetailWorkStrat='加工完成' 
								AND (ISNULL(@ProjectId,'')='' or two.ProjectId=@ProjectId)
								AND (ISNULL(@ProcessFactoryCode,'')='' or two.ProcessFactoryCode=@ProcessFactoryCode)
								AND (ISNULL(@Yearf,'')='' or (YEAR(twod.FinishTime)=@Yearf and DAY(twod.FinishTime)=@Month))
								GROUP BY tc.ParentCompanyCode,twod.MaterialCode,twod.MaterialName,twod.SpecificationModel)Tb1  where 1=1  and Tb1.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	
Parameters:
@ProjectId[String] = 6245721945602523136
@ProcessFactoryCode[String] = 
@Year[String] = 
@Yearf[String] = 2019
@Month[String] = 12


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	SELECT MaterialName FROM TbRawMaterialArchives
                                GROUP BY MaterialName	


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	SELECT mm.MenuUrl, pp.UserCode, pp.menuCode, pp.OperationView, pp.OperationAdd
	                        , pp.OperationEdit, pp.OperationDel, pp.OperationExamination, pp.OperationOutput, pp.OperationOther1
	                        , mm.OperationOther1Fun, mm.OperationOther1IconCls, pp.OperationOther2, mm.OperationOther2Fun, mm.OperationOther2IconCls
	                        , pp.OperationOther3, mm.OperationOther3Fun, mm.OperationOther3IconCls, pp.OperationOther4, mm.OperationOther4Fun
	                        , mm.OperationOther4IconCls, pp.OperationOther5, mm.OperationOther5Fun, mm.OperationOther5IconCls
                        FROM (
	                        SELECT UserCode, menuCode, MAX(OperationView) AS OperationView
		                        , MAX(OperationAdd) AS OperationAdd, MAX(OperationEdit) AS OperationEdit
		                        , MAX(OperationDel) AS OperationDel, MAX(OperationExamination) AS OperationExamination
		                        , MAX(OperationOutput) AS OperationOutput, MAX(OperationOther1) AS OperationOther1
		                        , MAX(OperationOther2) AS OperationOther2, MAX(OperationOther3) AS OperationOther3
		                        , MAX(OperationOther4) AS OperationOther4, MAX(OperationOther5) AS OperationOther5
	                        FROM (
		                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
			                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
			                        , OperationOther3, OperationOther4, OperationOther5
		                        FROM (
			                        SELECT a.UserCode, b.menuCode, MAX(b.OperationView) AS OperationView
				                        , MAX(b.OperationAdd) AS OperationAdd, MAX(b.OperationEdit) AS OperationEdit
				                        , MAX(b.OperationDel) AS OperationDel, MAX(b.OperationExamination) AS OperationExamination
				                        , MAX(b.OperationOutput) AS OperationOutput, MAX(b.OperationOther1) AS OperationOther1
				                        , MAX(b.OperationOther2) AS OperationOther2, MAX(b.OperationOther3) AS OperationOther3
				                        , MAX(b.OperationOther4) AS OperationOther4, MAX(b.OperationOther5) AS OperationOther5
			                        FROM dbo.TbUserRole a
				                        INNER JOIN dbo.TbRoleMenu b ON a.RoleCode = b.RoleCode
                                        where b.RoleCode in('6337324142387400704','6352967650544590848')
			                        GROUP BY a.UserCode, b.menuCode
			                        UNION ALL
			                        SELECT UserCode, menuCode, OperationView, OperationAdd, OperationEdit
				                        , OperationDel, OperationExamination, OperationOutput, OperationOther1, OperationOther2
				                        , OperationOther3, OperationOther4, OperationOther5
			                        FROM dbo.TbUserMenu
			                        union all
			                        SELECT p.UserCode, d.menuCode, MAX(d.OperationView) AS OperationView
				                        , MAX(d.OperationAdd) AS OperationAdd, MAX(d.OperationEdit) AS OperationEdit
				                        , MAX(d.OperationDel) AS OperationDel, MAX(d.OperationExamination) AS OperationExamination
				                        , MAX(d.OperationOutput) AS OperationOutput, MAX(d.OperationOther1) AS OperationOther1
				                        , MAX(d.OperationOther2) AS OperationOther2, MAX(d.OperationOther3) AS OperationOther3
				                        , MAX(d.OperationOther4) AS OperationOther4, MAX(d.OperationOther5) AS OperationOther5
			                        FROM dbo.TbPositionUser p
				                        INNER JOIN dbo.TbPositionMenu d ON p.PositionCode = d.PositionCode
			                        GROUP BY p.UserCode, d.menuCode
			
		                        ) c
	                        ) aa
	                        GROUP BY UserCode, menuCode
                        ) pp
                        INNER JOIN dbo.TbSysMenu mm ON pp.menuCode = mm.menuCode 
                        left join dbo.TbUser u on pp.UserCode=u.UserId
                        where u.UserCode=@UserCode And mm.MenuUrl=@menuURI	
Parameters:
@UserCode[String] = 102787
@menuURI[String] = /RawMaterial/RawMaterialStock/Index


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	WITH T
                                        AS( 
                                            SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                            UNION ALL 
                                            SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType 
                                            FROM TbCompany a INNER JOIN T ON a.CompanyCode=T.ParentCompanyCode  
                                        ) 
                                        SELECT * FROM T 
                                        left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.CompanyCode!=@CompanyCode and T.OrgType!=1  order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	WITH T
                                     AS( 
                                         SELECT id,CompanyCode,ParentCompanyCode,CompanyFullName,Address,OrgType FROM TbCompany WHERE CompanyCode=@CompanyCode 
                                         UNION ALL 
                                         SELECT a.id,a.CompanyCode,a.ParentCompanyCode,a.CompanyFullName,a.Address,a.OrgType  FROM TbCompany a INNER JOIN T ON a.ParentCompanyCode=T.CompanyCode  
                                     ) 
                                     SELECT T.*,tpc.ProjectId FROM T 
                                     left join TbProjectCompany tpc on T.CompanyCode=tpc.CompanyCode where tpc.ProjectId=@ProjectId and T.OrgType!=1 order by T.id asc;	
Parameters:
@CompanyCode[String] = 6247574415609954304
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:29
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:30
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rms.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:53:30
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437060915425845248','6374383547544903680','6374384032955899904','6374384202665828352','6285121357168508928','6285122203776188416','6437059163368595456','6285120520983674880','6285120866493661184','6285119541664022528','6285120302351384576','6285181647230861312','6284878460246556672','6284879065547538432','6276140742482067456','6276141050964738048','6276141450283450368','6276141737463250944','6276141926932545536','6308426901824208896','6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672','6267798187931598848','6267798388054425600','6276760608893304832','6267797181319610368','6267796592825204736','6267796864196673536','6267797037211713536','6267793380881727488','6267793585479876608','6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104','6267785016667799552','6267785185136214016','6267785381991677952','6267785590951903232','6267785762842869760','6267783175129268224','6267783320914886656','6267783444885929984','6267783577954418688','6267784612617912320','6267749616851091456','6267750471750909952','6267750709144322048','6267750895786655744','6267751010588950528','6267753037104676864','6267754200801738752','6267754324688896000','6267797518566817792') or rms.WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:32
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6247574415609954304
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:32
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 17:53:32
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='' and a.SiteCode='6247574415609954304' and a.WorkAreaCode='' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:32
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')	


-----------------------------------------------------------------------------
2019-12-17 17:53:33
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6437060719774142464','6374290292257988608','6284877407262343168','6284877502225580032','6284877579233001472','6284877692479209472','6276140381243441152','6274025879437836288','6274026095054422016','6267795908742610944','6267796061088120832','6267796277275131904','6267793241479839744','6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520','6267782749348691968','6267782939208056832','6267743715289202688')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025879437836288
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025879437836288
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025879437836288
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288')	


-----------------------------------------------------------------------------
2019-12-17 17:53:53
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025587078070272
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025587078070272
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288','6274026095054422016')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288','6274026095054422016')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025587078070272
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288','6274026095054422016')	


-----------------------------------------------------------------------------
2019-12-17 17:53:56
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288','6274026095054422016')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025879437836288
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:54:07
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025879437836288
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:07
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:54:07
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:09
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025879437836288
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:09
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288')	


-----------------------------------------------------------------------------
2019-12-17 17:54:09
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:22
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025587078070272
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:54:22
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025587078070272
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:22
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288','6274026095054422016')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:54:22
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6274028829845487616','6274029086029381632','6274029528142577664','6274029966388625408','6274030152053686272','6274030373047369728','6274030913332445184','6274027775095472128','6274027929433276416','6274028333340557312','6417410523612188672') or rms.WorkAreaCode in('6274025879437836288','6274026095054422016')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:23
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6274025587078070272
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:23
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288','6274026095054422016')	


-----------------------------------------------------------------------------
2019-12-17 17:54:23
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6274025879437836288','6274026095054422016')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:32
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267787909240193024
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:54:32
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267787909240193024
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:32
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104') or rms.WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:54:32
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104') or rms.WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:32
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267787909240193024
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:32
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')	


-----------------------------------------------------------------------------
2019-12-17 17:54:33
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:45
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900018' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 17:54:45
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900018' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 17:54:45
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900018' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:45
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900018' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:45
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900003' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 17:54:45
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900003' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:46
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900003' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 17:54:46
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900003' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:46
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 17:54:46
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 17:54:46
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:46
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:48
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267787909240193024
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 17:54:48
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267787909240193024
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:48
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104') or rms.WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 17:54:48
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6437059801301262336','6267790081113718784','6267790783294734336','6267791210027417600','6267791528110850048','6267791338536697856','6267791654132908032','6267791036517449728','6267789807737372672','6267790255894560768','6267790460492709888','6267790574804271104') or rms.WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:54:49
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267787909240193024
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 17:54:49
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')	


-----------------------------------------------------------------------------
2019-12-17 17:54:50
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267788080908861440','6267788261163270144','6267788390918258688','6267788788836073472','6437059457770987520')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 17:55:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:55:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:56:04
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:57:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:57:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 17:58:02
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 17:58:02
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 17:58:02
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode17) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode18,@EWFormDataCode19,@EWFormDataCode20,@EWFormDataCode21,@EWFormDataCode22,@EWFormDataCode23,@EWFormDataCode24,@EWFormDataCode25,@EWFormDataCode26,@EWFormDataCode27,@EWFormDataCode28,@EWFormDataCode29,@EWFormDataCode30,@EWFormDataCode31,@EWFormDataCode32)) 	
Parameters:
@MenuCode17[String] = SupplyList
@EWFormDataCode18[Int32] = 4
@EWFormDataCode19[Int32] = 9
@EWFormDataCode20[Int32] = 10
@EWFormDataCode21[Int32] = 11
@EWFormDataCode22[Int32] = 13
@EWFormDataCode23[Int32] = 14
@EWFormDataCode24[Int32] = 15
@EWFormDataCode25[Int32] = 17
@EWFormDataCode26[Int32] = 19
@EWFormDataCode27[Int32] = 5
@EWFormDataCode28[Int32] = 6
@EWFormDataCode29[Int32] = 7
@EWFormDataCode30[Int32] = 8
@EWFormDataCode31[Int32] = 16
@EWFormDataCode32[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 17:59:04
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 17:59:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 17:59:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:01:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:01:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:02:04
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 18:03:02
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 18:03:02
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:03:02
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 18:03:02
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode33) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode34,@EWFormDataCode35,@EWFormDataCode36,@EWFormDataCode37,@EWFormDataCode38,@EWFormDataCode39,@EWFormDataCode40,@EWFormDataCode41,@EWFormDataCode42,@EWFormDataCode43,@EWFormDataCode44,@EWFormDataCode45,@EWFormDataCode46,@EWFormDataCode47,@EWFormDataCode48)) 	
Parameters:
@MenuCode33[String] = SupplyList
@EWFormDataCode34[Int32] = 4
@EWFormDataCode35[Int32] = 9
@EWFormDataCode36[Int32] = 10
@EWFormDataCode37[Int32] = 11
@EWFormDataCode38[Int32] = 13
@EWFormDataCode39[Int32] = 14
@EWFormDataCode40[Int32] = 15
@EWFormDataCode41[Int32] = 17
@EWFormDataCode42[Int32] = 19
@EWFormDataCode43[Int32] = 5
@EWFormDataCode44[Int32] = 6
@EWFormDataCode45[Int32] = 7
@EWFormDataCode46[Int32] = 8
@EWFormDataCode47[Int32] = 16
@EWFormDataCode48[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 18:03:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:03:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:05:04
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 18:05:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:05:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:07:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:07:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:08:02
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 18:08:02
Text:	SELECT 
                                d1.*,
                                d2.EWFormDataCode,
                                d2.BatchPlanNum,
                                d2.BranchCode AS CompanyCode,
                                d3.CompanyFullName AS BranchName,
                                d2.WorkAreaCode AS WorkArea,
                                d4.CompanyFullName AS WorkAreaName,
                                d2.SiteCode,
                                d5.CompanyFullName AS SiteName
                                FROM TbFormEarlyWarningNodePersonnel d1
                                LEFT JOIN 
                                (
                                SELECT 
                                a.EWNodeCode,
                                b.*,
                                case when a.EWTimeType='年' then DATEADD(YEAR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='月' then DATEADD(MONTH,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='天' then DATEADD(DAY,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='时' then DATEADD(HOUR,a.EWTime,b.BegEwTiem) 
                                	when a.EWTimeType='分' then DATEADD(MINUTE,a.EWTime,b.BegEwTiem) 
                                	end as BegEwTiemNew
                                FROM TbFormEarlyWarningNode a
                                LEFT JOIN 
                                (
                                	SELECT
                                	sl.ID AS EWFormDataCode, 
                                	BatchPlanNum,SupplyDate,
                                	wt.EarlyWarningCode,
                                	wt.BranchCode,
                                	wt.WorkAreaCode,
                                	wt.SiteCode,
                                	DATEADD(n,(EWBegDay*24*60)+EWBegHour*60+EWBegMinute,SupplyDate) AS BegEwTiem 
                                	FROM TbSupplyList sl,TbFormEarlyWarningBegTime wt
                                	WHERE sl.SupplyDate<getdate() AND sl.StateCode='未供货' 
                                	and wt.MenuCode='SupplyList'
                                ) b ON a.EarlyWarningCode=b.EarlyWarningCode
                                ) d2 ON d1.EarlyWarningCode=d2.EarlyWarningCode AND d1.EWNodeCode=d2.EWNodeCode
                                LEFT JOIN TbCompany d3 ON d2.BranchCode=d3.CompanyCode
                                LEFT JOIN TbCompany d4 ON d2.WorkAreaCode=d4.CompanyCode
                                LEFT JOIN TbCompany d5 ON d2.SiteCode=d5.CompanyCode
                                WHERE d1.MenuCode ='SupplyList'	


-----------------------------------------------------------------------------
2019-12-17 18:08:02
Text:	 SELECT   * FROM [TbFormEarlyWarningNodeInfo]  WHERE ([TbFormEarlyWarningNodeInfo].[MenuCode] = @MenuCode49) AND ([TbFormEarlyWarningNodeInfo].[EWFormDataCode] IN (@EWFormDataCode50,@EWFormDataCode51,@EWFormDataCode52,@EWFormDataCode53,@EWFormDataCode54,@EWFormDataCode55,@EWFormDataCode56,@EWFormDataCode57,@EWFormDataCode58,@EWFormDataCode59,@EWFormDataCode60,@EWFormDataCode61,@EWFormDataCode62,@EWFormDataCode63,@EWFormDataCode64)) 	
Parameters:
@MenuCode49[String] = SupplyList
@EWFormDataCode50[Int32] = 4
@EWFormDataCode51[Int32] = 9
@EWFormDataCode52[Int32] = 10
@EWFormDataCode53[Int32] = 11
@EWFormDataCode54[Int32] = 13
@EWFormDataCode55[Int32] = 14
@EWFormDataCode56[Int32] = 15
@EWFormDataCode57[Int32] = 17
@EWFormDataCode58[Int32] = 19
@EWFormDataCode59[Int32] = 5
@EWFormDataCode60[Int32] = 6
@EWFormDataCode61[Int32] = 7
@EWFormDataCode62[Int32] = 8
@EWFormDataCode63[Int32] = 16
@EWFormDataCode64[Int32] = 18


-----------------------------------------------------------------------------
2019-12-17 18:08:04
Text:	select COUNT(1) as MsgCount from TbFlowPerformOpinions o
left join TbFlowPerform p on o.FlowPerformID=p.FlowPerformID
left join TbFlowDefine d on p.FlowCode=d.FlowCode
where o.UserCode=@UserCode and (ISNULL(@ProjectId,'')='' or d.ProjectId=@ProjectId) and (PerformState=-1 or PerformState=7)
union all
select COUNT(1) as MsgCount from TbFlowPerformMessage m 
LEFT JOIN TbUser tu ON m.UserCode=tu.UserCode
where (m.usercode=@UserCode OR tu.UserId=@UserCode)and IsRead=-1
union all
select SUM(Tb.earlywarningcount) as earlywarningcount from (
select COUNT(1) as earlywarningcount from TbFlowEarlyWarningInfo where EarlyWarningBTUser=@UserCode and EarlyWarningStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)
union all
select COUNT(1) as earlywarningcount from TbFormEarlyWarningNodeInfo where EWUserCode=@UserCode and EWStart=0 and (ISNULL(@ProjectId,'')='' or ProjectId=@ProjectId)) Tb	
Parameters:
@UserCode[String] = 
@ProjectId[String] = 6245721945602523136


-----------------------------------------------------------------------------
2019-12-17 18:09:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:09:50
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900020' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 18:09:50
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900020' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 18:09:50
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900020' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:50
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201900020' and a.SiteCode='' and a.WorkAreaCode='6267788390918258688' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:09:53
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)	


-----------------------------------------------------------------------------
2019-12-17 18:09:53
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount!=0 or a.LockCount=0) and a.ChackState<=1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:53
Text:	select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)	


-----------------------------------------------------------------------------
2019-12-17 18:09:53
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by ID desc)AS Row, * from (select
                                a.ID,
                                a.Factory,
                                a.BatchNumber,
                                a.InsertTime,
                                a.Count,
                                a.LockCount,
                                a.UseCount,
                                a.HistoryCount,
                                a.ChackState,
                                tsoi.Enclosure,
                                tsoi.TestReportNo
                                from 
                                TbRawMaterialStockRecord a
                                left join TbStorage s on a.StorageCode=s.StorageCode
                                LEFT JOIN TbSampleOrderItem tsoi ON tsoi.InOrderItemId=a.InOrderitemId where 1=1  and a.MaterialCode='MI201800118' and a.SiteCode='' and a.WorkAreaCode='6267788080908861440' and a.ProjectId='6245721945602523136' and ((a.LockCount+a.UseCount=0 and a.LockCount!=0) or a.ChackState>1)) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267788261163270144
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267788261163270144
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6267791036517449728') or rms.WorkAreaCode in('6267788261163270144')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6267791036517449728') or rms.WorkAreaCode in('6267788261163270144')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267788261163270144
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267788261163270144')	


-----------------------------------------------------------------------------
2019-12-17 18:09:54
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267788261163270144')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267790255894560768
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267790255894560768
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6267790255894560768') or rms.WorkAreaCode in('6267790255894560768')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6267790255894560768') or rms.WorkAreaCode in('6267790255894560768')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267790255894560768
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267790255894560768')	


-----------------------------------------------------------------------------
2019-12-17 18:09:55
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267790255894560768')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267790574804271104
@type[Int32] = 5


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267790574804271104
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6267790574804271104') or rms.WorkAreaCode in('6267790574804271104')) and rms.ProjectId='6245721945602523136'	


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by MaterialCode desc)AS Row, * from (select 
                                rms.*,
                                b.MaterialName,
                                b.SpecificationModel,
                                c.StorageName,
                                cp1.CompanyFullName as SiteName,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName,
                                sdd2.DictionaryText as RebarTypeText,
                                sdd3.DictionaryText as MeasurementUnitText 
                                from (
                                select 
                                MaterialCode,
                                ProjectId,
                                SiteCode,
                                StorageCode,
                                WorkAreaCode,
                                SUM(COUNT) as COUNT,
                                SUM(LockCount) as LockCount,
                                SUM(UseCount) as UseCount
                                FROM TbRawMaterialStockRecord
                                group by MaterialCode,SiteCode,WorkAreaCode,StorageCode,ProjectId
                                )as rms
                            left join TbCompany cp1 on rms.SiteCode=cp1.CompanyCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            left join TbStorage c on c.StorageCode=rms.StorageCode
                            left join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                            left join TbSysDictionaryData sdd2 on b.RebarType=sdd2.DictionaryCode
                            left join TbSysDictionaryData sdd3 on b.MeasurementUnit=sdd3.DictionaryCode  where 1=1  and (rms.SiteCode in('6267790574804271104') or rms.WorkAreaCode in('6267790574804271104')) and rms.ProjectId='6245721945602523136') as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	WITH TREE AS(SELECT * FROM TbCompany WHERE CompanyCode =@parentCode UNION ALL SELECT TbCompany.* FROM TbCompany, TREE WHERE TbCompany.ParentCompanyCode = TREE.CompanyCode) SELECT CompanyCode FROM TREE where TREE.OrgType=@type	
Parameters:
@parentCode[String] = 6267790574804271104
@type[Int32] = 4


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267790574804271104')	


-----------------------------------------------------------------------------
2019-12-17 18:09:56
Text:	with temptbl as (SELECT ROW_NUMBER() OVER (order by Point desc)AS Row, * from (SELECT 
                            MaterialCode,
                            Total, 
                            Point, 
                            MaterialName, 
                            SpecificationModel, 
                            WorkAreaName, 
                            BranchName
                            FROM (
                            select 
                                rms.MaterialCode,
                                rms.WorkAreaCode,
                                CASE WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	rms.LockCount +rms.UseCount
                                ELSE
                                	0
                                END AS Total,
                                isnull(c.WeightSmallPlan,0)AS WeightSmallPlan,
                                CASE
                                WHEN (rms.LockCount +rms.UseCount)>0
                                THEN
                                 	Convert(decimal(18,2),isnull((WeightSmallPlan/(rms.LockCount +rms.UseCount)*100),0))
                                WHEN isnull(WeightSmallPlan,0)=0
                                THEN
                                	0
                                ELSE
                                	100
                                END AS Point,
                                b.MaterialName,
                                b.SpecificationModel,
                                cp2.CompanyFullName as WorkAreaName,
                                cp3.CompanyFullName as BranchName
                                from (
                                select 
                                trmsr.MaterialCode,
                                trmsr.WorkAreaCode,
                                SUM(trmsr.LockCount) as LockCount,
                                SUM(trmsr.UseCount) as UseCount
                                FROM TbRawMaterialStockRecord trmsr
                                INNER join TbStorage d on d.StorageCode=trmsr.StorageCode
                                 where 1=1  and ProjectId='6245721945602523136'
                                group by trmsr.MaterialCode,trmsr.WorkAreaCode
                                )as rms
                                LEFT JOIN  
                                (
                                	   SELECT 
                                	   tcpy.ParentCompanyCode,
                                	   twod.MaterialCode,SUM(twod.WeightSmallPlan) AS WeightSmallPlan 
                           				FROM TbWorkOrderDetail twod
                           				INNER JOIN TbWorkOrder two ON two.OrderCode = twod.OrderCode
                           				INNER JOIN TbCompany tcpy ON two.SiteCode=tcpy.CompanyCode
                           				and ProcessingState='Received'
                           				 where 1=1  and ProjectId='6245721945602523136'
                                        GROUP BY 
                                        tcpy.ParentCompanyCode,
                                        twod.MaterialCode
                                ) as c ON rms.WorkAreaCode=c.ParentCompanyCode 
                                and rms.MaterialCode=c.MaterialCode
                            left join TbCompany cp2 on rms.WorkAreaCode=cp2.CompanyCode
                            left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                            INNER join TbRawMaterialArchives b on b.MaterialCode=rms.MaterialCode
                        ) retdata where 1=1  and WorkAreaCode in('6267790574804271104')) as a)  SELECT * FROM temptbl where Row between 1 and 50	


-----------------------------------------------------------------------------
2019-12-17 18:11:50
Text:	select Tb.*,ewni.ID from(--第一步预警（站点联系人、单据录入人）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbXhCsYj.EarningType as EWNodeCode,TbXhCsYj.EWTimeType,TbXhCsYj.EWTime,TbXhCsYj.PersonnelSource,TbXhCsYj.PersonnelCode,TbXhCsYj.DistributionCode,TbXhCsYj.EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select * from (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj
                               left join (select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEntOrder.SiteContacts,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.SiteContacts=ur.UserCode
                               union all
                               select TbPsXx.ID,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,'1' EarningType,'分' as EWTimeType,30 as EWTime from (select disEnt.InsertUserCode,disEntOrder.ID from TbDistributionEnt disEnt
                               left join TbDistributionEntOrder disEntOrder on disEnt.DistributionCode=disEntOrder.DistributionCode
                               where  disEntOrder.ID is not null) TbPsXx
                               left join TbUser ur on TbPsXx.InsertUserCode=ur.UserCode) TbXhCsYjUserOne on TbXhCsYj.DisEntOrderId=TbXhCsYjUserOne.ID) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo' 
                               union all
                               --其他预警（从预警设置里面获取的用户）
                               select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbXhCsYj.DistributionCode,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbXhCsYj.EnterSpaceTime) end as EnterSpaceTime,TbXhCsYj.DisEntOrderId,TbXhCsYj.BranchName,TbXhCsYj.WorkAreaName,TbXhCsYj.SiteCode,TbXhCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                               left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                               left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SiteDischargeCargo') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                               left join (select tcr.DistributionCode,tcr.EnterSpaceTime,tcr.DisEntOrderId,tcr.ProjectId,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,tcr.SiteCode,cp1.CompanyFullName as SiteName from TbTransportCarReport tcr 
                               left join TbDistributionEntOrder disEntOrder on tcr.DisEntOrderId=disEntOrder.ID
                               left join TbCompany cp1 on tcr.SiteCode=cp1.CompanyCode
                               left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                               left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                               where tcr.DisEntOrderId is not null and tcr.EnterSpaceTime is not null and tcr.StartDischargeTime is null
                               and GETDATE()>=DATEADD(MINUTE,30,tcr.EnterSpaceTime)) TbXhCsYj on ewt.BranchCode=TbXhCsYj.BranchCode and ewt.WorkAreaCode=TbXhCsYj.WorkAreaCode
                               where ewt.MenuCode='SiteDischargeCargo') Tb 
                               left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.DisEntOrderId=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                               where Tb.EWNodeCode is not null 
                               and Tb.PersonnelCode is not null 
                               and Tb.DistributionCode is not null
                               and GETDATE()>=Tb.EnterSpaceTime and ewni.ID is null	


-----------------------------------------------------------------------------
2019-12-17 18:11:50
Text:	select FlowCode,FlowNodeCode,FlowPerformID,FlowTitle,FormCode,FormDataCode,PreNodeCompleteDate,PerformState,EarlyWarningCode,EarlyWarningBegTime,EarlyWarningTime,EarlyWarningTimeType,PersonnelCode,PersonnelSource,ProjectId,DeptId,RoleId,OrgId,ActionType from (select Tb1.*,Tb2.EarlyWarningCode,case when Tb2.EarlyWarningTimeType='年' then DATEADD(YEAR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='月' then DATEADD(MONTH,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='天' then DATEADD(DAY,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='时' then DATEADD(HOUR,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) when Tb2.EarlyWarningTimeType='分' then DATEADD(MINUTE,Tb2.EarlyWarningTime,Tb1.PreNodeCompleteDate) else '' end as EarlyWarningBegTime,Tb2.EarlyWarningTime,Tb2.EarlyWarningTimeType,Tb2.PersonnelCode,Tb2.PersonnelSource,Tb2.ProjectId,Tb2.DeptId,Tb2.RoleId,Tb2.OrgId,Tb2.ActionType from (select DISTINCT fp.FlowCode,fp.FormDataCode,fp.FlowTitle,fd.FormCode,fpo.FlowPerformID,fpo.FlowNodeCode,fpo.PreNodeCompleteDate,fpo.PerformState from TbFlowPerformOpinions fpo
left join TbFlowPerform fp on fpo.FlowPerformID=fp.FlowPerformID
left join TbFlowDefine fd on fp.FlowCode=fd.FlowCode where fpo.PerformState=-1) Tb1 
left join (select few.FlowCode,few.FlowNodeCode,few.EarlyWarningCode,few.EarlyWarningTime,few.EarlyWarningTimeType,fewp.PersonnelSource,fewp.PersonnelCode,fewp.ProjectId,fnp.DeptId,fnp.RoleId,fnp.OrgId,fnp.ActionType from TbFlowEarlyWarningCondition few
left join TbFlowNodeEarlyWarningPersonnel fewp on few.EarlyWarningCode=fewp.EarlyWarningCode
left join TbFlowNodePersonnel fnp on fewp.FlowCode=fnp.FlowCode and fewp.FlowNodeCode=fnp.FlowNodeCode and fewp.PersonnelCode=fnp.PersonnelCode
left join TbFlowEarlyWarningInfo ewi on ewi.EarlyWarningCode=fewp.EarlyWarningCode and ewi.FlowPerformID is null) Tb2 on Tb1.FlowCode=Tb2.FlowCode and Tb1.FlowNodeCode=Tb2.FlowNodeCode) Tb 
where GETDATE()>Tb.EarlyWarningBegTime and Tb.EarlyWarningCode is not null and Tb.FlowPerformID not in(select FlowPerformID from TbFlowEarlyWarningInfo where FlowPerformID=Tb.FlowPerformID and FlowCode=Tb.FlowCode and FlowNodeCode=Tb.FlowNodeCode)	


-----------------------------------------------------------------------------
2019-12-17 18:13:02
Text:	select TbAll.EarlyWarningCode,TbAll.BranchCode,TbAll.BranchName,TbAll.WorkAreaCode,TbAll.WorkAreaName,TbAll.SiteCode,TbAll.SiteName,TbAll.ProjectId,TbAll.YjMonth,TbAll.MenuCode,TbAll.EWNodeCode,TbAll.EWNodeName,TbAll.PersonnelCode,TbAll.PersonnelSource,TbAll.BegEwTiemNew from (select Tb.*,case when Tb.EWTimeType='年' then DATEADD(YEAR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='月' then DATEADD(MONTH,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='天' then DATEADD(DAY,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='时' then DATEADD(HOUR,Tb.EWTime,Tb.BegEwTiem) when Tb.EWTimeType='分' then DATEADD(MINUTE,Tb.EWTime,Tb.BegEwTiem) end as BegEwTiemNew,TbYjInfo.EarlyWarningCode as YjCode from (select ewt.EarlyWarningCode,DATENAME(year,GETDATE())+'-'+ DATENAME(MONTH,GETDATE())+'-'+ CONVERT(varchar(20),ewt.EWBegDay)+' '+CONVERT(varchar(20),ewt.EWBegHour)+':'+CONVERT(varchar(20),ewt.EWBegMinute)+':00' as BegEwTiem,ewt.BranchCode,cp1.CompanyFullName as BranchName,ewt.WorkAreaCode,cp2.CompanyFullName as WorkAreaName,ewt.SiteCode,cp3.CompanyFullName as SiteName,ewt.ProjectId,MONTH(GETDATE()) as YjMonth,ewt.MenuCode,ewn.EWNodeCode,ewn.EWNodeName,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelCode,ewnp.PersonnelSource,ewnp.DeptId,ewnp.RoleId from TbFormEarlyWarningBegTime ewt 
left join TbFormEarlyWarningNode ewn on ewt.EarlyWarningCode=ewn.EarlyWarningCode and ewt.ProjectId=ewn.ProjectId and ewt.MenuCode=ewn.MenuCode
left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode and  ewn.MenuCode=ewnp.MenuCode and ewn.ProjectId=ewnp.ProjectId
left join TbCompany cp1 on ewt.BranchCode=cp1.CompanyCode
left join TbCompany cp2 on ewt.WorkAreaCode=cp2.CompanyCode
left join TbCompany cp3 on ewt.SiteCode=cp3.CompanyCode
where ewt.MenuCode='RawMonthDemandPlan') Tb 
left join (select EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId from TbFormEarlyWarningNodeInfo ewni
where ewni.EWFormDataCode=MONTH(GETDATE()) group by EWFormDataCode,ewni.EWNodeCode,ewni.WorkArea,ewni.EarlyWarningCode,ewni.MenuCode,ewni.ProjectId) TbYjInfo on Tb.EarlyWarningCode=TbYjInfo.EarlyWarningCode and Tb.EWNodeCode=TbYjInfo.EWNodeCode and Tb.MenuCode=TbYjInfo.MenuCode and  Tb.YjMonth=TbYjInfo.EWFormDataCode and Tb.WorkAreaCode=TbYjInfo.WorkArea and Tb.ProjectId=TbYjInfo.ProjectId
where GETDATE()>=BegEwTiem and Tb.WorkAreaCode not in(select rmdp.WorkAreaCode from TbRawMaterialMonthDemandPlan rmdp where MONTH(InsertTime)=MONTH(GETDATE())
group by rmdp.WorkAreaCode)) TbAll where TbAll.YjCode is null and TbAll.PersonnelCode is not null and GETDATE()>=TbAll.BegEwTiemNew	


-----------------------------------------------------------------------------
2019-12-17 18:13:02
Text:	select Tb.*,ewni.ID from (
                             --第一步预警（加工厂调度人员、工区工程部部长）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbQsCsYjUserOne.EarningType as EWNodeCode,TbQsCsYjUserOne.EWTimeType,TbQsCsYjUserOne.EWTime,TbQsCsYjUserOne.BegEwTime,TbQsCsYjUserOne.PersonnelSource,TbQsCsYjUserOne.PersonnelCode,TbQsCsYjUserOne.DistributionCode,TbQsCsYjUserOne.DischargeCargoCode,TbQsCsYjUserOne.SigninNuber,TbQsCsYjUserOne.ID,TbQsCsYjUserOne.BranchName,TbQsCsYjUserOne.WorkAreaName,TbQsCsYjUserOne.SiteCode,TbQsCsYjUserOne.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select sfs.ID,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,sdc.InsertTime  from TbSemiFinishedSign sfs
                             left join TbSiteDischargeCargo sdc on sfs.DischargeCargoCode=sdc.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)
                             union all
                             select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserCode as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs 
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             left join TbUserRole ur on ur.OrgId=cp2.CompanyCode 
                             left join TbDepartment dp on dp.DepartmentId=ur.DeptId and dp.DepartmentProjectId=sfs.ProjectId
                             left join TbRole r on r.DepartmentId=dp.DepartmentId and r.RoleId=ur.RoleCode 
                             where r.RoleName='部长'  and dp.DepartmentName='工程部' 
                             and sfs.SigninTime is null and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYjUserOne on TbQsCsYj.SigninNuber=TbQsCsYjUserOne.SigninNuber
                             where ewt.MenuCode='SemiFinishedSign' 
                             union all
                             --其他预警（从预警设置里面获取的用户）
                             select ewt.EarlyWarningCode,ewt.MenuCode,ewt.BranchCode,ewt.WorkAreaCode,ewt.ProjectId,TbYjSzUser.EWNodeCode,TbYjSzUser.EWTimeType,TbYjSzUser.EWTime,case when TbYjSzUser.EWTimeType='年' then DATEADD(YEAR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='月' then DATEADD(MONTH,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='天' then DATEADD(DAY,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='时' then DATEADD(HOUR,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) when TbYjSzUser.EWTimeType='分' then DATEADD(MINUTE,TbYjSzUser.EWTime,TbQsCsYj.BegEwTime) end as BegEwTime,TbYjSzUser.PersonnelSource,TbYjSzUser.PersonnelCode,TbQsCsYj.DistributionCode,TbQsCsYj.DischargeCargoCode,TbQsCsYj.SigninNuber,TbQsCsYj.ID,TbQsCsYj.BranchName,TbQsCsYj.WorkAreaName,TbQsCsYj.SiteCode,TbQsCsYj.SiteName from TbFormEarlyWarningBegTime ewt
                             left join (select ewn.EarlyWarningCode,ewn.MenuCode,ewn.ProjectId,ewn.EWNodeCode,ewn.EWTimeType,ewn.EWTime,ewnp.PersonnelSource,ewnp.PersonnelCode from TbFormEarlyWarningNode ewn
                             left join TbFormEarlyWarningNodePersonnel ewnp on ewn.EarlyWarningCode=ewnp.EarlyWarningCode and ewn.EWNodeCode=ewnp.EWNodeCode where ewnp.PersonnelCode is not null and ewn.MenuCode='SemiFinishedSign') TbYjSzUser on ewt.EarlyWarningCode=TbYjSzUser.EarlyWarningCode and ewt.MenuCode=TbYjSzUser.MenuCode and ewt.ProjectId=TbYjSzUser.ProjectId
                             left join (select sfs.ID,sfs.ProjectId,sfs.DistributionCode,sfs.DischargeCargoCode,sfs.SigninNuber,cp3.CompanyCode as BranchCode,cp3.CompanyFullName as BranchName,cp2.CompanyCode as WorkAreaCode,cp2.CompanyFullName as WorkAreaName,sfs.SiteCode,cp1.CompanyFullName as SiteName,'Personnel' as PersonnelSource,ur.UserId as PersonnelCode,sdc.InsertTime as BegEwTime,'1' EarningType,'时' as EWTimeType,12 as EWTime from TbSemiFinishedSign sfs
                             left join TbDistributionEnt disEnt on sfs.DistributionCode=disEnt.DistributionCode
                             left join TbSiteDischargeCargo sdc on sdc.DischargeCargoCode=sfs.DischargeCargoCode
                             left join TbUser ur on disEnt.InsertUserCode=ur.UserCode
                             left join TbCompany cp1 on sfs.SiteCode=cp1.CompanyCode
                             left join TbCompany cp2 on cp1.ParentCompanyCode=cp2.CompanyCode
                             left join TbCompany cp3 on cp2.ParentCompanyCode=cp3.CompanyCode
                             where sfs.SigninTime is null 
                             and GETDATE()>=DATEADD(HOUR,12,sdc.InsertTime)) TbQsCsYj on ewt.BranchCode=TbQsCsYj.BranchCode and ewt.WorkAreaCode=TbQsCsYj.WorkAreaCode
                             where ewt.MenuCode='SemiFinishedSign') Tb 
                             left join TbFormEarlyWarningNodeInfo ewni on Tb.EarlyWarningCode=ewni.EarlyWarningCode and Tb.EWNodeCode=ewni.EWNodeCode and Tb.ID=ewni.EWFormDataCode and Tb.ProjectId=ewni.ProjectId
                             where Tb.EWNodeCode is not null 
                             and Tb.PersonnelCode is not null 
                             and Tb.DistributionCode is not null
                             and GETDATE()>=Tb.BegEwTime and ewni.ID is null	


-----------------------------------------------------------------------------
